# éŸ³å£°ä¿å­˜ä¸å…·åˆ â€” æ·±æ˜ã‚Šåˆ†æãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ

> **å ±å‘Šæ—¥**: 2026-02-08  
> **å¯¾è±¡Issue**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å ±å‘Šãƒã‚°ï¼ˆã€ŒéŒ²éŸ³ã—ã¦ä¿å­˜ã—ãŸãŒã€å±¥æ­´ã§éŸ³å£°ãªã—ã¨è¡¨ç¤ºã•ã‚Œå†ç”Ÿã§ããªã„ã€ï¼‰  
> **åˆ†æè€…**: ReviewAAgent

---

## 1. ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

**éŒ²éŸ³ãƒšãƒ¼ã‚¸ã§éŸ³å£°ã‚’éŒ²éŸ³ã—ä¿å­˜ã—ã¦ã‚‚ã€å±¥æ­´ãƒšãƒ¼ã‚¸ã§ã€ŒéŸ³å£°ãªã—ã€ã¨è¡¨ç¤ºã•ã‚ŒéŸ³å£°ãŒå†ç”Ÿã§ããªã„ã€‚**  
åŸå› ã¯ **3å±¤** ã«æ¸¡ã‚‹è¤‡åˆçš„ãªå•é¡Œï¼š(1) Azure Blob Storage ã® CORS æœªè¨­å®šã€(2) API ã® `CreateRecordingRequest` ã« `audioUrl` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ãªã„ã€(3) `createRecording` ã§ `audioUrl` ã‚’ Cosmos DB ã«ä¿å­˜ã—ã¦ã„ãªã„ã€‚  
å½±éŸ¿ç¯„å›²: **å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® 100%** â€” éŸ³å£°ä¿å­˜æ©Ÿèƒ½ãŒå®Œå…¨ã«å‹•ä½œã—ã¦ã„ãªã„ã€‚  
ä¿®æ­£ã®ç·Šæ€¥åº¦: **ğŸ”´ Critical (P0)** â€” ã‚³ã‚¢æ©Ÿèƒ½ã®å®Œå…¨ãªéšœå®³ã€‚

---

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦³

### 2.1 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¾å­˜é–¢ä¿‚å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Browser (Next.js SPA)                     â”‚
â”‚                                                                  â”‚
â”‚  page.tsx (éŒ²éŸ³ãƒšãƒ¼ã‚¸)                                           â”‚
â”‚    â”œâ”€â”€ useAudioRecorder.ts   â† MediaRecorder API ã§éŒ²éŸ³          â”‚
â”‚    â”œâ”€â”€ useSpeechRecognition.ts â† Azure Speech SDK ã§æ–‡å­—èµ·ã“ã—   â”‚
â”‚    â”œâ”€â”€ useRecordingStateMachine.ts â† FSM ã§çŠ¶æ…‹ç®¡ç†              â”‚
â”‚    â””â”€â”€ handleSave()                                              â”‚
â”‚         â”œâ”€â”€ blobApi.uploadAudio() â”€â”€â†’ [1] GET /blob/upload-sas   â”‚
â”‚         â”‚                           â”€â”€â†’ [2] PUT to Blob Storage  â”‚ âŒ CORS blocked
â”‚         â””â”€â”€ recordingsApi.createRecording() â”€â”€â†’ POST /recordings â”‚
â”‚              â””â”€â”€ body.audioUrl â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                                                      â”‚           â”‚
â”‚  history/page.tsx (å±¥æ­´ãƒšãƒ¼ã‚¸)                       â”‚           â”‚
â”‚    â””â”€â”€ recording.audioUrl â†’ ã€ŒéŸ³å£°ãªã—ã€ãƒãƒƒã‚¸è¡¨ç¤º    â”‚           â”‚
â”‚                                                      â”‚           â”‚
â”‚  recording/page.tsx (è©³ç´°ãƒšãƒ¼ã‚¸)                     â”‚           â”‚
â”‚    â””â”€â”€ blobApi.getPlayableUrl() â†’ SASä»˜ãå†ç”Ÿ        â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Azure Functions API                â”‚           â”‚
â”‚                                                      â–¼           â”‚
â”‚  blob.ts                                                         â”‚
â”‚    â”œâ”€â”€ generateUploadSas  â†’ AZURE_STORAGE_CONNECTION_STRING âœ…   â”‚
â”‚    â””â”€â”€ generateDownloadSas â†’ AZURE_STORAGE_CONNECTION_STRING âœ…  â”‚
â”‚                                                                  â”‚
â”‚  recordings.ts                                                   â”‚
â”‚    â””â”€â”€ createRecording handler â†’ recordingService.createRecordingâ”‚
â”‚                                                                  â”‚
â”‚  recordingService.ts                                             â”‚
â”‚    â””â”€â”€ createRecording()                                         â”‚
â”‚         â””â”€â”€ Recording ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹ç¯‰ âŒ audioUrl ãŒå«ã¾ã‚Œãªã„  â”‚
â”‚                                                                  â”‚
â”‚  models/recording.ts                                             â”‚
â”‚    â””â”€â”€ CreateRecordingRequest âŒ audioUrl ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã—          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Azure Blob Storage (stairecorderdev / recordings)               â”‚
â”‚    â””â”€â”€ CORS âŒ æœªè¨­å®š â†’ ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã® PUT ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‹’å¦        â”‚
â”‚                                                                  â”‚
â”‚  Azure Cosmos DB (airecorder / recordings)                       â”‚
â”‚    â””â”€â”€ recording ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: audioUrl = undefined              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆç¾åœ¨ã®éšœå®³ãƒ•ãƒ­ãƒ¼ï¼‰

```
[éŒ²éŸ³] â†’ mediaRecorder.stop() â†’ audioBlob (OK) 
  â†’ handleSave()
    â†’ blobApi.getUploadSas("recording-xxx.webm") â†’ API â†’ SAS token (OK)
    â†’ fetch(fullUrl, { method: "PUT", body: audioBlob }) 
      â†’ âŒ CORS Error (Blob Storage ã« AllowedOrigins ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„)
      â†’ uploadResponse.success = false
      â†’ console.warn() ã®ã¿ â†’ audioUrl = undefined ã®ã¾ã¾ç¶šè¡Œ
    â†’ recordingsApi.createRecording({ ..., audioUrl: undefined })
      â†’ API: POST /recordings
        â†’ recordingService.createRecording(body)
          â†’ âŒ body.audioUrl ã‚’ recording ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å«ã‚ã¦ã„ãªã„
          â†’ Cosmos DB ã« audioUrl ãªã—ã§ä¿å­˜
  â†’ å±¥æ­´ãƒšãƒ¼ã‚¸ã§ã€ŒéŸ³å£°ãªã—ã€ãƒãƒƒã‚¸è¡¨ç¤º
```

### 2.3 çŠ¶æ…‹ç®¡ç†ã®æ§‹é€ 

| çŠ¶æ…‹ | ç®¡ç†å…ƒ | ç”¨é€” |
|------|--------|------|
| recordingState | useRecordingStateMachine (FSM) | éŒ²éŸ³ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ« |
| audioBlob | useAudioRecorder (React state) | éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ä¿æŒ |
| transcript | useSpeechRecognition (React state) | æ–‡å­—èµ·ã“ã—çµæœ |
| isSaving | page.tsx (local state) | ä¿å­˜ä¸­ãƒ•ãƒ©ã‚° |

---

## 3. é‡å¤§ãƒã‚°åˆ†æ ğŸ”´

### BUG-1: Azure Blob Storage CORS æœªè¨­å®š [Critical]

**å ´æ‰€**: Azure ã‚¤ãƒ³ãƒ•ãƒ©è¨­å®šï¼ˆ`stairecorderdev` ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰  
**ã‚³ãƒ¼ãƒ‰**: `web/src/services/blobApi.ts` L113-122

```typescript
// Upload using PUT with SAS token
const response = await fetch(fullUrl, {
  method: "PUT",
  headers: {
    "x-ms-blob-type": "BlockBlob",
    "Content-Type": audioBlob.type || "audio/webm",
  },
  body: audioBlob,
});
```

**å•é¡Œ**: ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ `stairecorderdev.blob.core.windows.net` ã¸ã® PUT ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ CORS ãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã€‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã« `AllowedOrigins` ãŒè¨­å®šã•ã‚Œã¦ã„ãªã‹ã£ãŸã€‚  
**å½±éŸ¿**: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éŸ³å£°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒ 100% å¤±æ•—ã™ã‚‹ã€‚  
**æ ¹æœ¬åŸå› **: Blob Storage ã®ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰æ™‚ã« CORS è¨­å®šãŒæ¼ã‚Œã¦ã„ãŸã€‚Azure Functions ã® CORS ã¯è¨­å®šæ¸ˆã¿ã ãŒã€Blob Storage ã¯åˆ¥ãƒªã‚½ãƒ¼ã‚¹ã§ã‚ã‚Šå€‹åˆ¥ã«è¨­å®šãŒå¿…è¦ã€‚  
**ä¿®æ­£æ–¹é‡**: âœ… **ä¿®æ­£æ¸ˆã¿** â€” `az storage cors add` ã§ä»¥ä¸‹ã‚’è¨­å®šï¼š
```
AllowedOrigins: https://proud-rock-06bba6200.2.azurestaticapps.net, http://localhost:3000
AllowedMethods: PUT, GET, HEAD, OPTIONS
AllowedHeaders: *
ExposedHeaders: *
MaxAgeInSeconds: 3600
```
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **æœ¬ãƒ¬ãƒãƒ¼ãƒˆä½œæˆä¸­ã«ä¿®æ­£å®Œäº†**

---

### BUG-2: `CreateRecordingRequest` ã« `audioUrl` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„ [Critical]

**å ´æ‰€**: `api/src/models/recording.ts` L48-56

```typescript
export interface CreateRecordingRequest {
  userId: string;
  title: string;
  sourceLanguage: string;
  duration: number;
  transcript?: Transcript;
  translations?: { [languageCode: string]: Translation };
  // âŒ audioUrl ãŒãªã„ï¼
}
```

**å•é¡Œ**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (`page.tsx` L308) ã¯ `audioUrl` ã‚’å«ã‚ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ãŒã€API å´ã®å‹å®šç¾©ã« `audioUrl` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€TypeScript ã®å‹ãƒ¬ãƒ™ãƒ«ã§ã¯å—ã‘å–ã‚Œãªã„ï¼ˆå®Ÿè¡Œæ™‚ã«ã¯ JSON ã¨ã—ã¦ã¯æ¸¡ã•ã‚Œã‚‹ï¼‰ã€‚  
**å½±éŸ¿**: API ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸ `audioUrl` ã‚’æ„å›³çš„ã«ç„¡è¦–ã™ã‚‹è¨­è¨ˆã«ãªã£ã¦ã„ã‚‹ã€‚  
**æ ¹æœ¬åŸå› **: `CreateRecordingRequest` ã®è¨­è¨ˆæ™‚ã«ã€éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå…ˆã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€ãã® URL ãŒä¿å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹ãƒ•ãƒ­ãƒ¼ãŒæƒ³å®šã•ã‚Œã¦ã„ãªã‹ã£ãŸã€‚`saveRecordingWithAudio` ã¨ã„ã†åˆ¥é–¢æ•°ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãŒã€ã“ã‚Œã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ãƒ­ãƒ¼ã§ã‚ã‚Šã€ç¾åœ¨ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ã¨æ•´åˆã—ãªã„ã€‚  
**ä¿®æ­£æ–¹é‡**:
```typescript
export interface CreateRecordingRequest {
  userId: string;
  title: string;
  sourceLanguage: string;
  duration: number;
  audioUrl?: string;        // â† è¿½åŠ 
  transcript?: Transcript;
  translations?: { [languageCode: string]: Translation };
}
```

---

### BUG-3: `createRecording` ã§ `audioUrl` ã‚’ Cosmos DB ã«ä¿å­˜ã—ã¦ã„ãªã„ [Critical]

**å ´æ‰€**: `api/src/services/recordingService.ts` L16-36

```typescript
export async function createRecording(
  request: CreateRecordingRequest
): Promise<Recording> {
  const container = await getRecordingsContainer();

  const now = new Date().toISOString();
  const recording: Recording = {
    id: uuidv4(),
    userId: request.userId,
    title: request.title,
    sourceLanguage: request.sourceLanguage,
    duration: request.duration,
    transcript: request.transcript,
    translations: request.translations,
    createdAt: now,
    updatedAt: now,
    status: "completed",
    // âŒ audioUrl ãŒãªã„ï¼request.audioUrl ãŒå­˜åœ¨ã—ã¦ã‚‚ç„¡è¦–ã•ã‚Œã‚‹
  };

  const { resource } = await container.items.create(recording);
  return resource as Recording;
}
```

**å•é¡Œ**: BUG-2 ãŒä¿®æ­£ã•ã‚Œã¦ã‚‚ã€`createRecording` é–¢æ•°ãŒ `request.audioUrl` ã‚’ `recording` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å«ã‚ãªã„ãŸã‚ã€Cosmos DB ã« `audioUrl` ãŒä¿å­˜ã•ã‚Œãªã„ã€‚  
**å½±éŸ¿**: BUG-1 ãŒä¿®æ­£ã•ã‚Œã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è‡ªä½“ãŒæˆåŠŸã—ã¦ã‚‚ã€audioUrl ãŒ DB ã«ä¿å­˜ã•ã‚Œãªã„ãŸã‚ä¾ç„¶ã¨ã—ã¦ã€ŒéŸ³å£°ãªã—ã€ã«ãªã‚‹ã€‚  
**æ ¹æœ¬åŸå› **: `createRecording` ã¯ `audioUrl` ã‚’ä½¿ã‚ãš `audioBlobName` ã‚’ä½¿ã†è¨­è¨ˆï¼ˆ`saveRecordingWithAudio` ã‚’å‚ç…§ï¼‰ã ã£ãŸãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ã§ã¯ `audioUrl` ãŒç›´æ¥æ¸¡ã•ã‚Œã‚‹ã€‚  
**ä¿®æ­£æ–¹é‡**:
```typescript
const recording: Recording = {
  id: uuidv4(),
  userId: request.userId,
  title: request.title,
  sourceLanguage: request.sourceLanguage,
  duration: request.duration,
  audioUrl: request.audioUrl,  // â† è¿½åŠ 
  transcript: request.transcript,
  translations: request.translations,
  createdAt: now,
  updatedAt: now,
  status: "completed",
};
```

---

### BUG-4: `handleSave` ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãŒæ¡ã‚Šæ½°ã•ã‚Œã‚‹ [High]

**å ´æ‰€**: `web/src/app/page.tsx` L293-298

```typescript
if (uploadResponse.success && uploadResponse.data) {
  audioUrl = uploadResponse.data.blobUrl;
} else {
  console.warn("[Save] Audio upload failed, continuing without audio URL:", uploadResponse.error);
}
```

**å•é¡Œ**: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå¤±æ•—ã—ã¦ã‚‚ `console.warn` ã®ã¿ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã›ãšã€audioUrl ãªã—ã§ä¿å­˜ã‚’ç¶šè¡Œã™ã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä¿å­˜ãŒæˆåŠŸã—ãŸã¨èªè­˜ã™ã‚‹ãŒã€å®Ÿéš›ã«ã¯éŸ³å£°ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¦ã„ã‚‹ã€‚  
**å½±éŸ¿**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒéŸ³å£°ãªã—ä¿å­˜ã«æ°—ã¥ã‹ãšã€å¾Œã‹ã‚‰å†ç”Ÿã—ã‚ˆã†ã¨ã—ã¦ã€ŒéŸ³å£°ãªã—ã€ã«é­é‡ã™ã‚‹ã€‚  
**æ ¹æœ¬åŸå› **: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒã€Œå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œã€ã®æ–¹é‡ã§å®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥ãŒæ¬ è½ã€‚  
**ä¿®æ­£æ–¹é‡**: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã€éŸ³å£°ãªã—ã§ä¿å­˜ã™ã‚‹ã‹ã€å†è©¦è¡Œã™ã‚‹ã‹ã‚’é¸æŠã•ã›ã‚‹ï¼š
```typescript
if (uploadResponse.success && uploadResponse.data) {
  audioUrl = uploadResponse.data.blobUrl;
} else {
  const continueWithout = confirm(
    `éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n` +
    `ã‚¨ãƒ©ãƒ¼: ${uploadResponse.error}\n\n` +
    `éŸ³å£°ãªã—ã§ä¿å­˜ã‚’ç¶šã‘ã¾ã™ã‹ï¼Ÿ\n` +
    `ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚’æŠ¼ã™ã¨ä¿å­˜ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚`
  );
  if (!continueWithout) {
    setIsSaving(false);
    return;
  }
}
```

---

## 4. è¨­è¨ˆä¸Šã®å•é¡Œ ğŸŸ¡

### DESIGN-1: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨ã‚µãƒ¼ãƒãƒ¼å´ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®è¨­è¨ˆä¸æ•´åˆ [Medium]

**å ´æ‰€**: 
- `web/src/services/blobApi.ts` (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)
- `api/src/services/recordingService.ts` L148-186 (`saveRecordingWithAudio` â€” ã‚µãƒ¼ãƒãƒ¼å´ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)
- `api/src/services/blobService.ts` (ã‚µãƒ¼ãƒãƒ¼å´ Blob æ“ä½œ)

**å•é¡Œ**: 2ã¤ã®ç•°ãªã‚‹ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‘ã‚¹ãŒå­˜åœ¨ã™ã‚‹ï¼š
1. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´**: `blobApi.uploadAudio()` â†’ SAS ã§ç›´æ¥ PUT â†’ `audioUrl` ã‚’ `createRecording` ã«æ¸¡ã™
2. **ã‚µãƒ¼ãƒãƒ¼å´**: `saveRecordingWithAudio()` â†’ Buffer ã‚’å—ã‘å–ã‚Šã‚µãƒ¼ãƒãƒ¼ã§ PUT â†’ `audioBlobName` ã‚’ä¿å­˜

ç¾åœ¨ã¯ (1) ã®ã¿ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŒã€API å´ã¯ (2) ã®è¨­è¨ˆã‚’å‰æã¨ã—ã¦ã„ã‚‹ãŸã‚ã€`createRecording` ãŒ `audioUrl` ã‚’å—ã‘å–ã‚‰ãªã„ã€‚`blobService.ts` ã® `generateSasUrl` ã‚‚ TODO çŠ¶æ…‹ï¼ˆSAS ãªã—ã®ç”Ÿ URL ã‚’è¿”ã™ï¼‰ã€‚

**æ”¹å–„æ¡ˆ**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«çµ±ä¸€ã—ã€`saveRecordingWithAudio` ã¨ `blobService.ts` ã®ã‚µãƒ¼ãƒãƒ¼å´ãƒ­ã‚¸ãƒƒã‚¯ã¯å°†æ¥ã®å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œæ™‚ã¾ã§å‡çµã™ã‚‹ã€‚

---

### DESIGN-2: `blobService.ts` ã®ç’°å¢ƒå¤‰æ•°åä¸æ•´åˆ [Low]

**å ´æ‰€**: 
- `api/src/services/blobService.ts` L10: `BLOB_CONNECTION_STRING`
- `api/src/functions/blob.ts` L58: `AZURE_STORAGE_CONNECTION_STRING`

**å•é¡Œ**: åŒã˜ Blob Storage ã¸ã®æ¥ç¶šã«ç•°ãªã‚‹ç’°å¢ƒå¤‰æ•°åãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã€‚  
**æ”¹å–„æ¡ˆ**: `AZURE_STORAGE_CONNECTION_STRING` ã«çµ±ä¸€ã™ã‚‹ã€‚

---

### DESIGN-3: é‡è¤‡ã™ã‚‹ fetchRecordings ãƒ­ã‚¸ãƒƒã‚¯ [Low]

**å ´æ‰€**: `web/src/app/history/page.tsx` L97-127 (useEffect) ã¨ L129-152 (fetchRecordings callback)

**å•é¡Œ**: ã»ã¼åŒä¸€ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ãŒ2ç®‡æ‰€ã«å­˜åœ¨ã™ã‚‹ã€‚  
**æ”¹å–„æ¡ˆ**: `fetchRecordings` callback ã®ã¿ã‚’ä½¿ã„ã€`useEffect` ã‹ã‚‰å‘¼ã³å‡ºã™å½¢ã«çµ±ä¸€ã€‚

---

### DESIGN-4: `blobService.ts` ã® `generateSasUrl` ãŒ TODO çŠ¶æ…‹ [Medium]

**å ´æ‰€**: `api/src/services/blobService.ts` L67-76

```typescript
export async function generateSasUrl(
  blobName: string,
  expiresInMinutes: number = 60
): Promise<string> {
  // For production, you should use proper SAS token generation
  // This is a simplified version that returns the direct URL
  return blockBlobClient.url;  // SAS ãªã—ã®ç”Ÿ URL
}
```

**å•é¡Œ**: `getRecording` (recordingService.ts L50) ã§ `audioBlobName` ã‹ã‚‰ã® SAS URL ç”Ÿæˆã«ä½¿ç”¨ã•ã‚Œã‚‹ãŒã€å®Ÿéš›ã«ã¯ SAS ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»˜ä¸ã—ã¦ã„ãªã„ã€‚ãŸã ã—ã€ç¾åœ¨ã®ãƒ•ãƒ­ãƒ¼ã§ã¯ `audioUrl` ãŒç›´æ¥ä¿å­˜ã•ã‚Œã‚‹ãŸã‚ã€ã“ã®é–¢æ•°ã¯ä½¿ã‚ã‚Œãªã„ã€‚  
**æ”¹å–„æ¡ˆ**: ä½¿ç”¨ã•ã‚Œãªã„ã“ã¨ã‚’æ˜ç¢ºã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã‹ã€`blob.ts` ã® `generateDownloadSas` ã¨çµ±åˆã™ã‚‹ã€‚

---

## 5. ä¾å­˜é–¢ä¿‚ãƒãƒˆãƒªã‚¯ã‚¹ ğŸ“Š

### 5.1 ãƒã‚°é–“ã®ä¾å­˜é–¢ä¿‚

```
BUG-1 (CORS) â”€â”€â†’ BUG-4 (ã‚¨ãƒ©ãƒ¼æ¡ã‚Šæ½°ã—) [å› æœé–¢ä¿‚]
  â”‚                 â”‚
  â”‚                 â””â”€â”€ CORS ã‚¨ãƒ©ãƒ¼ã§ uploadAudio() ãŒå¤±æ•— â†’ console.warn ã®ã¿
  â”‚
  â”œâ”€â”€ BUG-2 (å‹å®šç¾©æ¬ è½) â”€â”€â†’ BUG-3 (DBä¿å­˜æ¬ è½) [æ§‹é€ çš„ä¾å­˜]
  â”‚     â”‚
  â”‚     â””â”€â”€ audioUrl ã‚’å—ã‘å–ã‚Œãªã„ â†’ ä¿å­˜ã‚‚ã§ããªã„
  â”‚
  â””â”€â”€ 3ã¤å…¨ã¦ä¿®æ­£ã—ãªã„ã¨éŸ³å£°ä¿å­˜ã¯å‹•ä½œã—ãªã„
```

**çµè«–**: BUG-1 + BUG-2 + BUG-3 ã® **å…¨ã¦** ã‚’ä¿®æ­£ã—ãªã„ã¨ã€éŸ³å£°ä¿å­˜æ©Ÿèƒ½ã¯å‹•ä½œã—ãªã„ã€‚

### 5.2 æŠ€è¡“çš„ä¾å­˜é–¢ä¿‚

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ä¾å­˜å…ˆ | ãƒªã‚¹ã‚¯ | å¯¾ç­– |
|---------------|--------|--------|------|
| blobApi.uploadAudio() | Blob Storage CORS | CORS æœªè¨­å®šã§å…¨å¤±æ•— | âœ… CORS è¨­å®šæ¸ˆã¿ |
| createRecording API | CreateRecordingRequest å‹ | audioUrl æ¬ è½ã§ä¿å­˜ä¸å¯ | å‹ã«è¿½åŠ  |
| recordingService.createRecording | request ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | audioUrl æœªå±•é–‹ | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ  |
| history/page.tsx | recording.audioUrl | undefined ã§ã€ŒéŸ³å£°ãªã—ã€è¡¨ç¤º | ä¸Šæµä¿®æ­£ã§è§£æ±º |

### 5.3 ä»– Issue ã¨ã®ç›¸äº’ä½œç”¨

| Issue | å½±éŸ¿ |
|-------|------|
| Issue #2 (éŒ²éŸ³æ“ä½œ) | âœ… PR #18 ã§ä¿®æ­£æ¸ˆã¿ã€‚æœ¬ãƒã‚°ã¨ã¯ç‹¬ç«‹ã€‚ |
| Issue #5 (éŸ³å£°å†ç”Ÿ) | PR #19 ã§ SAS URL å¯¾å¿œæ¸ˆã¿ã€‚æœ¬ãƒã‚°ãŒè§£æ±ºã™ã‚Œã° Issue #5 ã‚‚å®Œå…¨è§£æ±ºã€‚ |
| Issue #3 (P1) | éŒ²éŸ³ä¿å­˜ã®å‰ææ©Ÿèƒ½ãŒå£Šã‚Œã¦ã„ã‚‹ãŸã‚ã€æœ¬ãƒã‚°ã®ä¿®æ­£ãŒå…ˆã€‚ |
| Issue #4 (P0) | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã€‚æœ¬ãƒã‚°ã¨ã¯ç‹¬ç«‹ã ãŒã€åŒã˜å„ªå…ˆåº¦ã€‚ |

---

## 6. ãƒ–ãƒ©ã‚¦ã‚¶ / ç’°å¢ƒäº’æ›æ€§ãƒªã‚¹ã‚¯

| ç’°å¢ƒ | å¯¾å¿œçŠ¶æ³ | ãƒªã‚¹ã‚¯ |
|------|---------|--------|
| Chrome 120+ | MediaRecorder: audio/webm;codecs=opus âœ… | ä½ |
| Firefox 120+ | MediaRecorder: audio/webm âœ… | ä½ |
| Safari 17+ | MediaRecorder: audio/mp4 âœ… (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯) | ä¸­: CORS preflight ã®æŒ™å‹•ãŒç•°ãªã‚‹å ´åˆã‚ã‚Š |
| iOS Safari | MediaRecorder: audio/mp4 âš ï¸ | ä¸­: getUserMedia ã®åˆ¶é™ã‚ã‚Š |
| Edge | Chrome ã¨åŒç­‰ âœ… | ä½ |

**CORS é–¢é€£**: Blob Storage ã¸ã® PUT preflight (OPTIONS) ãŒå…¨ãƒ–ãƒ©ã‚¦ã‚¶ã§æ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿ï¼ˆ`AllowedMethods: PUT, GET, HEAD, OPTIONS`ï¼‰ã€‚

---

## 7. ä¿®æ­£ææ¡ˆï¼ˆå„ªå…ˆé †ä½ä»˜ãï¼‰

### Phase 1: è‡´å‘½çš„ãƒã‚°ä¿®æ­£ï¼ˆP0ï¼‰ â€” å³æ™‚å¯¾å¿œ

#### Fix 1-1: Blob Storage CORS è¨­å®š âœ… å®Œäº†

```bash
az storage cors add \
  --account-name stairecorderdev \
  --services b \
  --methods "PUT GET HEAD OPTIONS" \
  --origins "https://proud-rock-06bba6200.2.azurestaticapps.net" "http://localhost:3000" \
  --allowed-headers "*" \
  --exposed-headers "*" \
  --max-age 3600
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æœ¬ãƒ¬ãƒãƒ¼ãƒˆä½œæˆä¸­ã«é©ç”¨æ¸ˆã¿

#### Fix 1-2: `CreateRecordingRequest` ã« `audioUrl` è¿½åŠ 

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**: `api/src/models/recording.ts`

```typescript
export interface CreateRecordingRequest {
  userId: string;
  title: string;
  sourceLanguage: string;
  duration: number;
  audioUrl?: string;        // â† è¿½åŠ 
  transcript?: Transcript;
  translations?: { [languageCode: string]: Translation };
}
```

#### Fix 1-3: `createRecording` ã§ `audioUrl` ã‚’ Cosmos DB ã«ä¿å­˜

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**: `api/src/services/recordingService.ts`

```typescript
const recording: Recording = {
  id: uuidv4(),
  userId: request.userId,
  title: request.title,
  sourceLanguage: request.sourceLanguage,
  duration: request.duration,
  audioUrl: request.audioUrl,  // â† è¿½åŠ 
  transcript: request.transcript,
  translations: request.translations,
  createdAt: now,
  updatedAt: now,
  status: "completed",
};
```

### Phase 2: è¨­è¨ˆæ”¹å–„ï¼ˆP1ï¼‰

#### Fix 2-1: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—æ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**: `web/src/app/page.tsx` L293-298

```typescript
if (uploadResponse.success && uploadResponse.data) {
  audioUrl = uploadResponse.data.blobUrl;
} else {
  const continueWithout = confirm(
    `éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n` +
    `ã‚¨ãƒ©ãƒ¼: ${uploadResponse.error}\n\n` +
    `éŸ³å£°ãªã—ã§ä¿å­˜ã‚’ç¶šã‘ã¾ã™ã‹ï¼Ÿ`
  );
  if (!continueWithout) {
    setIsSaving(false);
    return;
  }
}
```

### Phase 3: å …ç‰¢æ€§å¼·åŒ–ï¼ˆP2ï¼‰

#### Fix 3-1: ç’°å¢ƒå¤‰æ•°åã®çµ±ä¸€

`blobService.ts` ã® `BLOB_CONNECTION_STRING` â†’ `AZURE_STORAGE_CONNECTION_STRING` ã«çµ±ä¸€ã€‚

#### Fix 3-2: history/page.tsx ã®é‡è¤‡ãƒ­ã‚¸ãƒƒã‚¯è§£æ¶ˆ

```typescript
const fetchRecordings = useCallback(async () => { ... }, [searchQuery]);
useEffect(() => { fetchRecordings(); }, [fetchRecordings]);
```

---

## 8. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### çŠ¶æ…‹é·ç§»ãƒ†ã‚¹ãƒˆï¼ˆUnitï¼‰

| ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æœŸå¾…çµæœ |
|-------------|---------|
| audioBlob ã‚ã‚Š + upload æˆåŠŸ | audioUrl ãŒ Cosmos DB ã«ä¿å­˜ã•ã‚Œã‚‹ |
| audioBlob ã‚ã‚Š + upload å¤±æ•— (CORS) | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º |
| audioBlob ãªã—ï¼ˆéŒ²éŸ³ãªã—ï¼‰ | audioUrl = undefined ã§ä¿å­˜ï¼ˆæ­£å¸¸ç³»ï¼‰ |
| audioBlob ã‚ã‚Š + upload æˆåŠŸ + API ä¿å­˜å¤±æ•— | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º |

### çµ±åˆãƒ†ã‚¹ãƒˆ

| ã‚·ãƒŠãƒªã‚ª | æ‰‹é † | æœŸå¾…çµæœ |
|---------|------|---------|
| æ­£å¸¸ãªéŒ²éŸ³ä¿å­˜ | éŒ²éŸ³ â†’ åœæ­¢ â†’ ä¿å­˜ â†’ å±¥æ­´ç¢ºèª | â–¶ å†ç”Ÿãƒœã‚¿ãƒ³è¡¨ç¤ºã€å†ç”Ÿå¯èƒ½ |
| å±¥æ­´ã‹ã‚‰ã®å†ç”Ÿ | å±¥æ­´ â†’ â–¶ ã‚¯ãƒªãƒƒã‚¯ | SAS ä»˜ã URL ã§åˆ¥ã‚¿ãƒ–å†ç”Ÿ |
| è©³ç´°ãƒšãƒ¼ã‚¸ã®å†ç”Ÿ | å±¥æ­´ â†’ ã‚¿ã‚¤ãƒˆãƒ«ã‚¯ãƒªãƒƒã‚¯ â†’ audio è¦ç´  | ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å†ç”Ÿå¯èƒ½ |
| ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ | å±¥æ­´ â†’ DL ãƒœã‚¿ãƒ³ | .webm ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ |

### æ‰‹å‹•ãƒ†ã‚¹ãƒˆ: ãƒ–ãƒ©ã‚¦ã‚¶åˆ¥ãƒãƒˆãƒªã‚¯ã‚¹

| ãƒ–ãƒ©ã‚¦ã‚¶ | éŒ²éŸ³ | ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ | å†ç”Ÿ | DL |
|---------|------|-------------|------|-----|
| Chrome | â¬œ | â¬œ | â¬œ | â¬œ |
| Firefox | â¬œ | â¬œ | â¬œ | â¬œ |
| Safari | â¬œ | â¬œ | â¬œ | â¬œ |
| Edge | â¬œ | â¬œ | â¬œ | â¬œ |

---

## 9. å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

| Step | ä½œæ¥­å†…å®¹ | è¦‹ç©ã‚Š | å½±éŸ¿ç¯„å›² |
|------|---------|--------|---------|
| 1 | âœ… Blob Storage CORS è¨­å®š | å®Œäº† | ã‚¤ãƒ³ãƒ•ãƒ© |
| 2 | `CreateRecordingRequest` ã« `audioUrl` è¿½åŠ  | 5åˆ† | API å‹å®šç¾© |
| 3 | `createRecording` ã§ `audioUrl` ã‚’ä¿å­˜ | 5åˆ† | API ã‚µãƒ¼ãƒ“ã‚¹å±¤ |
| 4 | Azure Functions å†ãƒ‡ãƒ—ãƒ­ã‚¤ | 5åˆ† | API |
| 5 | `handleSave` ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„ | 10åˆ† | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ |
| 6 | Web å†ãƒ‡ãƒ—ãƒ­ã‚¤ | 5åˆ† | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ |
| 7 | E2E ãƒ†ã‚¹ãƒˆï¼ˆæ‰‹å‹•ï¼‰ | 15åˆ† | å…¨ä½“ |

**åˆè¨ˆè¦‹ç©ã‚Š**: ç´„45åˆ†ï¼ˆCORS ä¿®æ­£æ¸ˆã¿ã®ãŸã‚çŸ­ç¸®ï¼‰

---

## 10. ãƒªã‚¹ã‚¯ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆ

| ãƒªã‚¹ã‚¯ | ç¢ºç‡ | å½±éŸ¿åº¦ | å¯¾ç­– |
|--------|------|--------|------|
| CORS è¨­å®šå¾Œã‚‚ Safari ã§ preflight å¤±æ•— | ä½ | ä¸­ | Safari ã§ã®ãƒ†ã‚¹ãƒˆå®Ÿæ–½ |
| æ—¢å­˜éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã« audioUrl ã‚’å¾Œä»˜ã‘ä¸å¯ | ç¢ºå®Ÿ | ä½ | æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯éŸ³å£°ãªã—ã®ã¾ã¾ï¼ˆå†éŒ²éŸ³ã§å¯¾å¿œï¼‰ |
| Blob Storage ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã—ãªã„ | ä½ | é«˜ | blob.ts ã® `listBlobs` ã§ `createIfNotExists` ã‚ã‚Š |
| SAS ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œ | ä¸­ | ä½ | å†ç”Ÿæ™‚ã«æ¯å›æ–°è¦ SAS å–å¾—ï¼ˆæ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼‰ |
| å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | ä½ | ä¸­ | 30åˆ† SAS æœ‰åŠ¹æœŸé™ã§ååˆ† |

---

## 11. çµè«–

### æœ€å¤§ã®å•é¡Œç‚¹

**3å±¤ã®è¤‡åˆçš„ãªéšœå®³** ã«ã‚ˆã‚Šã€éŸ³å£°ä¿å­˜æ©Ÿèƒ½ãŒå®Œå…¨ã«å‹•ä½œã—ã¦ã„ãªã‹ã£ãŸï¼š
1. âœ… Blob Storage CORS æœªè¨­å®šï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰
2. ğŸ”´ API å‹å®šç¾©ã« `audioUrl` ãŒãªã„ï¼ˆè¦ä¿®æ­£ï¼‰
3. ğŸ”´ DB ä¿å­˜æ™‚ã« `audioUrl` ã‚’å«ã‚ã¦ã„ãªã„ï¼ˆè¦ä¿®æ­£ï¼‰

### æ¨å¥¨ã™ã‚‹ä¿®æ­£é †åº

1. **`api/src/models/recording.ts`** â€” `CreateRecordingRequest` ã« `audioUrl` è¿½åŠ 
2. **`api/src/services/recordingService.ts`** â€” `createRecording` ã§ `audioUrl` ã‚’ä¿å­˜
3. **Azure Functions å†ãƒ‡ãƒ—ãƒ­ã‚¤**
4. **`web/src/app/page.tsx`** â€” ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„ï¼ˆP1ã€å¾Œå›ã—å¯ï¼‰
5. **E2E ãƒ†ã‚¹ãƒˆ**

### ä»– Issue ã¸ã®å½±éŸ¿

- **Issue #5**: æœ¬ãƒã‚°ä¿®æ­£ã§å®Œå…¨è§£æ±ºï¼ˆSAS URL ã¯ PR #19 ã§å¯¾å¿œæ¸ˆã¿ï¼‰
- **ä»–ã® Issue**: ç‹¬ç«‹ã—ã¦ãŠã‚Šå½±éŸ¿ãªã—

### åˆ¤å®š: `CONDITIONAL GO`

BUG-1 ã¯ä¿®æ­£æ¸ˆã¿ã€‚BUG-2 + BUG-3 ã® API å´ä¿®æ­£ï¼ˆåˆè¨ˆ2è¡Œè¿½åŠ ï¼‰ã‚’è¡Œã„ã€å†ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚Œã° **GO** ã¨ãªã‚‹ã€‚

---

## âœ… è‰¯ã„è¨­è¨ˆåˆ¤æ–­

- âœ… **FSM ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ç®¡ç†** (useRecordingStateMachine): boolean åœ°ç„ã‚’æ ¹æœ¬è§£æ±º
- âœ… **Ref ãƒ™ãƒ¼ã‚¹ã®ã‚¬ãƒ¼ãƒ‰** (useAudioRecorder): stale closure ã‚’é˜²æ­¢
- âœ… **SAS ãƒˆãƒ¼ã‚¯ãƒ³æ–¹å¼**: Private Blob Storage + éƒ½åº¦ SAS ç”Ÿæˆã¯æ­£ã—ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ
- âœ… **MIME ã‚¿ã‚¤ãƒ—ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: webm â†’ mp4 â†’ wav ã®æ®µéšçš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- âœ… **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**: SAS ã‚’ä½¿ã£ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç›´æ¥ PUT ã¯å¤§å®¹é‡å¯¾å¿œã®æ­£ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³
- âœ… **console.log ã®åŸ‹ã‚è¾¼ã¿**: `[Save]` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ã„
