# Issue #42 議事録生成のフォーマット品質改善 - 実装計画書

## 1. 概要

### 目的
現在の議事録出力が抽象的で詳細が不足しているため、より構造化された詳細な議事録フォーマットを実現する。

### 現状の問題点

**現在のJSON出力構造**:
```json
{
  "overview": "概要（2-3文）",
  "keyPoints": ["ポイント1", "ポイント2", ...],
  "actionItems": [{ "description", "assignee", "dueDate" }]
}
```

**問題点**:
1. **概要が抽象的** - 会議の具体的な内容が伝わらない
2. **議題ごとの詳細がない** - 複数の議題を議論しても1つの概要にまとめられる
3. **背景・問題意識がない** - なぜその議論が行われたか不明
4. **参加者情報がない** - 誰が参加したか記録されない
5. **決定事項とアクションアイテムが混在** - 決まったことと、やるべきことが区別されない

### 理想の出力フォーマット

```json
{
  "meetingInfo": {
    "title": "会議名（推測）",
    "participants": ["話者1", "話者2"],
    "themes": ["テーマ1", "テーマ2"]
  },
  "agendaItems": [
    {
      "title": "議題タイトル",
      "background": "背景・問題意識",
      "discussion": "議論内容の要約",
      "keyPoints": ["ポイント1", "ポイント2"],
      "concerns": ["懸念事項"],
      "nextSteps": "次のアクションの方向性"
    }
  ],
  "decisions": ["決定事項1", "決定事項2"],
  "actionItems": [
    {
      "category": "カテゴリ",
      "description": "内容",
      "assignee": "担当者",
      "dueDate": "期限"
    }
  ],
  "overview": "全体の概要"
}
```

## 2. 技術的アプローチ

### 2.1 段階的改善アプローチ

**Phase 1**: プロンプト改善のみ（型変更なし）
- 現在のJSON構造を維持しながら、プロンプトを改善
- `overview` と `keyPoints` の内容を充実させる

**Phase 2**: 出力構造の拡張
- 新しいJSON構造を定義
- 後方互換性を維持しながら拡張

### 2.2 推奨: Phase 1 から開始

理由:
- 型変更は影響範囲が大きい（フロントエンド表示、DB保存、履歴表示）
- プロンプト改善だけで大幅な品質向上が見込める
- 段階的に検証できる

## 3. Phase 1: プロンプト改善

### 3.1 改善後のJSON_FORMAT

```typescript
const JSON_FORMAT_V2 = `出力は必ず以下のJSON形式で返してください：
{
  "overview": "会議の詳細な概要。以下を含めること：
    - 会議の目的・背景
    - 主な議題（複数ある場合は箇条書き形式で）
    - 重要な結論・決定事項の要約
    - 参加者の主な立場・役割（推測可能な場合）
    300-500字程度で具体的に記述",
  "keyPoints": [
    "【議題1】背景: xxx / 議論: xxx / 結論: xxx",
    "【議題2】背景: xxx / 議論: xxx / 結論: xxx",
    "【決定事項】決定された内容を明記",
    "【懸念事項】挙げられた懸念・リスク",
    ...
  ],
  "actionItems": [
    {
      "id": "1",
      "description": "【カテゴリ】具体的なタスク内容",
      "assignee": "担当者名（文字起こしから特定できる場合）",
      "dueDate": "期限（YYYY-MM-DD形式、言及があれば）"
    }
  ]
}

重要な指示：
- overviewは単なる要約ではなく、会議に参加していなかった人が読んでも内容を理解できるレベルの詳細さで記述
- keyPointsは議題ごとに「背景→議論→結論」の流れで構造化
- 決定事項は「【決定事項】」プレフィックスを付けて明確に区別
- 話者の発言は「〇〇さんは〜と述べた」のように誰の発言か明記
- 担当者や期限が明確でない場合はnullにしてください
- 必ず有効なJSONを返してください`;
```

### 3.2 テンプレート別の追加指示

#### general（汎用）
```typescript
const GENERAL_ADDITIONS = `
追加指示：
- 会議の種類を推測し、適切な構成で要約してください
- 議題が複数ある場合は、keyPointsを議題ごとにグルーピング
- 参加者の役割（主導者、質問者、決定者など）を推測して記述
- 未解決の課題や持ち越し事項も明記`;
```

#### regular（定例会議）
```typescript
const REGULAR_ADDITIONS = `
追加指示：
- 報告事項は「【報告】担当者: 内容」形式で記述
- 前回からの進捗と今回の課題を区別
- 次回までの宿題を明確にアクションアイテム化
- 定期的なトピック（KPI、進捗、課題）があればそれぞれセクション化`;
```

#### one-on-one（1on1）
```typescript
const ONE_ON_ONE_ADDITIONS = `
追加指示：
- 相談事項のカテゴリ（業務/キャリア/人間関係/その他）を明記
- 上司/メンターからのフィードバックを「【FB】」プレフィックスで強調
- 合意事項と検討中事項を区別
- 次回フォローアップすべき点を明記`;
```

### 3.3 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `api/src/functions/summary.ts` | `JSON_FORMAT` と各テンプレートのプロンプトを改善 |
| `web/src/lib/meetingTemplates.ts` | フロントエンド側のテンプレート定義を同期（カスタムテンプレート用） |

## 4. 実装詳細

### 4.1 api/src/functions/summary.ts の変更

```typescript
// ─── 改善版 JSON出力フォーマット ───
const JSON_FORMAT = `出力は必ず以下のJSON形式で返してください：
{
  "overview": "会議の詳細な概要（300-500字）。以下を必ず含める：
    ・会議の目的と背景
    ・参加者の役割（推測可能な場合）
    ・議論された主な議題の一覧
    ・最終的な結論・決定事項の要約",
  "keyPoints": [
    "【議題1: タイトル】背景: ... / 議論: ... / 結論: ...",
    "【議題2: タイトル】背景: ... / 議論: ... / 結論: ...",
    "【決定事項】...",
    "【懸念・リスク】...",
    "【持ち越し事項】..."
  ],
  "actionItems": [
    {
      "id": "1",
      "description": "【カテゴリ】具体的なタスク内容（誰が何をするか明確に）",
      "assignee": "担当者名",
      "dueDate": "YYYY-MM-DD"
    }
  ]
}

構造化の指示：
1. keyPointsは議題ごとに「背景→議論→結論」の3段階で整理
2. 【決定事項】【懸念・リスク】【持ち越し事項】は個別のkeyPointとして追加
3. 話者の発言は「〇〇さんは〜と述べた」形式で記録
4. actionItemsは以下のカテゴリで分類:
   - 【フォローアップ】確認・調査タスク
   - 【作成・準備】資料作成・準備タスク
   - 【連絡・調整】コミュニケーションタスク
   - 【実施】実行タスク
5. 担当者や期限が不明な場合はnull
6. 必ず有効なJSONで出力`;

// ─── 各テンプレートのシステムプロンプト（改善版）───
const TEMPLATE_PROMPTS: Record<string, string> = {
  general: `あなたは会議の議事録を作成する専門家です。
与えられた文字起こしテキストから、会議に参加していなかった人でも内容を理解できる詳細な議事録を作成してください。

${JSON_FORMAT}

一般会議の議事録作成指示：
- 複数の議題がある場合は、それぞれ独立したkeyPointとして記述
- 発言者が特定できる場合は「〇〇さん」と明記
- 議論の経緯（問題提起→意見交換→結論）を追える構成に
- 数値やデータが言及された場合は必ず含める
- 未解決の課題や今後の検討事項も漏れなく記録`,

  regular: `あなたは定例会議の議事録を作成する専門家です。
与えられた文字起こしテキストから、チームメンバーが進捗を追跡できる詳細な議事録を作成してください。

${JSON_FORMAT}

定例会議に特化した指示：
- overviewに「前回からの主な進捗」「今回の主要議題」「次回までの重点事項」を含める
- keyPointsは以下の構造で整理:
  【進捗報告】担当者: 報告内容 / 状況: 順調or遅延orブロック
  【課題共有】課題内容 / 影響範囲 / 対応方針
  【決定事項】決定内容 / 理由
  【持ち越し】内容 / 次回確認予定
- actionItemsは「次回定例まで」「今週中」「今月中」等の時間軸で整理
- KPIや数値目標への言及があれば必ず記録`,

  "one-on-one": `あなたは1on1ミーティングの議事録を作成する専門家です。
与えられた文字起こしテキストから、両者の合意事項と成長支援に役立つ議事録を作成してください。

${JSON_FORMAT}

1on1に特化した指示：
- overviewに「今回のメインテーマ」「全体的な雰囲気・状態」「主な合意事項」を含める
- keyPointsは以下のカテゴリで整理:
  【業務相談】課題内容 / アドバイス / 合意した対応
  【キャリア】話題 / 本人の考え / フィードバック
  【モチベーション】状態 / 背景 / サポート内容
  【FB（フィードバック）】具体的なフィードバック内容
  【称賛】良かった点の具体例
- 感情面の話題も「〇〇について不安を感じている」等、適切に要約
- プライバシーに配慮し、センシティブな固有名詞は一般化
- actionItemsは上司/部下の両方のコミットメントを明記`,

  sales: `あなたは商談・営業会議の議事録を作成する専門家です。
与えられた文字起こしテキストから、商談の進捗管理とネクストアクションが明確な議事録を作成してください。

${JSON_FORMAT}

商談に特化した指示：
- overviewに「顧客名・案件名」「商談フェーズ」「顧客の温度感」「主な結論」を含める
- keyPointsは以下の構造で整理:
  【ニーズ・課題】顧客が抱える課題、要望
  【提案内容】自社からの提案、デモ内容
  【顧客反応】ポジティブ/ネガティブな反応、質問
  【競合情報】言及された競合、比較ポイント
  【価格・条件】価格交渉、条件面の議論
  【懸念・障壁】導入の障壁、社内調整の課題
  【決定事項】合意した内容
- actionItemsは「【提案】」「【見積】」「【フォロー】」「【社内調整】」で分類
- 次回アポイントの日時が決まっていれば必ず記録`,

  "dev-sprint": `あなたは開発チームのミーティング議事録を作成する専門家です。
与えられた文字起こしテキストから、スプリントの状況とブロッカーが明確な議事録を作成してください。

${JSON_FORMAT}

開発MTGに特化した指示：
- overviewに「スプリント番号/期間」「完了予定のゴール」「現在のステータス」「主要なブロッカー」を含める
- keyPointsは以下の構造で整理:
  【完了】タスク名(チケット番号) / 担当者 / 成果
  【進行中】タスク名 / 進捗% / 残作業
  【ブロッカー】内容 / 影響 / 対応策
  【技術議論】議題 / 検討した選択肢 / 決定
  【バグ報告】内容 / 優先度 / 担当
  【設計判断】決定内容 / 理由 / トレードオフ
- 技術用語、API名、ライブラリ名はそのまま残す
- actionItemsにはチケット番号があれば含める
- 依存関係やマイルストーンへの影響を明記`,

  brainstorm: `あなたはブレインストーミングセッションの議事録を作成する専門家です。
与えられた文字起こしテキストから、アイデアの全体像と今後の方向性がわかる議事録を作成してください。

${JSON_FORMAT}

ブレストに特化した指示：
- overviewに「ブレストのテーマ」「到達した方向性」「特に有望なアイデア」を含める
- keyPointsは以下の構造で整理:
  【アイデア: カテゴリA】
    - アイデア1: 概要 / 発案者 / 評価コメント
    - アイデア2: 概要 / 発案者 / 評価コメント
  【アイデア: カテゴリB】...
  【却下されたアイデア】内容 / 却下理由
  【深堀りが必要】内容 / 検証ポイント
  【融合アイデア】複数アイデアの組み合わせ
- アイデアの実現可能性（高/中/低）を可能な範囲で評価
- actionItemsは「検証」「リサーチ」「プロトタイプ」「関係者確認」で分類`,
};
```

## 5. 実装手順

### Step 1: APIのプロンプト改善（約1時間）

1. `api/src/functions/summary.ts` の `JSON_FORMAT` を改善版に置き換え
2. `TEMPLATE_PROMPTS` の各テンプレートを改善版に置き換え
3. ビルド・動作確認

### Step 2: フロントエンドのテンプレート同期（約30分）

1. `web/src/lib/meetingTemplates.ts` の `PRESET_TEMPLATES` を同期
2. ビルド・動作確認

### Step 3: テスト（約30分）

1. 各テンプレートで議事録生成をテスト
2. 出力品質を確認

## 6. テスト戦略

### テストシナリオ

| テンプレート | 入力サンプル | 確認ポイント |
|-------------|-------------|-------------|
| general | チーム共有MTGの文字起こし | 議題ごとの構造化、決定事項の明記 |
| regular | 週次定例の文字起こし | 進捗/課題/決定事項の分類 |
| one-on-one | 1on1の文字起こし | カテゴリ分類、FB明記 |
| sales | 商談の文字起こし | 顧客情報、温度感、ネクストアクション |
| dev-sprint | スプリントレビューの文字起こし | 技術用語保持、ブロッカー明記 |
| brainstorm | ブレストの文字起こし | アイデアのカテゴリ分類 |

## 7. 見積り

| タスク | 見積り |
|-------|--------|
| API プロンプト改善 | 1時間 |
| フロントエンド同期 | 30分 |
| テスト | 30分 |
| **合計** | **2時間** |

## 8. 将来の拡張（Phase 2）

Phase 1 で効果が確認できたら、以下の拡張を検討：

### 8.1 出力構造の拡張

```typescript
// 新しいSummary型（後方互換性あり）
interface SummaryV2 extends Summary {
  version: "2";
  meetingInfo?: {
    title: string;
    participants: string[];
    themes: string[];
    duration?: number;
  };
  agendaItems?: Array<{
    title: string;
    background: string;
    discussion: string;
    keyPoints: string[];
    concerns: string[];
    nextSteps: string;
  }>;
  decisions?: string[];
}
```

### 8.2 話者識別との連携強化

- `segments` の `speaker` 情報を議事録生成時に活用
- 「〇〇さん（Guest-1）は〜と述べた」形式で出力

### 8.3 フロントエンド表示の改善

- 議題ごとの折りたたみ表示
- 決定事項のハイライト
- アクションアイテムのカテゴリフィルタ

## 9. リスク

| リスク | 確率 | 影響 | 対策 |
|-------|------|------|------|
| GPTの出力がフォーマットに従わない | 低 | 中 | `response_format: { type: "json_object" }` で制御済み |
| トークン数増加によるコスト増 | 中 | 低 | `max_tokens` で制限 |
| 長い会議で情報が欠落 | 中 | 中 | トランスクリプトの要約前処理を検討 |

## 10. 結論

**推奨アプローチ**: Phase 1（プロンプト改善のみ）から開始

- 型変更なしで大幅な品質向上が見込める
- 既存の表示ロジックに影響なし
- 約2時間で実装・テスト完了
- 効果を検証してからPhase 2を検討
