# 議事録精度改善 — 実装計画書

## 概要

議事録生成の品質を「薄い要約」から「詳細な議事録」に引き上げるための実装計画書。
変更対象は主に2ファイル（`api/src/functions/summary.ts` と `web/src/app/recording/page.tsx`）。

---

## 変更ファイル一覧

| ファイル | 変更内容 | リスク |
|---------|---------|--------|
| `api/src/functions/summary.ts` | プロンプト改修、JSON_FORMAT改修、max_tokens変更、ユーザーメッセージ強化 | 低 |
| `web/src/app/recording/page.tsx` | 議事録生成時に話者ラベル付きトランスクリプトを送信 | 低 |

---

## 実装詳細

### 修正1: `TEMPLATE_PROMPTS["general"]` プロンプト全面改修

**ファイル**: `api/src/functions/summary.ts` L149-196

**変更前** (概要):
```
あなたは最強の議事録作成者です。
...（短い出力要件リスト）
...
${JSON_FORMAT}
```

**変更後**:
```typescript
  general: `あなたは最強の議事録作成者です。
以下の会議ログ（発話の羅列/文字起こし/メモ）から、「**網羅的で詳細な議事録**」を作成してください。

# 最重要ルール（これを最優先で守ること）
1. **会議で触れられた全ての話題を独立した topic として記録する**（漏れ禁止）
2. **各 topic の content は最低200文字以上**で、背景→議論経緯→結論/未決の流れで丁寧に記述する
3. **固有名詞（人名・顧客名・案件番号・製品名・数値・日時・期限）は全て拾って正確に記載する**
4. **参加者名は文字起こしに記載されたラベル（例: Guest-1, Guest-2）をそのまま使う。推測で実名を付けない**
5. **情報を省略・圧縮しない**。要約ではなく詳細な記録を作成する
6. **個別の案件・チケット・顧客についての議論は、それぞれ独立した topic として分けて記録する**

# 出力要件
- 事実ベースで、合意事項・未決事項・宿題を明確に分ける
- 時系列の流れが追えるように整理しつつ、話題の転換点で topic を分割する
- 聞き取りづらい・曖昧な箇所は断定せず「（要確認）」として残す
- 可能な範囲で Q&A 形式を抽出する
- 文体はビジネス向け、箇条書きと文章を適切に組み合わせて読みやすく

# 品質基準（必ず守ること）
- **1時間の会議** → topics **8〜15件**、actionItems **5〜10件**、decisions **3〜8件**
- **30分の会議** → topics **4〜8件**、actionItems **3〜5件**
- **15分の会議** → topics **2〜4件**、actionItems **1〜3件**
- 上記はあくまで最低ラインであり、会議内容が豊富ならさらに多くてよい

# フォーマット
1. 会議情報（会議名/開催形式/主目的を具体的に。参加者は文字起こしのラベルそのまま使用）
2. 議題・論点（全話題を箇条書き。漏れなく列挙。10件以上になることもある）
3. 主要な会話内容（全話題を時系列で。各話題に小見出し＋詳細記述。省略しない）
4. 決定事項（合意したこと全て。具体的な日時・担当・条件を含める）
5. 宿題・アクションアイテム（担当/期限/関連背景を含め、全て列挙）
6. 質疑応答（主な Q&A。未回答は「未回答・持ち帰り」と明記）
7. 次回に向けた進め方

# 追加ルール
- 重要な数値・期間・時間帯・制限は **太字** にする
- 参加者名が曖昧な場合は「（発話ログ上の呼称：◯◯）」のように書く
- 担当者間の役割分担・引き継ぎの議論は具体的に記録する
- 懸念・リスクに関する発言は漏らさず記録する
- 根拠のない推測は書かない

${JSON_FORMAT}`,
```

**変更のポイント**:
- 「最重要ルール」として「全話題網羅」「200字以上/topic」「固有名詞全抽出」「参加者名捏造禁止」を最上位に配置
- 品質基準として会議時間別の件数目安を明示
- 「情報を省略・圧縮しない」「要約ではなく詳細な記録」を強調
- 個別案件を独立topic化する指示を追加

---

### 修正2: `JSON_FORMAT` 定数の改修

**ファイル**: `api/src/functions/summary.ts` L83-147

**変更後**:
```typescript
const JSON_FORMAT = `出力は必ず以下のJSON形式で返してください。
※重要: 以下はフォーマットの例示です。実際の出力では会議内容に応じて topics は10件以上、actionItems は5件以上になります。省略せず全て記載してください。

{
  "caution": "センシティブ情報がある場合のみ記載。なければnull",

  "meetingInfo": {
    "title": "会議の具体的な名称（例: 'チーム週次定例', 'ケース運用・体制確認MTG'。不明なら内容から推測）",
    "participants": ["Guest-1", "Guest-2"],
    "datetime": "実施日時（不明なら『不明』）",
    "purpose": "会議の目的・背景を具体的に2-3文で記述。例: '直近のワークロード/体制見通しの共有、個別案件のクローズ方針決定、停滞案件の次アクション整理'"
  },

  "agenda": [
    "議題1: ワークロードの状況確認",
    "議題2: 人員変動に伴う体制見直し",
    "議題3: 個別案件A（渋沢様 SR4526）のクローズ方針",
    "議題4: 個別案件B（石川様）のフォローアップ",
    "議題5: 技術検証（PKI再現テスト）の進め方"
  ],

  "topics": [
    {
      "title": "近況・ワークロードの状況",
      "content": "（Guest-1）が最近のワークロードの状況を確認。JPでのアサインが多く、グローバルでは1日1件程度だが、JPはそれ以上に来ている。週あたりの処理規模感として、だいたい**週15〜20件**のペースで回っている。（Guest-2）からは、JPに偏っている印象で正直「なめてる」という率直な感想もあった。"
    },
    {
      "title": "人員減少・4月の体制リスク",
      "content": "神経さんが育休に入る予定であり、**4月**が最も体制リスクが高い時期との認識を共有。APACタイムゾーンの関係で日本にケースが寄りやすい可能性が指摘された（マレーシア・シンガポールが先に捌かれ、日本は3時間のタイムゾーン差で後回しになりうる）。\n\n渡辺さんの方針として「人数が減っても、ワークロードを増やすのではなく、人数に合わせて仕事量を調整したい」との共有があったが、現実にはJP案件は来るため、最終的には自分たちで捌く前提も確認。（Guest-1）は最悪「自分が死ぬほど取ればなんとかなる」と述べつつ、他業務が止まるトレードオフを認識。"
    },
    {
      "title": "個別案件: 渋沢様（SR4526）のクローズ判断",
      "content": "連絡が取れない状況。クローズ自体は「するしかない」が、タイミングが問題。過去の返信時間帯を分析し、翌日が平日のタイミングは避けたい。三連休を利用する案も検討された。\n\n最終合意: **2/20（金）の夜、22〜23時目安**にクローズ実施。もし4/5以外の評価が返ってきたらフォロー対応。"
    }
  ],

  "decisions": [
    "人数が減っても仕事量は人数に合わせて調整する方針（渡辺さんの考え）を共有",
    "渋沢様（SR4526）は2/20夜22〜23時にクローズする",
    "石川様案件は電話を2〜3回追加トライし、出なければ見切りクローズ",
    "PKI 289はGuest-1が再現検証を実施し、トレースを取得してGuest-2へ共有する"
  ],

  "actionItems": [
    {
      "id": "1",
      "task": "渋沢様（SR4526）を2/20夜遅めにクローズ。返答があればフォロー",
      "assignee": "Guest-1",
      "dueDate": "2026-02-20",
      "context": "連絡が取れない顧客。三連休前の金曜夜にクローズする方針"
    },
    {
      "id": "2",
      "task": "PKI 289の再現検証を実施し、トレースを取得・共有する",
      "assignee": "Guest-1",
      "dueDate": "2026-02-18",
      "context": "PG側で再現できない問題。OneLakeセキュリティ有効化+フォルダアップロードで再現テスト"
    },
    {
      "id": "3",
      "task": "石川様へ電話トライ継続（2〜3回）",
      "assignee": "Guest-2",
      "dueDate": "未定",
      "context": "エイジドが長い案件。電話で粘り、出なければ見切りクローズも視野"
    }
  ],

  "qaItems": [
    {
      "question": "インターナルタイトルの修正は明文化されたルールがあるか？",
      "answer": "明文化されたルールは見当たらない。説明責任を果たせる範囲で例外対応も許容される。ただしTracking ID文字列はセンシティブで、検知トリガーになりうるため弄らない前提。"
    }
  ],

  "nextSteps": [
    "Guest-1: 不在期間確定後に最終的な役割分担を再調整",
    "Guest-2: 長期オペレーション案件のピン間隔を短縮して対応",
    "次回定例で体制変更後の状況を再確認"
  ]
}

【書き方のルール】
1. 文字起こしの内容に忠実に。推測で事実を増やさない（不明点は「不明」「（要確認）」）
2. 時系列の流れが追えるように整理しつつ、話題の転換点を明確にする
3. 重要なニュアンス（懸念・温度感・言い回しの意図）は落とさない
4. 固有名詞（人名/顧客名/チーム名/ツール名/チケット番号）や数値は漏らさず拾う
5. 誰の発言かわかるものは（Guest-1）のように補足
6. 参加者名は文字起こしのラベルをそのまま使用。推測で実名を付けない
7. 重要な数値・期間・時間帯は **太字** にする
8. 各 topic の content は最低200文字以上。第三者が読んでも文脈と結論が理解できる詳細さにする
9. 根拠のない推測は書かない
10. 必ず有効なJSONで出力
11. 省略しない。全話題・全決定事項・全アクションアイテムを記載する`;
```

**変更のポイント**:
- サンプルの topics を3件に増やし、各 content を200字以上の具体例に
- participants を `"Guest-1", "Guest-2"` に変更（捏造防止）
- purpose を具体的な2-3文の例に
- agenda を5件に増やした例に
- decisions を4件、actionItems を3件に増加
- 冒頭に「省略せず全て記載」の注記を追加
- ルール11として「省略しない」を追加
- ルール8に「最低200文字以上」を明記

---

### 修正3: `max_tokens` を 16000 に引き上げ

**ファイル**: `api/src/functions/summary.ts` L377

**変更前**:
```typescript
max_tokens: 8000,
```

**変更後**:
```typescript
max_tokens: 16000,
```

---

### 修正4: ユーザーメッセージの動的強化

**ファイル**: `api/src/functions/summary.ts` L372-375

**変更前**:
```typescript
{
  role: "user",
  content: `以下の文字起こしテキストから議事録を作成してください：\n\n${body.transcript}`,
}
```

**変更後**:
```typescript
{
  role: "user",
  content: `以下は会議の文字起こしです（約${body.transcript.split('\n').length}発話、約${body.transcript.length}文字）。
全ての話題を漏れなく網羅した詳細な議事録を作成してください。情報を省略せず、会議で議論された全ての話題・決定事項・アクションアイテムを記載してください。

---
${body.transcript}`,
}
```

---

### 修正5: `recording/page.tsx` で話者ラベル付きトランスクリプトを送信

**ファイル**: `web/src/app/recording/page.tsx` L527-528

**変更前**:
```typescript
const response = await summaryApi.generateSummary({
  transcript: recording.transcript.fullText,
```

**変更後**:
```typescript
// 話者ラベル付きトランスクリプトを使用（話者情報がある場合）
const transcriptForSummary = getTranscriptWithSpeakerLabels();
const response = await summaryApi.generateSummary({
  transcript: transcriptForSummary,
```

**補足**: `getTranscriptWithSpeakerLabels()` は L445 に既に定義されている関数で、segments に speaker 情報がある場合は `[Guest-1] テキスト` 形式で返し、ない場合は fullText をそのまま返す。

---

## テスト計画

### Step 1: APIレベル検証
- 変更後のAPIに、ユーザー提供の長文トランスクリプト（約300行）を送信
- 出力のトピック数、アクションアイテム数、固有名詞の有無を確認
- 参加者名が Guest-1/Guest-2 になっていることを確認

### Step 2: recording/page.tsx 検証
- History画面から録音の議事録を再生成
- 話者ラベルが正しく反映されることを確認
- 参加者名が捏造されないことを確認

### Step 3: 他テンプレート影響確認
- `regular`, `one-on-one`, `sales` テンプレートでも動作確認
- JSON_FORMAT の変更が各テンプレートで正しく反映されることを確認

---

## デプロイ手順

1. `fix/summary-quality` ブランチを作成
2. 上記5つの修正を適用
3. `npm run build` でAPIとWebの両方をビルド確認
4. PR作成 → CI通過確認
5. main にマージ → 自動デプロイ

---

*計画書作成日: 2026-02-17*
*作成者: ReviewAAgent*
