# Issue #76 分析レビュー: 一部ページで言語設定が反映されず日本語のまま表示される

## 1. エグゼクティブサマリー

- **問題の本質**: アプリ全体で約70箇所以上のハードコード日本語文字列がUIに残存しており、言語設定を変更してもこれらが翻訳されない。特に録音詳細ページ（`recording/page.tsx`）は**ほぼ全て**がハードコード。プライバシーポリシー・利用規約ページは**ページ全体**が日本語のみ。
- **影響範囲**: 英語・スペイン語ユーザーの100%に影響。全ページ中、録音詳細ページ・プライバシーポリシー・利用規約の3ページが完全に日本語のまま表示される。
- **修正の緊急度**: **High** — 多言語対応がアプリの基本機能であり、ユーザー体験を大きく損ねている。

---

## 2. アーキテクチャ概観

### 2.1 i18n コンポーネント依存関係

```
I18nProvider (contexts/I18nContext.tsx)
├── NextIntlClientProvider
│   └── messages/{ja,en,es}.json
│       ├── Common.*
│       ├── Header.*
│       ├── Footer.*
│       ├── HomePage.*
│       ├── HistoryPage.*
│       ├── SettingsPage.*
│       ├── AuthGateModal.*
│       └── TranscriptView.*
├── useLocale() → locale, setLocale
└── useTranslations(namespace) → t("key")
```

### 2.2 ページ別 i18n 対応状況

| ページ | ファイル | i18n対応状況 | ハードコード日本語数 |
|--------|---------|-------------|-------------------|
| ホーム | `app/page.tsx` | ✅ ほぼ対応済み | ~10箇所（議事録表示部分） |
| 録音詳細 | `app/recording/page.tsx` | ❌ 未対応 | ~56箇所 |
| 履歴 | `app/history/page.tsx` | ✅ 対応済み | 0 |
| 設定 | `app/settings/page.tsx` | ✅ 対応済み | ~1箇所 |
| プライバシー | `app/privacy/page.tsx` | ❌ 完全未対応 | ページ全体 |
| 利用規約 | `app/terms/page.tsx` | ❌ 完全未対応 | ページ全体 |
| レイアウト | `app/layout.tsx` | ✅ 対応済み | 0 |

### 2.3 データフロー

```
LocalStorage("airecorder-locale")
  → I18nProvider(locale)
    → loadMessages(locale) → import(`messages/${locale}.json`)
      → NextIntlClientProvider(messages)
        → useTranslations("namespace") → t("key")
          → 各コンポーネントが翻訳テキストを表示
```

---

## 3. 重大バグ分析 🔴

### BUG-1: 録音詳細ページがほぼ全てハードコード日本語 [Critical]

**場所**: `web/src/app/recording/page.tsx` 全体（~920行）

**問題**: このページは `useTranslations` を使用しておらず、UI テキストの大部分（56箇所以上）がハードコードの日本語文字列。

**主要なハードコード箇所**:

| 行 | ハードコード文字列 | 用途 |
|----|------------------|------|
| 80 | `"ja-JP"` (ハードコードロケール) | 日付フォーマット |
| 127-151 | テンプレート名・説明（要約、会議、1on1等） | ドロップダウン表示 |
| 163 | `"録音IDが指定されていません"` | エラーメッセージ |
| 216-220 | `"⏳ AI補正中..."`, `"✨ AI補正済み"`, `"❌ 補正失敗"` | ステータスバッジ |
| 287 | `"不明"` | 不明な話者 |
| 296 | `"この録音を削除しますか？この操作は取り消せません。"` | 確認ダイアログ |
| 302 | `"削除に失敗しました: "` | エラーアラート |
| 322 | `"タイトル更新に失敗しました: "` | エラーアラート |
| 345 | `"議事録生成に失敗しました: "` | エラーアラート |
| 385-387 | `"ログインが必要です"`, 説明, ボタン | ログイン画面 |
| 402 | `"読み込み中..."` | ローディング |
| 409 | `"録音が見つかりません"` | エラー表示 |
| 413, 425 | `"履歴に戻る"` | ナビゲーション |
| 429-441 | `"エクスポート"`, 各形式名 | エクスポートメニュー |
| 480 | `"音声を読み込み中..."` | ローディング |
| 490 | `"お使いのブラウザは音声再生をサポートしていません。"` | エラー |
| 499-509 | `"ダウンロード"`, `"ダウンロードに失敗しました"` | ダウンロード |
| 518-526 | `"文字起こし"`, `"翻訳"`, `"議事録"` | タブラベル |
| 541-549 | `"オリジナル"`, `"AI補正版"` | トグルボタン |
| 567-620 | `"コピー"` (×2) | ボタン |
| 580-590 | `"AI補正処理中です..."`, `"文字起こしデータがありません"` | ステータス |
| 632 | `"翻訳データがありません"` | 空状態 |
| 683-695 | `"⚠️ 注意事項"`, 会議情報ラベル | 議事録表示 |
| 730-745 | 議題詳細ラベル（背景、現状、課題等） | 議事録表示 |
| 788-907 | 再生成ダイアログ全体 | モーダル |
| 847-849 | 空状態メッセージ | プレースホルダー |

**影響**: 英語・スペイン語を選択した全ユーザーに影響。録音詳細ページはアプリの中核機能であり、最も頻繁に使われるページ。

**根本原因**: このページが作成された際に i18n 対応が行われなかった。`useTranslations` のインポートも存在しない。

**修正方針**: 
1. `RecordingDetail` ネームスペースを全メッセージファイルに追加
2. `useTranslations("RecordingDetail")` をページに追加
3. 全ハードコード文字列を `t("key")` に置換

---

### BUG-2: プライバシーポリシーページが完全に日本語 [Critical]

**場所**: `web/src/app/privacy/page.tsx` 全体

**問題**: ページ全体がハードコード日本語。「プライバシーポリシー」「はじめに」「第1条〜」等の法的文書がすべて日本語のみ。

**影響**: 英語・スペイン語ユーザーがプライバシーポリシーを読めない。法的リスクにもなりうる。

**修正方針**: 
1. `PrivacyPage` ネームスペースを全メッセージファイルに追加
2. ページコンポーネントを i18n 対応に書き換え

---

### BUG-3: 利用規約ページが完全に日本語 [Critical]

**場所**: `web/src/app/terms/page.tsx` 全体

**問題**: BUG-2 と同様。「利用規約」「第1条（適用）」〜「第10条」等がすべて日本語のみ。

**修正方針**: `TermsPage` ネームスペースを追加し、i18n 対応に書き換え。

---

### BUG-4: ホームページの議事録表示部分がハードコード日本語 [High]

**場所**: `web/src/app/page.tsx` L1116-1163付近

**問題**: 議事録の会議情報・議題詳細の表示ラベル（`"会議名:"`, `"日時:"`, `"参加者:"`, `"目的:"`, `"背景・前提:"`, `"現状共有:"`, `"課題/懸念:"`, `"議論の要点:"`, `"具体例:"`, `"次アクション:"`）がハードコード。

**影響**: 議事録を表示する全ユーザーに影響。

**修正方針**: `HomePage` ネームスペースに議事録表示用キーを追加。

---

### BUG-5: サービス層のエラーメッセージがハードコード日本語 [High]

**場所**: 
- `web/src/services/templatesApi.ts` L71, 85, 104, 120, 135 — `"認証が必要です"` ×5
- `web/src/services/settingsApi.ts` L63 — `"認証が必要です。ログインしてください。"`
- `web/src/services/summaryApi.ts` L37 — `"サーバーからの応答を解析できませんでした: "`

**問題**: サービス層からのエラーメッセージがそのままUIに表示される。

**影響**: エラー発生時に英語・スペイン語ユーザーに日本語エラーが表示される。

**修正方針**: 
- サービス層ではエラーコード（英語キー）を返す
- 表示層で `t()` を使って翻訳する

---

### BUG-6: エクスポート機能のテキストがハードコード日本語 [Medium]

**場所**: `web/src/lib/export.ts` 全体

**問題**: エクスポートされるテキスト/Markdownファイルのラベル（`"■ 基本情報"`, `"タイトル:"`, `"録音日時:"` 等）がすべて日本語。日付フォーマットも `"ja-JP"` ハードコード。

**影響**: 英語ユーザーがエクスポートしたファイルが日本語で出力される。

**修正方針**: export 関数にロケールパラメータを追加し、翻訳済みラベルを使用。

---

## 4. 設計上の問題 🟡

### DESIGN-1: es.json のキー名が ja.json / en.json と不整合 [Medium]

**問題**: `SettingsPage` セクションで、es.json が ja.json/en.json と異なるキー名を使用：

| ja.json / en.json のキー | es.json のキー |
|--------------------------|---------------|
| `description` | `subtitle` |
| `defaultInputLang` | `defaultInputLanguage` |
| `defaultTargetLang` | `defaultTargetLanguage` |
| `speakerDiarization` (card title) | `speakerSettings` |
| `speakerDiarizationDesc` | `speakerSettingsDesc` |
| `speakerDiarizationToggle` | `speakerDiarization` |
| `speakerDiarizationToggleDesc` | `speakerDiarizationDesc` |
| `speakerNotes` | `speakerWarningTitle` |
| `speakerNote1-3` | `speakerWarning1-3` |
| `appearance` | `appearanceSettings` |
| `appearanceDesc` | `appearanceSettingsDesc` |
| `saving` | ❌ 欠落 |

**影響**: スペイン語に切り替えた場合、設定ページの一部のラベルがキー名のまま表示されるか、fallback で日本語が表示される。

### DESIGN-2: サービス層にUIテキストが混在 [Medium]

**問題**: `templatesApi.ts`, `settingsApi.ts`, `summaryApi.ts` がUI表示用の日本語エラーメッセージを直接返している。サービス層はエラーコードを返し、表示層で翻訳すべき。

### DESIGN-3: export.ts がロケール非対応 [Medium]

**問題**: `export.ts` にロケールを受け取る仕組みがなく、日付フォーマットも `"ja-JP"` 固定。

---

## 5. 依存関係マトリクス 📊

### 5.1 Issue 間依存関係

```
Issue #76 は独立して修正可能（他の Open Issue #33, #34, #35, #40 との依存なし）
```

### 5.2 技術的依存関係

| コンポーネント | 依存先 | リスク | 対策 |
|---------------|--------|--------|------|
| recording/page.tsx | メッセージファイル全体 | 新規ネームスペース追加が大規模 | RecordingDetail 名前空間に集約 |
| privacy/page.tsx | 法的文書の翻訳 | 翻訳の正確性 | 法務確認を推奨 |
| terms/page.tsx | 法的文書の翻訳 | 翻訳の正確性 | 法務確認を推奨 |
| es.json | ja.json/en.json との整合性 | キー不整合で表示崩れ | キー名を統一 |
| export.ts | ロケール引数の追加 | 呼び出し元の変更必要 | recording/page.tsx と page.tsx を更新 |

---

## 6. ブラウザ / 環境互換性リスク

該当なし。本 Issue は純粋な i18n テキスト問題であり、ブラウザ互換性の影響なし。

---

## 7. 修正提案（優先順位付き）

### Phase 1: 致命的バグ修正（P0）

#### 1-1. recording/page.tsx の完全 i18n 対応
- `RecordingDetail` ネームスペースを ja.json, en.json, es.json に追加（約60キー）
- ページに `useTranslations("RecordingDetail")` を追加
- 全ハードコード日本語を `t("key")` に置換
- 日付フォーマットのロケールを `locale` から取得

#### 1-2. privacy/page.tsx の i18n 対応
- `PrivacyPage` ネームスペースを全メッセージファイルに追加
- ページを `useTranslations` ベースに書き換え

#### 1-3. terms/page.tsx の i18n 対応
- `TermsPage` ネームスペースを全メッセージファイルに追加
- ページを `useTranslations` ベースに書き換え

### Phase 2: 設計改善（P1）

#### 2-1. es.json のキー名統一
- es.json の SettingsPage セクションのキー名を ja.json/en.json に合わせる
- 欠落キー（`saving`）を追加

#### 2-2. page.tsx（ホーム）の議事録表示 i18n 対応
- `HomePage` に議事録表示用キーを追加（会議情報ラベル、議題詳細ラベル）
- ハードコード日本語を `t("key")` に置換

#### 2-3. サービス層のエラーメッセージ国際化
- `templatesApi.ts`: `"認証が必要です"` → エラーコード返却
- `settingsApi.ts`: 同上
- `summaryApi.ts`: 同上
- 表示層でエラーコードを翻訳キーに変換

### Phase 3: 堅牢性強化（P2）

#### 3-1. export.ts のロケール対応
- 関数にロケール引数を追加
- `Export` ネームスペースを追加、翻訳済みラベルを使用
- 日付フォーマットをロケール動的化

#### 3-2. meetingTemplates.ts の多言語対応検討
- AI プロンプト自体は翻訳不要（出力言語は別パラメータで制御）
- ただし、テンプレート名表示はメッセージファイルのキーを参照するよう統一

---

## 8. テスト戦略

### 状態遷移テスト（Unit）
- 各ロケール（ja, en, es）でメッセージファイルのキーが全て存在するか検証
- `next-intl` の `t()` で未定義キーがないか検証

### 統合テスト
| シナリオ | 検証項目 |
|---------|---------|
| 言語を en に変更 → 録音詳細ページを表示 | 全テキストが英語で表示されること |
| 言語を es に変更 → 設定ページを表示 | 全テキストがスペイン語で表示されること |
| 言語を en に変更 → プライバシーポリシーを表示 | 英語で表示されること |
| 言語を en に変更 → エクスポート実行 | エクスポートファイルが英語で出力されること |
| エラー発生時（認証切れ等） | エラーメッセージが選択言語で表示されること |

### 手動テスト
- 全3言語で全ページを目視確認
- 残存する日本語テキストがないことを確認

---

## 9. 実装ロードマップ

| Step | 作業内容 | 見積り | 影響範囲 |
|------|---------|--------|---------|
| 1-1 | recording/page.tsx i18n 対応 + メッセージファイル追加 | 2h | recording/page.tsx, ja/en/es.json |
| 1-2 | privacy/page.tsx i18n 対応 | 1h | privacy/page.tsx, ja/en/es.json |
| 1-3 | terms/page.tsx i18n 対応 | 1h | terms/page.tsx, ja/en/es.json |
| 2-1 | es.json キー名統一 | 30min | es.json |
| 2-2 | page.tsx 議事録部分 i18n | 30min | page.tsx, ja/en/es.json |
| 2-3 | サービス層エラー国際化 | 1h | templatesApi.ts, settingsApi.ts, summaryApi.ts, ja/en/es.json |
| 3-1 | export.ts ロケール対応 | 1h | export.ts, recording/page.tsx, page.tsx, ja/en/es.json |

**合計見積: 約7時間**

---

## 10. リスクアセスメント

| リスク | 確率 | 影響度 | 対策 |
|--------|------|--------|------|
| 翻訳キーの typo | 中 | 中 | TypeScript で型安全なキーアクセスを検討 |
| es.json キー統一時の見落とし | 中 | 中 | diff ツールで3ファイルを比較 |
| 法的文書の翻訳精度 | 低 | 高 | 法務レビューを推奨（まずは機械翻訳で対応） |
| 大量変更による regression | 中 | 中 | Phase ごとに PR を分けて確認 |

---

## 11. 結論

- **最大の問題点**: `recording/page.tsx` が i18n 完全未対応で約56箇所のハードコード日本語。プライバシーポリシー・利用規約も全文日本語。
- **推奨する修正順序**: Phase 1 (P0: recording → privacy → terms) → Phase 2 (P1: es.json統一 → page.tsx議事録 → エラーメッセージ) → Phase 3 (P2: export)
- **他 Issue への影響**: なし（独立して修正可能）
- **判定**: **GO** — 即時着手を推奨。多言語対応は基本機能であり、現状では英語・スペイン語ユーザーの体験が著しく損なわれている。
