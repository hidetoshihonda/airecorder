# 履歴表示の不具合 - 原因分析と対策

## 📅 発生日時
2026年2月6日

## 🔴 問題の概要
- 録音を保存すると「保存完了」と表示される
- しかし履歴ページには何も表示されない
- APIには正常にデータが保存されている（9件確認済み）

---

## 🔍 原因分析

### 調査結果

#### 1. APIレスポンスの確認
```
GET /api/recordings/list?userId=temp-user-001
```

**レスポンス構造:**
```json
{
  "success": true,
  "data": {
    "items": [...],     // ← 録音データの配列
    "total": 9,
    "page": 1,
    "limit": 20,
    "hasMore": false
  }
}
```

#### 2. recordingsApi.ts の request メソッド
```typescript
// Line 71-72
return {
  data: data.data || data,  // APIレスポンスの data 部分を返す
};
```

これにより `recordingsApi.listRecordings()` の戻り値は:
```typescript
{
  data: {
    items: [...],
    total: 9,
    page: 1,
    ...
  }
}
```

#### 3. history/page.tsx のデータ処理（問題箇所）
```typescript
// Line 65-68
const items = Array.isArray(response.data)
  ? response.data
  : response.data.data || [];  // ❌ 間違い！
setRecordings(items);
```

### 🐛 根本原因
**`response.data.data` を参照しているが、正しくは `response.data.items`**

| 参照パス | 値 | 結果 |
|---------|-----|------|
| `response.data` | `{items: [...], total: 9, ...}` | オブジェクト |
| `response.data.data` | `undefined` | ❌ 空配列になる |
| `response.data.items` | `[...9件の録音...]` | ✅ 正しい |

---

## 📊 影響範囲

### 影響を受けるファイル
| ファイル | 問題 | 影響 |
|---------|------|------|
| `src/app/history/page.tsx` | `response.data.data` を参照 | 履歴が表示されない |

### 影響を受けない部分
- 録音機能 ✅
- 保存機能（API呼び出し）✅
- データベース保存 ✅
- 翻訳機能 ✅

---

## ✅ 対策

### 即時対応（コード修正）

**修正箇所: `src/app/history/page.tsx`**

```typescript
// Before (Line 65-68)
const items = Array.isArray(response.data)
  ? response.data
  : response.data.data || [];

// After
const items = Array.isArray(response.data)
  ? response.data
  : response.data.items || [];
```

**同様の修正が必要な箇所:**
- Line 65-68 (useEffect内)
- Line 80-83 (fetchRecordings内)

### 再発防止策

#### 1. 型定義の厳格化
`PaginatedResponse<T>` の型を明示的に使用し、コンパイル時にエラーを検出できるようにする。

```typescript
interface PaginatedResponse<T> {
  items: T[];      // ← 明確に items
  total: number;
  page: number;
  limit: number;
  hasMore: boolean;
}
```

#### 2. API レスポンス処理の統一
共通のヘルパー関数を作成:

```typescript
function extractItems<T>(response: ApiResponse<PaginatedResponse<T>>): T[] {
  if (response.error || !response.data) return [];
  return response.data.items || [];
}
```

#### 3. ユニットテストの追加
履歴ページのデータ取得ロジックにテストを追加。

#### 4. デバッグログの追加（開発環境のみ）
API レスポンスの構造をログ出力し、不整合を早期発見。

---

## 📝 修正後の確認項目

- [x] 型定義を修正（`PaginatedResponse.data` → `PaginatedResponse.items`）
- [x] 履歴ページのデータ取得ロジックを修正
- [x] ビルド成功
- [x] デプロイ完了
- [ ] 履歴ページでデータが表示されること
- [ ] 検索機能が動作すること
- [ ] 削除機能が動作すること

---

## 🔧 実施した修正

### 1. 型定義の修正 (`src/types/index.ts`)
```typescript
// Before
export interface PaginatedResponse<T> {
  data: T[];
  pageSize: number;
  ...
}

// After
export interface PaginatedResponse<T> {
  items: T[];  // APIレスポンスに合わせて修正
  limit: number;  // pageSize → limit に修正
  ...
}
```

### 2. 履歴ページの修正 (`src/app/history/page.tsx`)
```typescript
// Before
const items = response.data.data || [];

// After
const items = response.data.items || [];
```

---

## 📚 教訓

1. **APIレスポンスの構造を確認する** - 実際のレスポンスとコードの期待値が一致しているか
2. **型定義を活用する** - TypeScriptの型チェックで不整合を早期発見
3. **E2Eテストの重要性** - 保存→履歴表示の一連のフローをテスト

---

# 追加不具合: JSONパースエラー

## 📅 発生日時
2026年2月6日（履歴表示修正後）

## 🔴 問題の概要
```
Failed to execute 'json' on 'Response': Unexpected end of JSON input
```
- 履歴は表示されるようになった
- 録音詳細ページで「履歴に戻る」を押す際にエラー発生

---

## 🔍 原因分析

### 調査結果

#### 1. エラー発生箇所
`recordingsApi.ts` の `request` メソッド (Line 64):
```typescript
const data = await response.json();  // ← ここでエラー
```

#### 2. 問題のコード
```typescript
private async request<T>(endpoint: string, options: RequestInit = {}): Promise<ApiResponse<T>> {
  try {
    const response = await fetch(url, { ... });
    const data = await response.json();  // 無条件でJSONパース
    // ...
  } catch (error) {
    return { error: (error as Error).message || "Network error" };
  }
}
```

### 🐛 根本原因
**`response.json()` を無条件で呼んでいるが、以下のケースで空レスポンスになる:**

| ケース | 状況 | レスポンスボディ |
|--------|------|-----------------|
| 204 No Content | DELETE成功など | 空 |
| ネットワークエラー | 接続断 | 空または不完全 |
| CORSエラー | プリフライト失敗 | アクセス不可 |
| タイムアウト | 遅延 | 空または不完全 |

### 影響を受けるファイル
| ファイル | 問題 |
|---------|------|
| `src/services/recordingsApi.ts` | `request()` で無条件JSON.parse |
| `src/services/blobApi.ts` | 同様の問題 |
| `src/services/summaryApi.ts` | 同様の問題 |

---

## ✅ 対策

### 修正方針
1. **レスポンスボディの存在確認** - `Content-Length` または `response.text()` で確認
2. **安全なJSONパース** - try-catchでパースエラーをハンドリング
3. **空レスポンス対応** - 204などの場合は空オブジェクトを返す

### 修正コード
```typescript
private async request<T>(endpoint: string, options: RequestInit = {}): Promise<ApiResponse<T>> {
  const url = `${this.baseUrl}${endpoint}`;

  try {
    const response = await fetch(url, {
      ...options,
      headers: {
        "Content-Type": "application/json",
        ...options.headers,
      },
    });

    // 空レスポンスのハンドリング
    const text = await response.text();
    let data: any = null;
    
    if (text) {
      try {
        data = JSON.parse(text);
      } catch (parseError) {
        console.error('[API] JSON parse error:', parseError, 'Response text:', text);
        return { error: 'Invalid JSON response from server' };
      }
    }

    if (!response.ok) {
      return {
        error: data?.error || `HTTP error ${response.status}`,
      };
    }

    return {
      data: data?.data || data,
    };
  } catch (error) {
    console.error('[API] Request error:', error);
    return {
      error: (error as Error).message || "Network error",
    };
  }
}
```

### 修正対象ファイル
1. `src/services/recordingsApi.ts` - requestメソッド
2. `src/services/blobApi.ts` - getUploadSas, getDownloadSas
3. `src/services/summaryApi.ts` - request メソッド（該当する場合）

---

## 📝 再発防止策

1. **API通信の統一ヘルパー作成**
   - 全サービスで同じ安全なfetchラッパーを使用
   - エラーハンドリングを一箇所に集約

2. **レスポンス検証の標準化**
   - Content-Typeヘッダーの確認
   - ステータスコードに応じた処理分岐

3. **ログ出力の強化**
   - 開発環境でAPIリクエスト/レスポンスをログ出力
   - エラー発生時の詳細情報記録

---

# 追加不具合: HTTP 404エラー（録音詳細取得）

## 📅 発生日時
2026年2月6日（JSONパースエラー修正後）

## 🔴 問題の概要
- 履歴から録音詳細を開くと「HTTP error 404」が発生
- APIは存在するがルーティングが失敗

## 🔍 原因分析

### 調査結果
```
GET /api/recordings/{id} → 404 (empty response)
GET /api/recordings/list → 200 OK
```

### 🐛 根本原因
**Azure Functions V4で同じルートに複数の関数が登録されていた**

問題のコード（修正前）:
```typescript
// 3つの関数が同じルート "recordings/{id}" を使用
app.http("getRecording", { methods: ["GET"], route: "recordings/{id}" });
app.http("updateRecording", { methods: ["PUT"], route: "recordings/{id}" });
app.http("deleteRecording", { methods: ["DELETE"], route: "recordings/{id}" });
```

Azure Functions V4では、同じルートに複数の関数があるとルーティングが不安定になる。

## ✅ 対策

### 修正内容
3つの関数を1つに統合：

```typescript
app.http("recordingById", {
  methods: ["GET", "PUT", "DELETE", "OPTIONS"],
  route: "recordings/{id}",
  handler: async (request) => {
    if (request.method === "GET") { /* GET処理 */ }
    if (request.method === "PUT") { /* PUT処理 */ }
    if (request.method === "DELETE") { /* DELETE処理 */ }
  },
});
```

### 修正ファイル
- `api/src/functions/recordings.ts` - 関数を統合

### デプロイ後の確認
```
GET /api/recordings/{id} → 200 OK ✅
```
