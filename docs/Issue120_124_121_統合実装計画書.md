# Issue #120 / #124 / #121 統合実装計画書

## 概要

3件の P2 Issue を一括で実装するための計画書。  
すべて独立した修正であり、並行・順次のどちらでも実装可能。

---

## Issue 一覧

| # | タイトル | 種別 | 対象ファイル | 見積り |
|---|---------|------|-------------|--------|
| #120 | AI補正版コピー時に話者ラベル欠落 | bug | `web/src/app/recording/page.tsx` | 15分 |
| #124 | 「要約」テンプレートをシンプルに | fix | `api/src/functions/summary.ts` | 20分 |
| #121 | スマホ版 AI補正版UI改善 | enhancement | `web/src/app/recording/page.tsx` | 22分 |

**合計見積り**: 約60分（ブランチ・PR・CI含む）

---

## 実装順序

```
#120 (話者ラベル) → #124 (要約テンプレ) → #121 (モバイルUI)
```

**理由**:
- #120 と #121 は同じファイル（`recording/page.tsx`）を編集するが、修正箇所が完全に別（#120: L389-L835, #121: L798-L818）
- #124 は別プロジェクト（`api/`）なので完全独立
- 一番シンプルな #120 から着手し、リスクの低い順に進める

---

## Issue #120: AI補正版コピー時に話者ラベル欠落

### ブランチ
```
fix/issue-120-corrected-speaker-labels
```

### 変更箇所

#### 1. `getTranscriptWithSpeakerLabels()` を拡張（L389-L406）

**Before**:
```typescript
const getTranscriptWithSpeakerLabels = () => {
    if (!recording?.transcript?.segments || recording.transcript.segments.length === 0) {
      return recording?.transcript?.fullText || "";
    }
    const hasSpeakerInfo = recording.transcript.segments.some(seg => seg.speaker);
    if (!hasSpeakerInfo) {
      return recording.transcript.fullText;
    }
    return recording.transcript.segments
      .map((seg) => {
        const label = seg.speaker || t("unknownSpeaker");
        return `[${label}] ${seg.text}`;
      })
      .join("\n");
};
```

**After**:
```typescript
const getTranscriptWithSpeakerLabels = (useCorrected?: boolean) => {
    const target = useCorrected ? recording?.correctedTranscript : recording?.transcript;
    if (!target?.segments || target.segments.length === 0) {
      return target?.fullText || "";
    }
    const hasSpeakerInfo = target.segments.some(seg => seg.speaker);
    if (!hasSpeakerInfo) {
      return target.fullText;
    }
    return target.segments
      .map((seg) => {
        const label = seg.speaker || t("unknownSpeaker");
        return `[${label}] ${seg.text}`;
      })
      .join("\n");
};
```

#### 2. コピーボタン onClick（L826-L833）

**Before**:
```typescript
onClick={() =>
  handleCopy(
    transcriptView === "corrected" && recording.correctedTranscript
      ? recording.correctedTranscript.fullText
      : getTranscriptWithSpeakerLabels(),
    "transcript"
  )
}
```

**After**:
```typescript
onClick={() =>
  handleCopy(
    getTranscriptWithSpeakerLabels(
      transcriptView === "corrected" && !!recording.correctedTranscript
    ),
    "transcript"
  )
}
```

### テスト手順
1. 話者識別ONで録音 → 保存 → 詳細画面
2. 「オリジナル」表示 → コピー → `[話者名] テキスト` 形式 ✅
3. 「AI補正版」表示 → コピー → `[話者名] テキスト` 形式 ✅
4. 話者識別OFFで録音 → コピー → プレーンテキスト ✅

---

## Issue #124: 「要約」テンプレートをシンプルに

### ブランチ
```
fix/issue-124-summary-template
```

### 変更箇所

#### 1. `TEMPLATE_PROMPTS` に "summary" キー追加（L143付近）

**追加コード**（`general` の前に挿入）:
```typescript
summary: `あなたは文字起こしを簡潔に要約する専門家です。
与えられた文字起こしテキストから、短く分かりやすい要約を作成してください。

出力は必ず以下のJSON形式で返してください：
{
  "overview": "内容の要約（100-200字程度）。何について話されたかを簡潔にまとめる",
  "keyPoints": [
    "重要なポイント1",
    "重要なポイント2",
    "重要なポイント3"
  ],
  "actionItems": []
}

要約作成の指示：
- 詳細な議事録ではなく、短い要約を作成
- keyPointsは3-5個程度に絞る
- 箇条書きは簡潔に（各20-50字程度）
- actionItemsは明確なものがあれば記載、なければ空配列
- 必ず有効なJSONで出力`,
```

#### 2. レスポンス構築の `overview` / `keyPoints` 優先順位修正（L360付近）

**Before**:
```typescript
overview: parsedSummary.meetingInfo?.purpose || parsedSummary.overview || "",
keyPoints: parsedSummary.agenda || parsedSummary.keyPoints || [],
```

**After**:
```typescript
overview: parsedSummary.overview || parsedSummary.meetingInfo?.purpose || "",
keyPoints: parsedSummary.keyPoints || parsedSummary.agenda || [],
```

### テスト手順
1. 「要約」テンプレート選択 → 生成 → シンプルな要約（overview + keyPoints）✅
2. 「議事録」テンプレート選択 → 生成 → 詳細フォーマット ✅
3. 他のテンプレートすべて → リグレッションなし ✅

---

## Issue #121: スマホ版 AI補正版UI改善

### ブランチ
```
fix/issue-121-mobile-correction-ui
```

### 変更箇所

#### 1. CardHeader レスポンシブ化（L798）

**Before**:
```tsx
<CardHeader className="flex flex-row items-center justify-between">
```

**After**:
```tsx
<CardHeader className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
```

#### 2. 左側 gap 調整（L799）

**Before**:
```tsx
<div className="flex items-center gap-4">
```

**After**:
```tsx
<div className="flex items-center gap-2 sm:gap-4">
```

#### 3. 切り替えタブ全幅化（L803）

**Before**:
```tsx
<div className="flex rounded-lg border p-1">
```

**After**:
```tsx
<div className="flex w-full rounded-lg border p-1 sm:w-auto">
```

#### 4. タブボタンの均等分割（L804, L811）

**Before**:
```tsx
<Button ... className="text-xs">
<Button ... className="gap-1 text-xs">
```

**After**:
```tsx
<Button ... className="flex-1 text-xs sm:flex-none">
<Button ... className="flex-1 gap-1 text-xs sm:flex-none">
```

### テスト手順（DevTools レスポンシブモード）
| 画面幅 | 確認 | 期待結果 |
|--------|------|---------|
| 375px | レイアウト | タイトル行とアクション行が縦並び |
| 375px | タブ | 全幅で均等分割、タッチしやすい |
| 768px | レイアウト | 横並びに切り替わる |
| 1024px | デスクトップ | 既存と同じ（リグレッションなし）|

---

## 全体ワークフロー

```
1. git checkout main && git pull origin main

2. [Issue #120]
   git checkout -b fix/issue-120-corrected-speaker-labels
   → 2箇所修正 → lint → commit → push → PR → CI → merge

3. git checkout main && git pull origin main

4. [Issue #124]
   git checkout -b fix/issue-124-summary-template
   → 2箇所修正 → lint → commit → push → PR → CI → merge

5. git checkout main && git pull origin main

6. [Issue #121]
   git checkout -b fix/issue-121-mobile-correction-ui
   → 4箇所修正 → lint → commit → push → PR → CI → merge
```

---

## リスクサマリー

| Issue | リスク | 確率 | 対策 |
|-------|--------|------|------|
| #120 | correctedTranscript.segments が null | Low | null チェック + fullText フォールバック |
| #124 | LLM が JSON 形式を守らない | Low | response_format: json_object 適用済み |
| #121 | デスクトップリグレッション | Low | sm: プレフィックスで既存保証 |

**総合判定**: **GO** ✅ — 3件すべて低リスクの修正。順次実装して即日デプロイ可能。
