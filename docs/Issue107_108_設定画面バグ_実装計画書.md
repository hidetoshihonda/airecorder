# Issue #107 + #108: 設定画面テーマ反映 + 録音設定フィードバック — 実装計画書

## 概要

| 項目 | 内容 |
|------|------|
| **対象Issue** | #107 (テーマ未反映), #108 (録音設定フィードバック不足) |
| **タイプ** | バグ修正 + UX改善 |
| **優先度** | P1 |
| **見積り** | 40分 |
| **影響範囲** | web/ 配下のみ（API変更なし） |
| **前提ブランチ** | `main` から `fix/issue-107-108-settings` を切る |

---

## Phase 1: テーマ機能の実装 (Issue #107)

### Step 1.1: `next-themes` パッケージのインストール

```bash
cd web && npm install next-themes
```

**理由**: `next-themes` はNext.js App Router対応のテーマ切替ライブラリ。`<html>` タグに `class="dark"` を付与し、SSRハイドレーション問題も自動回避する。

---

### Step 1.2: `web/src/app/globals.css` の修正

**変更内容**: ライトモード強制を削除し、Tailwind v4のクラスベースダークモードを有効化。ダークモード用CSS変数を追加。

**現在のコード（削除対象）**:
```css
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

/* Force light mode regardless of system preference */
body {
  background: #ffffff;
  color: #171717;
  font-family: Arial, Helvetica, sans-serif;
}
```

**修正後のコード**:
```css
@import "tailwindcss";

/* Tailwind v4: クラスベースのダークモードを有効化（next-themes連携） */
@custom-variant dark (&:where(.dark, .dark *));

:root {
  --background: #ffffff;
  --foreground: #171717;
}

.dark {
  --background: #0a0a0a;
  --foreground: #ededed;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-inter);
  --font-mono: var(--font-geist-mono);
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}
```

**ポイント**:
1. `@custom-variant dark (&:where(.dark, .dark *));` — Tailwind v4でクラスベースダークモードを有効化
2. `.dark { ... }` — ダークモード時のCSS変数を定義
3. `body` の `background` と `color` をCSS変数に変更（ハードコード削除）
4. `--font-sans` を `var(--font-inter)` に修正（Inter fontを正しく参照）

---

### Step 1.3: `web/src/components/providers/Providers.tsx` の修正

**変更内容**: `next-themes` の `ThemeProvider` を追加。

**現在のコード**:
```tsx
"use client";

import { ReactNode } from "react";
import { AuthProvider } from "@/contexts/AuthContext";
import { RecordingProvider } from "@/contexts/RecordingContext";
import { I18nProvider } from "@/contexts/I18nContext";
import { TooltipProvider } from "@/components/ui/tooltip";

interface ProvidersProps {
  children: ReactNode;
}

export function Providers({ children }: ProvidersProps) {
  return (
    <AuthProvider>
      <I18nProvider>
        <RecordingProvider>
          <TooltipProvider>{children}</TooltipProvider>
        </RecordingProvider>
      </I18nProvider>
    </AuthProvider>
  );
}
```

**修正後のコード**:
```tsx
"use client";

import { ReactNode } from "react";
import { ThemeProvider } from "next-themes";
import { AuthProvider } from "@/contexts/AuthContext";
import { RecordingProvider } from "@/contexts/RecordingContext";
import { I18nProvider } from "@/contexts/I18nContext";
import { TooltipProvider } from "@/components/ui/tooltip";

interface ProvidersProps {
  children: ReactNode;
}

export function Providers({ children }: ProvidersProps) {
  return (
    <ThemeProvider attribute="class" defaultTheme="system" enableSystem>
      <AuthProvider>
        <I18nProvider>
          <RecordingProvider>
            <TooltipProvider>{children}</TooltipProvider>
          </RecordingProvider>
        </I18nProvider>
      </AuthProvider>
    </ThemeProvider>
  );
}
```

**ポイント**:
1. `attribute="class"` — `<html class="dark">` でダークモードを適用（Tailwind連携）
2. `defaultTheme="system"` — デフォルトはOSのテーマ設定に従う
3. `enableSystem` — `prefers-color-scheme` メディアクエリ対応
4. `ThemeProvider` は最外層に配置（`AuthProvider` より外側）— テーマはログイン状態に依存しないため

---

### Step 1.4: `web/src/app/settings/page.tsx` のテーマ同期

**変更内容**: `next-themes` の `useTheme()` と `settings.theme` を双方向同期。

**追加するimport**:
```tsx
import { useTheme } from "next-themes";
```

**追加するロジック**（コンポーネント内、既存のhooksの直後）:
```tsx
// next-themes との同期
const { setTheme, resolvedTheme } = useTheme();

// settings.theme が変更されたら next-themes に反映
useEffect(() => {
  if (settingsLoaded) {
    setTheme(settings.theme);
  }
}, [settings.theme, settingsLoaded, setTheme]);
```

**テーマSelectの修正**: 既存の `onValueChange` は `updateSettings({ theme: value })` を呼ぶだけで良い。
`useEffect` が `settings.theme` の変更を検知して `setTheme()` を呼ぶので、自動的に同期される。

> **注意**: `settingsLoaded` を依存に入れることで、localStorageからの初期読み込み完了後にテーマが適用される。

---

### Step 1.5: テーマの初期適用（全画面共通）

**問題**: 設定画面以外のページでも、保存済みテーマを適用する必要がある。

**対応**: `AuthContext` でテーマの初期適用を行う新しい `useEffect` を追加するか、`Providers.tsx` 内で `ThemeSync` コンポーネントを作成する。

**推奨: ThemeSyncコンポーネント方式**

`web/src/components/providers/ThemeSync.tsx` を新規作成:
```tsx
"use client";

import { useEffect } from "react";
import { useTheme } from "next-themes";
import { useAuth } from "@/contexts/AuthContext";

/**
 * settings.theme と next-themes を全画面で同期するコンポーネント。
 * Providers.tsx 内で AuthProvider の子として配置する。
 */
export function ThemeSync() {
  const { settings, settingsLoaded } = useAuth();
  const { setTheme } = useTheme();

  useEffect(() => {
    if (settingsLoaded) {
      setTheme(settings.theme);
    }
  }, [settings.theme, settingsLoaded, setTheme]);

  return null;
}
```

**Providers.tsx での使用**:
```tsx
<ThemeProvider attribute="class" defaultTheme="system" enableSystem>
  <AuthProvider>
    <ThemeSync />
    <I18nProvider>
      ...
    </I18nProvider>
  </AuthProvider>
</ThemeProvider>
```

---

### Step 1.6: Header/Footer のダークモード対応

**現状**: Header と Footer に `dark:` プレフィックスがないため、ダークモードで背景・文字色が不適切になる。

**Header.tsx L39**:
```tsx
// 現在
<header className="sticky top-0 z-50 w-full border-b border-gray-200 bg-white">
// 修正
<header className="sticky top-0 z-50 w-full border-b border-gray-200 bg-white dark:border-gray-700 dark:bg-gray-900">
```

**Footer.tsx L13**:
```tsx
// 現在
<footer className="border-t border-gray-200 bg-white">
// 修正
<footer className="border-t border-gray-200 bg-white dark:border-gray-700 dark:bg-gray-900">
```

**Header内のテキスト色**:
```tsx
// 現在
<span className="text-xl font-bold text-gray-900">AI Recorder</span>
// 修正
<span className="text-xl font-bold text-gray-900 dark:text-white">AI Recorder</span>
```

他にも `text-gray-600`, `text-gray-900`, `bg-gray-100`, `hover:bg-gray-50` 等のクラスにそれぞれ `dark:` 対応を追加。

> **注意**: 全コンポーネントの完全ダークモード対応は Phase 2 以降。Phase 1 ではまず Header/Footer/Settings の主要UIのみ。

---

### Step 1.7: Settings ページのダークモード対応

**設定画面** `settings/page.tsx` にハードコードされた色を `dark:` 対応する:

```tsx
// 現在
<h1 className="text-2xl font-bold text-gray-900">{t("title")}</h1>
// 修正
<h1 className="text-2xl font-bold text-gray-900 dark:text-white">{t("title")}</h1>

// 現在
<p className="mt-1 text-gray-600">{t("description")}</p>
// 修正
<p className="mt-1 text-gray-600 dark:text-gray-400">{t("description")}</p>

// label要素
// 現在: text-gray-700
// 修正: text-gray-700 dark:text-gray-300
```

> **スコープ**: Phase 1 では主要要素（見出し・説明・ラベル）のみ。Card/Select等はshadcn/uiの内部スタイルにCSS変数が使われていれば自動対応される。

---

## Phase 2: 録音設定の実効化 + フィードバック (Issue #108)

### Step 2.1: `useAudioRecorder` に `audioQuality` オプション追加

**ファイル**: `web/src/hooks/useAudioRecorder.ts`

**interface修正**:
```typescript
// 現在
interface UseAudioRecorderOptions {
  /** 共有 MediaStream（指定時はこのストリームを使用し、独自に getUserMedia を呼ばない） */
  sharedStream?: MediaStream | null;
}

// 修正後
interface UseAudioRecorderOptions {
  /** 共有 MediaStream（指定時はこのストリームを使用し、独自に getUserMedia を呼ばない） */
  sharedStream?: MediaStream | null;
  /** 音声品質設定。MediaRecorder の audioBitsPerSecond にマッピングされる */
  audioQuality?: "low" | "medium" | "high";
}
```

**ビットレートマッピング定数を追加**（ファイル先頭、interface の前）:
```typescript
/** 音声品質 → audioBitsPerSecond マッピング */
const QUALITY_BITRATE_MAP: Record<string, number> = {
  low: 32000,      // 32kbps
  medium: 128000,  // 128kbps
  high: 256000,    // 256kbps
};
```

**options destructuring の修正**:
```typescript
// 現在
const { sharedStream = null } = options;

// 修正後
const { sharedStream = null, audioQuality = "high" } = options;
```

**MediaRecorder 生成の修正** (L100付近):
```typescript
// 現在
const mediaRecorder = new MediaRecorder(audioStream, { mimeType });

// 修正後
const audioBitsPerSecond = QUALITY_BITRATE_MAP[audioQuality] || 128000;
const mediaRecorder = new MediaRecorder(audioStream, { 
  mimeType,
  audioBitsPerSecond,
});
```

---

### Step 2.2: `page.tsx` から `audioQuality` を渡す

**ファイル**: `web/src/app/page.tsx` L129-138

**現在のコード**:
```tsx
const {
  duration,
  audioBlob,
  error: audioError,
  startRecording: startAudioRecording,
  stopRecording: stopAudioRecording,
  pauseRecording: pauseAudioRecording,
  resumeRecording: resumeAudioRecording,
  resetRecording: resetAudioRecording,
} = useAudioRecorder();
```

**修正後のコード**:
```tsx
const {
  duration,
  audioBlob,
  error: audioError,
  startRecording: startAudioRecording,
  stopRecording: stopAudioRecording,
  pauseRecording: pauseAudioRecording,
  resumeRecording: resumeAudioRecording,
  resetRecording: resetAudioRecording,
} = useAudioRecorder({ audioQuality: settings.audioQuality });
```

> `settings` は既に `useAuth()` から取得されている（確認が必要）。

**確認**: `page.tsx` で `useAuth()` が使われているか確認し、`settings` を取得する必要がある。

---

### Step 2.3: 「設定を保存」ボタンの改善

**ファイル**: `web/src/app/settings/page.tsx`

**方針**: 各設定は `updateSettings()` で即時保存されるため、「設定を保存」ボタンは不要。しかし、ユーザーに「保存されている」という安心感を与えるため、以下のアプローチを取る:

#### オプションA: ボタンを削除し、自動保存バッジを表示（推奨）

**削除するコード** (L120-126):
```tsx
const handleSave = async () => {
    setIsSaving(true);
    // TODO: Save settings to backend
    await new Promise((resolve) => setTimeout(resolve, 1000));
    setIsSaving(false);
  };
```

**削除するUI** (L504-510):
```tsx
{/* Save Button */}
<div className="flex justify-end">
  <Button onClick={handleSave} disabled={isSaving} className="gap-2">
    <Save className="h-4 w-4" />
    {isSaving ? t("saving") : t("saveSettings")}
  </Button>
</div>
```

**代替**: ページ上部に「設定は自動的に保存されます」バッジを表示:
```tsx
<div className="mb-8">
  <h1 className="text-2xl font-bold text-gray-900 dark:text-white">{t("title")}</h1>
  <p className="mt-1 text-gray-600 dark:text-gray-400">{t("description")}</p>
  <p className="mt-2 text-xs text-green-600 dark:text-green-400 flex items-center gap-1">
    <Check className="h-3 w-3" />
    {t("autoSaveNote")}
  </p>
</div>
```

#### オプションB: トースト通知を追加

`updateSettings()` の呼び出し後に一時的なトースト通知「✓ 保存しました」を表示。
ただし、shadcn/uiの `toast` コンポーネントが未導入のため、シンプルな `useState` ベースの通知を使用。

```tsx
const [showSaved, setShowSaved] = useState(false);

const handleSettingChange = (newSettings: Partial<UserSettings>) => {
  updateSettings(newSettings);
  setShowSaved(true);
  setTimeout(() => setShowSaved(false), 2000);
};
```

**UI**:
```tsx
{showSaved && (
  <div className="fixed bottom-4 right-4 z-50 rounded-lg bg-green-600 px-4 py-2 text-sm text-white shadow-lg transition-opacity">
    ✓ {t("settingsSaved")}
  </div>
)}
```

**推奨**: **オプションAとBを組み合わせる**。ボタンを削除 + 自動保存バッジ + 変更時のトースト通知。

---

### Step 2.4: i18n キーの追加

**3ファイル共通で追加**: `web/messages/ja.json`, `en.json`, `es.json`

`SettingsPage` セクションに追加するキー:

```json
"autoSaveNote": "設定は変更時に自動保存されます",
"settingsSaved": "設定を保存しました"
```

**英語** (`en.json`):
```json
"autoSaveNote": "Settings are automatically saved when changed",
"settingsSaved": "Settings saved"
```

**スペイン語** (`es.json`):
```json
"autoSaveNote": "Los ajustes se guardan automáticamente al cambiar",
"settingsSaved": "Ajustes guardados"
```

**不要になるキー** (削除は任意、残しても害はない):
- `"saving"` — 保存ボタン削除に伴い不要
- `"saveSettings"` — 同上

---

## Phase 3: ダークモード全画面対応（優先度P2、別Issue推奨）

### 対象コンポーネント一覧

Header/Footer以外で `dark:` 対応が必要なコンポーネント:

| ファイル | 優先度 | 概要 |
|---------|--------|------|
| `page.tsx` | High | メイン録音画面。最も使用頻度が高い |
| `history/page.tsx` | Medium | 録音履歴一覧 |
| `recording/[id]/page.tsx` | Medium | 録音詳細 |
| `TranscriptView.tsx` | Medium | 文字起こし表示 |
| `ui/` 各コンポーネント | Low | shadcn/uiはCSS変数ベースなので対応しやすい |

> Phase 1 ではテーマ切替の仕組みを実装するだけで、全画面の `dark:` 対応は Phase 3 で別Issue (#XXX) として管理する。

---

## 変更ファイル一覧

### 新規ファイル
| ファイル | 説明 |
|---------|------|
| `web/src/components/providers/ThemeSync.tsx` | settings.theme ↔ next-themes 同期 |

### 修正ファイル
| ファイル | 変更内容 |
|---------|---------|
| `web/package.json` | `next-themes` 追加 |
| `web/src/app/globals.css` | ライトモード強制削除、ダークモードCSS変数追加、`@custom-variant dark` 追加 |
| `web/src/components/providers/Providers.tsx` | `ThemeProvider` + `ThemeSync` 追加 |
| `web/src/app/settings/page.tsx` | `useTheme` 同期、ダミーボタン削除、自動保存バッジ、トースト通知、`dark:` クラス追加 |
| `web/src/hooks/useAudioRecorder.ts` | `audioQuality` オプション追加、`audioBitsPerSecond` 設定 |
| `web/src/app/page.tsx` | `useAudioRecorder` に `audioQuality` を渡す |
| `web/src/components/layout/Header.tsx` | `dark:` クラス追加 |
| `web/src/components/layout/Footer.tsx` | `dark:` クラス追加 |
| `web/messages/ja.json` | `autoSaveNote`, `settingsSaved` キー追加 |
| `web/messages/en.json` | 同上 |
| `web/messages/es.json` | 同上 |

---

## テスト手順

### テーマ切替テスト
1. 設定画面でテーマを「ダーク」に変更 → 即座に背景が暗くなる
2. テーマを「ライト」に変更 → 即座に背景が明るくなる
3. テーマを「システム」に変更 → OSの設定に従う
4. テーマを「ダーク」に設定 → ページ遷移（トップ → 履歴 → 設定）→ 全画面でダークモード維持
5. テーマを「ダーク」に設定 → ブラウザリロード → ダークモード維持（フラッシュなし）
6. テーマを「ダーク」に設定 → ログアウト → ログイン → ダークモード維持

### 音声品質テスト
1. 設定で音声品質を「低(32kbps)」に設定 → 録音 → ファイルサイズを確認
2. 設定で音声品質を「高(256kbps)」に設定 → 録音 → ファイルサイズが「低」より大きいことを確認

### フィードバックテスト
1. 任意の設定を変更 → 「✓ 設定を保存しました」トースト表示を確認
2. 「設定を保存」ボタンが表示されないことを確認
3. 「設定は自動保存されます」のバッジが表示されていることを確認

---

## 実装順序

| # | 作業 | 時間 | 依存 |
|---|------|------|------|
| 1 | `npm install next-themes` | 1分 | なし |
| 2 | `globals.css` 修正 | 3分 | なし |
| 3 | `ThemeSync.tsx` 新規作成 | 2分 | #1 |
| 4 | `Providers.tsx` 修正 | 2分 | #1, #3 |
| 5 | `Header.tsx` dark: 対応 | 5分 | #2 |
| 6 | `Footer.tsx` dark: 対応 | 3分 | #2 |
| 7 | `settings/page.tsx` テーマ同期 + UI改善 | 10分 | #1, #2, #4 |
| 8 | `useAudioRecorder.ts` audioQuality 対応 | 3分 | なし |
| 9 | `page.tsx` audioQuality 渡す | 2分 | #8 |
| 10 | i18n キー追加 (3ファイル) | 3分 | なし |
| 11 | ビルド確認 | 3分 | all |
| 12 | テスト | 5分 | #11 |

**合計**: 約42分

---

## リスクと対策

| リスク | 確率 | 影響 | 対策 |
|--------|------|------|------|
| ハイドレーションフラッシュ（一瞬ライトモードが見える） | 低 | 低 | `next-themes` の `suppressHydrationWarning` で対応済み。`defaultTheme="system"` + scriptインジェクションでSSR時にもテーマが適用される |
| Tailwind v4 の `@custom-variant` が動かない | 低 | 高 | Tailwind v4公式ドキュメントに記載の正式な方法。ビルド時に確認 |
| `audioBitsPerSecond` 未対応ブラウザ | 低 | 低 | 未対応の場合はブラウザのデフォルトビットレートにフォールバック（MediaRecorder仕様） |
| Static Export (`output: "export"`) と `next-themes` の互換性 | 低 | 高 | `next-themes` はクライアントサイドのみで動作するため、static exportと互換。`suppressHydrationWarning` で対応 |
| 既存の `dark:` クラスがダークモード有効化後に予期しない表示 | 中 | 中 | 既に散在する `dark:` クラスが活性化する。主要画面を手動確認し、問題があれば修正 |

---

## 判定: `GO` ✅

リスクは低く、技術的に確立された方法で実装可能。`next-themes` + Tailwind v4 `@custom-variant` の組み合わせは公式にサポートされた手法。

---

*作成日: 2025-02-13*  
*作成者: ReviewAAgent*
