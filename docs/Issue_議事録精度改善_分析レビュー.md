# 議事録精度改善 — 分析レビュー

## 1. エグゼクティブサマリー

- **問題の本質**: 現行の議事録生成は、1時間超の長時間会議に対して「3トピック・2アクションアイテム」程度の表面的な要約しか出力できない。理想は10+トピック・5+アクションアイテムの**詳細議事録**であり、現状との乖離は極めて大きい。
- **影響範囲**: 全ユーザーの議事録生成品質に直結（100%のユーザーに影響）
- **修正の緊急度**: **Critical** — プロダクトの中核価値（会議の記録品質）が毀損されている

---

## 2. アーキテクチャ概観

### コンポーネント依存関係

```
[Frontend: page.tsx / recording/page.tsx]
  │
  │ POST /api/summary/generate
  │  { transcript, language, templateId }
  │
  ▼
[API: summary.ts]
  │
  │ resolveSystemPrompt(templateId) → TEMPLATE_PROMPTS["general"]
  │ + JSON_FORMAT 定数
  │
  ▼
[Azure OpenAI: gpt-5-mini]
  │  model: deploymentName
  │  temperature: 0.3
  │  max_tokens: 8000
  │  response_format: { type: "json_object" }
  │
  ▼
[JSON Parse → SummaryResponse 構築]
  │
  ▼
[Frontend: レンダリング / コピー関数]
```

### データフロー

```
文字起こし(segments[]) 
  → fullText / "[Speaker] text" 形式文字列
  → API POST body.transcript
  → systemPrompt + userContent("以下の文字起こしテキストから議事録を作成してください：\n\n{transcript}")
  → Azure OpenAI → JSON文字列
  → JSON.parse → SummaryResponse構築
  → フロントエンド表示
```

---

## 3. 重大バグ分析 🔴

### BUG-1: recording/page.tsx は話者ラベル無しの fullText を送信している 【Critical】

**場所**: `web/src/app/recording/page.tsx` L528

**コード**:
```typescript
const response = await summaryApi.generateSummary({
  transcript: recording.transcript.fullText,  // ← 話者ラベルなし
  language: languageToUse,
  templateId: templateToUse,
});
```

**問題**: History画面から議事録を生成する場合、`recording.transcript.fullText` がそのまま送信される。これは話者ラベル（`[Guest-1]`, `[Guest-2]`）が**含まれない**プレーンテキストである可能性が高い。一方、`page.tsx`（ホーム画面）では L475-477 で話者情報を付与した文字列を構築している。

**影響**: History画面から生成した議事録では「誰が何を言ったか」の情報が完全に失われ、LLMが参加者名を捏造する原因になる（現状の出力で「田中（PM）」「佐藤（エンジニア）」等の架空の名前が出ている）。

**根本原因**: `page.tsx` の話者ラベル付与ロジックが `recording/page.tsx` に移植されていない。

**修正方針**: `recording/page.tsx` でも `getTranscriptWithSpeakerLabels()` 関数（L445に既に存在）を使い、話者ラベル付きのトランスクリプトを送信する。

---

### BUG-2: max_tokens: 8000 では長時間会議の詳細議事録に不十分 【Critical】

**場所**: `api/src/functions/summary.ts` L377

**コード**:
```typescript
const response = await client.chat.completions.create({
  model: deploymentName,
  temperature: 0.3,
  max_tokens: 8000,
  response_format: { type: "json_object" },
});
```

**問題**: ユーザーの理想の議事録は約 **4,000文字**（日本語、10セクション・詳細記述）。JSON構造のオーバーヘッド（キー名、エスケープ、整形）を含めると **8,000〜12,000トークン** が必要。`max_tokens: 8000` ではトークン上限に到達し、JSONが途中で切れるか、LLMが自ら内容を省略して短くする。

**影響**: LLMが「要約を短くまとめよう」と判断し、3トピック・2アクションアイテムに圧縮してしまう。これが現状の「薄い議事録」の主因。

**根本原因**: gpt-5-mini の出力トークン上限は16,384だが、max_tokens: 8000 に制限している。長文の詳細議事録には不足。

**修正方針**: `max_tokens` を **16000** に引き上げる。または `max_completion_tokens` パラメータを使用する（モデルによる）。

---

### BUG-3: プロンプトが「詳細さ」を十分に指示していない 【Critical】

**場所**: `api/src/functions/summary.ts` L175-196 (`TEMPLATE_PROMPTS["general"]`)

**コード（現在のgeneralプロンプト）**:
```
あなたは最強の議事録作成者です。
以下の会議ログ（発話の羅列/文字起こし/メモ）から、「詳細な議事録（ドラフト）」を作成してください。

# 出力要件（必須）
- 事実ベースで、会議で合意した内容・未決事項・宿題を明確に分ける
- 時系列の流れが追えるように整理しつつ、最後に決定事項/アクションをまとめる
- ...
```

**問題**: プロンプトは「詳細な議事録」と言っているが、以下の具体的な指示が欠落：

1. **「全ての話題を漏れなく網羅せよ」という明示的指示がない** → LLMが主要3件だけ拾って終わる
2. **topics の content に書く分量の指示がない**（「200-500字/トピック」等の具体的長さ指示が必要）
3. **actionItems の粒度指示がない** → 1-2件の大枠で終わる（理想は担当者別・案件別に5-10件）
4. **会議の長さに応じた出力スケール指示がない** → 1時間の会議でも5分の会議でも同じ薄い出力
5. **JSON_FORMAT のサンプルが短い** → LLMがサンプルの長さに引っ張られて短い出力を生成

**影響**: 全ユーザーの全テンプレートで、議事録が表面的な要約止まりになる。

**根本原因**: プロンプトエンジニアリングの不足。LLMに「長く書け」「全部拾え」と明示しないと、LLMはデフォルトで要約的に短くまとめる傾向がある。

**修正方針**: プロンプトを大幅改修。後述の Phase 1 で具体案を提示。

---

### BUG-4: JSON_FORMAT のサンプルが短すぎてLLMのアンカリングバイアスを誘発 【High】

**場所**: `api/src/functions/summary.ts` L83-147 (`JSON_FORMAT` 定数)

**問題**: JSON_FORMAT のサンプル内で:

```json
"topics": [
  {
    "title": "論点の小見出し",
    "content": "時系列で議論の流れを記述する。..."
  }
]
```

topics 配列の要素が **1つだけ**。LLMはサンプルの構造に強くアンカリングされるため、「1〜3トピック程度で十分」と解釈する。同様に `decisions` 2件、`actionItems` 1件、`qaItems` 1件しかサンプルにない。

**影響**: LLMが出力するトピック数・アクションアイテム数がサンプルに近い少数に収束する。

**根本原因**: Few-shot プロンプトのサンプルがミニマルすぎる。

**修正方針**: JSON_FORMAT のサンプルに複数要素（3-5件）を含めるか、「※実際の出力では会議の内容に応じて10件以上になることがあります」等の注記を追加。

---

### BUG-5: 参加者名をLLMが捏造する 【High】

**場所**: `api/src/functions/summary.ts` L92-95 (JSON_FORMAT の meetingInfo サンプル)

**コード**:
```json
"participants": ["田中（PM）", "佐藤（エンジニア）", "鈴木（お客様側）"]
```

**問題**: JSON_FORMAT のサンプルに具体的な架空の参加者名がハードコードされている。LLMはこのサンプルに引っ張られ、トランスクリプトに名前がなくても「田中（PM）」「佐藤（エンジニア）」等を出力する。

**影響**: 現状の出力で実際に「田中（PM）, 佐藤（エンジニア）, 鈴木（お客様側）」がそのまま出力されている（ユーザーの報告通り）。これは完全な捏造であり、議事録の信頼性を毀損する。

**根本原因**: サンプル値とプレースホルダーの区別がLLMに伝わっていない。

**修正方針**: サンプルを `"Guest-1", "Guest-2"` 等のプレースホルダー表記に変更し、「参加者名は文字起こしの発話ラベルから抽出すること。推測で名前を付けないこと」というルールを追加。

---

### BUG-6: ユーザーメッセージの指示が弱すぎる 【Medium】

**場所**: `api/src/functions/summary.ts` L372-375

**コード**:
```typescript
{
  role: "user",
  content: `以下の文字起こしテキストから議事録を作成してください：\n\n${body.transcript}`,
}
```

**問題**: ユーザーメッセージが一行の短い指示のみ。会議の長さ（トランスクリプトの文字数/行数）に応じた動的な指示がない。例えば、「このトランスクリプトは約X行/Y文字あります。全ての話題を漏れなく網羅した詳細な議事録を作成してください」のような補足がない。

**影響**: LLMが入力の長さを考慮せず、常に同じ短さの出力を返す。

**修正方針**: ユーザーメッセージに動的なコンテキスト（行数、推定会議時間等）を付加。

---

## 4. 設計上の問題 🟡

### DESIGN-1: recording/page.tsx と page.tsx の議事録生成ロジックが重複・不一致

**場所**: 
- `web/src/app/page.tsx` L464-495
- `web/src/app/recording/page.tsx` L518-548

**問題**: 両ファイルで `handleGenerateSummary` が独立に実装されており、`page.tsx` にある「話者ラベル付与ロジック」が `recording/page.tsx` に存在しない。共通のカスタムフック（例: `useSummaryGeneration`）に抽出すべき。

**優先度**: Medium

---

### DESIGN-2: プロンプトのバージョン管理がない

**問題**: `TEMPLATE_PROMPTS` と `JSON_FORMAT` がソースコードにハードコードされており、プロンプトの改善をA/Bテストしたり、ロールバックする仕組みがない。

**優先度**: Low（今後のイテレーションで検討）

---

### DESIGN-3: LLM出力の品質評価メカニズムがない

**問題**: LLMが返した議事録の品質（トピック数、文字数、アクションアイテム数等）を自動評価し、品質が低い場合にリトライする仕組みがない。

**優先度**: Low（Phase 3 で検討）

---

## 5. 現在の出力 vs 理想の出力 — ギャップ分析 📊

| 項目 | 現状の出力 | 理想の出力 | ギャップ |
|------|-----------|-----------|---------|
| **会議情報 - 参加者** | 捏造された名前（田中、佐藤、鈴木） | Guest-1, Guest-2（トランスクリプトの実際のラベル） | 🔴 Critical - 完全な誤り |
| **会議情報 - 目的** | 「チームの進捗状況と今後の課題について議論するための定例会議」（汎用的） | 「直近のワークロード/体制見通しの共有、クローズ判断が難しい案件の方針決め、進行停滞案件の次アクション整理」 | 🔴 具体性が完全に不足 |
| **アジェンダ** | 3項目 | 実質10+の話題（体制、個別顧客案件5件以上、技術検証等） | 🔴 網羅性が大幅に不足 |
| **トピック数** | 3件 | 10件以上 | 🔴 Critical - 7件以上欠落 |
| **トピックの詳細度** | 各2-3行 | 各10-30行（具体的発言・数値・固有名詞含む） | 🔴 Critical - 情報量が1/10以下 |
| **決定事項** | 2件（汎用的） | 5件（具体的な案件名・日時・方針含む） | 🟡 不足 |
| **アクションアイテム** | 2件（担当者も架空名） | 5件以上（Guest-1/Guest-2別、具体的タスク・期限含む） | 🔴 Critical |
| **Q&A** | 1件 | 理想では独立セクションなし（トピック内で処理） | 🟡 |
| **リスク/懸念** | なし | 4件の具体的リスクと対策 | 🟡 JSONフォーマットに項目なし |
| **固有名詞** | ほぼなし | 若崎様、渋沢様、石川様、SR4526、PKI289等 | 🔴 Critical - 全て欠落 |
| **出力文字数** | 約800字 | 約4,000字 | 🔴 5倍の差 |

---

## 6. 根本原因の総合分析

### 原因の優先順位

| # | 原因 | 寄与度 | 修正難易度 |
|---|------|--------|-----------|
| 1 | **プロンプトが「詳細さ」「網羅性」を十分に指示していない** | 40% | 低（テキスト変更のみ） |
| 2 | **max_tokens が不足（8000）で LLM が自己圧縮する** | 25% | 低（数値変更のみ） |
| 3 | **JSON_FORMAT のサンプルが短く、LLMがアンカリングされる** | 15% | 低（テキスト変更のみ） |
| 4 | **参加者名のサンプルが捏造を誘発** | 10% | 低（テキスト変更のみ） |
| 5 | **recording/page.tsx が話者ラベルなし fullText を送信** | 5% | 低（既存関数を利用） |
| 6 | **ユーザーメッセージに動的コンテキストがない** | 5% | 低（テンプレートリテラル追加） |

---

## 7. 修正提案（優先順位付き）

### Phase 1: プロンプト抜本改修（P0）

#### 1-1. `TEMPLATE_PROMPTS["general"]` の全面改修

**修正方針**: 以下の要素を追加/強化する

```typescript
const TEMPLATE_PROMPTS_general = `あなたは最強の議事録作成者です。
以下の会議ログ（発話の羅列/文字起こし/メモ）から、「**網羅的で詳細な議事録**」を作成してください。

# 最重要ルール（必ず守ること）
1. **全ての話題を漏れなく網羅する**。会議で触れられた話題は、たとえ短い言及でも独立した topic として記録する
2. **各 topic の content は最低200字以上**（短い話題でも背景・文脈・結論を丁寧に記述）
3. **固有名詞（人名・顧客名・プロジェクト名・チケット番号・数値・日時）は全て拾う**
4. **参加者名は文字起こしのラベル（Guest-1等）をそのまま使う。推測で名前を付けない**
5. **情報を省略しない**。会議で話された内容は全て議事録に反映する

# 出力要件（必須）
- 事実ベースで、合意事項・未決事項・宿題を明確に分ける
- 時系列の流れが追えるように整理する
- 聞き取りづらい・曖昧な箇所は断定せず「（要確認）」として残す
- 固有名詞は文字起こしの表現を尊重し、曖昧なら「◯◯（要確認）」とする
- 可能な範囲でQ&A形式を抽出する
- 文体はビジネス向け、箇条書きと文章を適切に組み合わせる

# 品質基準（目安）
- 1時間の会議 → topics 8〜15件、actionItems 5〜10件
- 30分の会議 → topics 4〜8件、actionItems 3〜5件
- 15分の会議 → topics 2〜4件、actionItems 1〜3件
- 各 topic の content は、第三者が読んでも議論の文脈と結論が理解できる詳細さにする

# フォーマット（この見出し順で必ず出す）
1. 会議情報（会議名/開催形式/目的）
2. 参加者（文字起こしのラベルそのまま。役割が推測できる場合は補記）
3. 議題・論点（全話題を箇条書き。漏れなく列挙）
4. 主要な会話内容（全話題を時系列で。各話題に小見出し＋詳細記述）
5. 決定事項（合意したこと全て）
6. 宿題・アクションアイテム（担当/期限/関連背景。全て列挙）
7. 質疑応答（主なQ&A）
8. 次回に向けた進め方（Next Steps）

# 追加ルール
- 重要な数値・期間・時間帯は **太字** にする
- 個別の顧客案件やチケットについて議論があった場合、それぞれ独立した topic にする
- 担当者間の役割分担についての議論は具体的に記録する
- 懸念やリスクに関する発言は漏らさず記録する
- 根拠のない推測は書かない`;
```

#### 1-2. `JSON_FORMAT` の改修

**修正方針**: サンプルの要素数を増やし、「省略禁止」の明示的注記を追加

```
主な変更点:
- participants サンプルを "Guest-1", "Guest-2" に変更
- topics サンプルを 3件に増やし、content を長文サンプルに
- "※上記はサンプルです。実際の出力では会議内容に応じて topics は10件以上、actionItems は5件以上になることがあります" を追加
- 各フィールドの書き方ガイドを強化
```

#### 1-3. `max_tokens` を 16000 に引き上げ

**場所**: `api/src/functions/summary.ts` L377

#### 1-4. recording/page.tsx で話者ラベル付きトランスクリプトを送信

**場所**: `web/src/app/recording/page.tsx` L527-528

**修正**: `recording.transcript.fullText` の代わりに `getTranscriptWithSpeakerLabels()` を使用

#### 1-5. ユーザーメッセージの強化

**修正**: transcriptの行数・文字数を動的に含め、「全ての話題を網羅した詳細な議事録を作成してください」と明示

```typescript
{
  role: "user",
  content: `以下は会議の文字起こしです（約${body.transcript.split('\n').length}発話、約${body.transcript.length}文字）。
全ての話題を漏れなく網羅した詳細な議事録を作成してください。情報を省略しないでください。

---
${body.transcript}`,
}
```

### Phase 2: 構造改善（P1）

#### 2-1. JSON_FORMAT にリスク/懸念セクションを追加

理想の議事録にある「リスク/懸念と対策メモ」は現在のフォーマットに存在しない。以下を追加検討:

```json
"risks": [
  {
    "risk": "リスクの内容",
    "mitigation": "対策"
  }
]
```

#### 2-2. recording/page.tsx と page.tsx の共通ロジック抽出

`handleGenerateSummary` のトランスクリプト準備ロジックを共通ユーティリティに抽出。

### Phase 3: 堅牢性強化（P2）

#### 3-1. 出力品質の自動チェック

LLM出力のパース後に品質指標をチェック:
- topics数が 0 の場合は警告
- actionItems数が 0 の場合は警告
- total content length が閾値以下の場合は警告（将来的にリトライ）

#### 3-2. 長文トランスクリプトの分割処理

将来的に、非常に長い会議（2時間以上）では input token limit に達する可能性があるため、チャンク分割 → マージの仕組みを検討。

---

## 8. テスト戦略

### 手動テスト

| テストケース | 入力 | 期待結果 |
|-------------|------|---------|
| 長時間会議（1h+） | ユーザー提供の文字起こし（約300行） | topics 8件以上、actionItems 5件以上、参加者が Guest-1/Guest-2 |
| 短い会議（15分） | 50行程度の文字起こし | topics 2-4件、適切な詳細度 |
| 話者ラベルあり（History） | recording/page.tsx から生成 | 話者ラベルが正しく反映される |
| 話者ラベルなし | 話者分離OFFの録音 | 参加者名が捏造されない（「不明」等） |

### 品質評価基準

| 指標 | 現状 | 目標 |
|------|------|------|
| トピック網羅率 | 約30%（10話題中3件） | 90%以上 |
| 固有名詞抽出率 | 約0% | 80%以上 |
| 参加者名の正確性 | 0%（捏造） | 100%（文字起こしラベル通り） |
| 出力文字数（1h会議） | 約800字 | 3,000〜5,000字 |
| アクションアイテム数（1h会議） | 2件 | 5〜10件 |

---

## 9. 実装ロードマップ

| Step | 作業内容 | 見積り | 影響範囲 |
|------|---------|--------|---------|
| 1 | `TEMPLATE_PROMPTS["general"]` プロンプト全面改修 | 30分 | `api/src/functions/summary.ts` |
| 2 | `JSON_FORMAT` のサンプル拡充・注記追加 | 20分 | `api/src/functions/summary.ts` |
| 3 | `max_tokens` を 16000 に引き上げ | 5分 | `api/src/functions/summary.ts` |
| 4 | ユーザーメッセージの動的強化 | 10分 | `api/src/functions/summary.ts` |
| 5 | `recording/page.tsx` の話者ラベル付きトランスクリプト送信 | 15分 | `web/src/app/recording/page.tsx` |
| 6 | テスト・検証（手動） | 30分 | - |
| **合計** | | **約2時間** | |

---

## 10. リスクアセスメント

| リスク | 確率 | 影響度 | 対策 |
|--------|------|--------|------|
| max_tokens増加によるAPIコスト増 | 高 | 低 | 出力が長くなる分コスト増加するが、品質向上のトレードオフとして許容。gpt-5-miniは安価 |
| プロンプト変更によるJSON構造の崩れ | 低 | 高 | `response_format: { type: "json_object" }` により JSON 出力は保証。パース後のバリデーションで安全策 |
| 出力が長すぎてフロントエンドの表示に問題 | 低 | 中 | 現在の `whitespace-pre-wrap` レイアウトは長文にも対応。スクロール動作を確認 |
| 他テンプレート（regular, one-on-one等）への影響 | 中 | 中 | Phase 1 は `general` テンプレートのみ改修。他テンプレートは `JSON_FORMAT` 共有部分のみ影響。個別テストが必要 |
| 長文入力時の input token limit 超過 | 低 | 高 | gpt-5-miniは128K context。1時間の会議文字起こし（約15,000字）は約7,500トークンで余裕あり |

---

## 11. 結論

### 最大の問題点

1. **プロンプトが「詳細さ」「網羅性」を十分に指示していない**（寄与度40%）
2. **max_tokens が不足しておりLLMが自己圧縮する**（寄与度25%）
3. **JSON_FORMAT のサンプルが短くアンカリングバイアスを誘発**（寄与度15%）
4. **参加者名サンプルが捏造を誘発**（寄与度10%）
5. **recording/page.tsx が話者ラベルなし fullText を送信**（寄与度5%）

### 推奨する修正順序

1. プロンプト全面改修（`TEMPLATE_PROMPTS["general"]` + `JSON_FORMAT`）
2. `max_tokens` 引き上げ（8000 → 16000）
3. ユーザーメッセージ動的強化
4. `recording/page.tsx` 話者ラベル送信修正
5. テスト・検証

### 他 Issue への影響

- この改修は全テンプレートで `JSON_FORMAT` を共有しているため、`regular`, `one-on-one`, `sales`, `dev-sprint`, `brainstorm` テンプレートにも影響する
- JSON構造自体は変わらないため、フロントエンドのレンダリングへの影響はない
- 出力が長くなるため、CosmosDB に保存されるデータサイズが増加する（軽微）

### 判定

**`GO`** — 修正は全てテキスト変更・設定値変更レベルで低リスク。プロダクトの中核価値に直結する改善であり、即座に着手すべき。

---

*分析日: 2026-02-17*
*分析者: ReviewAAgent*
