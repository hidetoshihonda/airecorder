# 🔐 認証ゲート実装計画書（Issue #7）

> **作成日**: 2026-02-08  
> **ステータス**: 計画中  
> **Issue**: [#7 未ログインで全機能が使えてしまう](https://github.com/hidetoshihonda/airecorder/issues/7)  
> **ブランチ**: `feature/auth-gate`  
> **優先度**: P0（セキュリティ）  
> **推定工数**: 6〜8時間（検証・テスト含む）

---

## 📌 エグゼクティブサマリー

### 問題の本質

| レイヤー | 現状 | リスク |
|----------|------|--------|
| **フロントエンド（トップページ `/`）** | 未ログインでも録音・文字起こし・翻訳がフル動作する | Azure Speech/Translator APIキーが `NEXT_PUBLIC_*` でクライアントに露出しており、未認証ユーザーにも利用されコスト攻撃のリスクあり |
| **SWA ルーティング** | `/recording`, `/history`, `/settings` は認証必須だが `/` は未保護 | トップページから主要機能に到達可能 |
| **API** | `requireAuth()` 実装済み・SWAルーティングで `/api/*` は `authenticated` ロール必須 | **保存時に初めて401**になるが、録音・文字起こし自体は通る |
| **Speech/Translator SDK** | ブラウザから直接Azure APIを呼ぶ（API経由ではない） | SWAの認証ゲートを**完全にバイパス**する |

### ゴール

> **未ログイン状態で「録音開始」を押したらログイン誘導モーダルを表示しブロック。**  
> **API側も未認証なら録音関連操作を一切拒否。**

---

## 1. 現状アーキテクチャ分析

### 1.1 認証フロー（実装済み）

```
[ブラウザ] → /.auth/me → SWA組み込み認証 (GitHub OAuth)
         → /.auth/login/github → GitHub OAuth → Cookie発行
         → /api/* → SWAがx-ms-client-principalを付与 → Azure Functions
```

**✅ 正常に動作している部分:**
- `AuthContext` が `/.auth/me` から認証情報を取得
- `Header` にログイン/ログアウトボタン表示
- `/api/*` は SWA ルーティングで `authenticated` ロール必須
- API側の `requireAuth()` が `x-ms-client-principal` を検証
- Cosmos DB / Blob Storage の userId スコープ分離

### 1.2 問題箇所の詳細分析

#### 🔴 問題1: トップページ `/` の録音機能が未保護

```
page.tsx (トップページ):
  L164-L175: handleStart() → 認証チェックなしで即座に:
    - useSpeechRecognition.start() → Azure Speech SDK直接呼び出し
    - useAudioRecorder.start() → MediaRecorder開始
  
  → 未ログインでも録音・文字起こし・翻訳がフル動作
  → 保存時(L222-L280)に初めてAPI呼び出し → 401エラー
```

**インパクト**: 録音して文字起こし完了後に「保存できません」は最悪のUX

#### 🔴 問題2: Azure Speech/Translator APIキーのクライアント露出

```
config.ts:
  NEXT_PUBLIC_AZURE_SPEECH_KEY     → ブラウザに埋め込み
  NEXT_PUBLIC_AZURE_SPEECH_REGION  → ブラウザに埋め込み
  NEXT_PUBLIC_AZURE_TRANSLATOR_KEY → ブラウザに埋め込み
```

**インパクト**: 
- 認証不要で高額APIを叩き放題
- キーをコピーして外部から不正利用可能
- **本計画のスコープ外だが、将来的にProxy API化を強く推奨**（Issue別起票を推奨）

#### 🟡 問題3: SWAルーティングの `/` 未保護は仕様通り

```
staticwebapp.config.json:
  /             → 認証不要（ランディングページとして正しい）
  /recording    → authenticated 必須
  /history      → authenticated 必須
  /settings     → authenticated 必須
  /api/*        → authenticated 必須（/api/health除く）
```

**設計意図**: トップページは認証なしで閲覧可能、**アクション実行時にゲート**するのが正しいアプローチ

---

## 2. 設計方針

### 2.1 アーキテクチャ判断

| 判断 | 決定 | 理由 |
|------|------|------|
| `/` ページ自体を認証必須にするか | **❌ しない** | ランディングページとしての役割。UIを見せて興味を持たせる導線は残す |
| 録音開始ボタンでブロックするか | **✅ する** | フロントエンドの第一防御ライン。UXの観点から即座にフィードバック |
| API側でも二重チェックするか | **✅ する** | フロントのみのブロックはDevToolsで回避可能。Defense-in-Depth原則 |
| Speech/TranslatorをProxy化するか | **⚠️ 今回は対象外** | 工数大。別Issueで対応。ただし認証ゲートで主要な不正利用は防止 |

### 2.2 防御レイヤー設計（Defense-in-Depth）

```
Layer 1: [UI] 録音開始ボタン → 未認証ならモーダル表示でブロック
Layer 2: [UI] useSpeechRecognition / useAudioRecorder → 認証チェックガード
Layer 3: [SWA] /api/* ルーティング → authenticated ロール必須（実装済み）
Layer 4: [API] requireAuth() → x-ms-client-principal 検証（実装済み）
Layer 5: [Data] userId スコープ → Cosmos DB / Blob（実装済み）
```

**今回の実装対象: Layer 1 + Layer 2（+ 既存Layer 3-5の検証・強化）**

---

## 3. 詳細設計

### 3.1 コンポーネント設計

#### 3.1.1 AuthGateModal（新規作成）

**ファイル**: `web/src/components/ui/AuthGateModal.tsx`

```typescript
interface AuthGateModalProps {
  isOpen: boolean;
  onClose: () => void;
  action?: string; // "録音を開始" | "履歴を表示" 等
}
```

**要件**:
- 半透明オーバーレイ + 中央モーダル
- 「この機能を使用するにはログインが必要です」メッセージ
- GitHubログインボタン（`/.auth/login/github` へリダイレクト）
- 閉じるボタン（×）
- アクセシビリティ: フォーカストラップ、ESCキーで閉じる、`aria-modal`
- レスポンシブ対応
- アニメーション（フェードイン/アウト）

**表示内容**:
```
┌──────────────────────────────────┐
│              × │
│                                  │
│     🔐 ログインが必要です        │
│                                  │
│  「録音を開始」するには           │
│  ログインしてください            │
│                                  │
│  [  GitHubでログイン  ]          │
│                                  │
│  ログインすると以下が可能に:     │
│  ✓ 録音と文字起こし             │
│  ✓ 録音履歴の保存・管理         │
│  ✓ AI議事録の生成               │
│                                  │
└──────────────────────────────────┘
```

#### 3.1.2 useAuthGate フック（新規作成）

**ファイル**: `web/src/hooks/useAuthGate.ts`

```typescript
interface UseAuthGateReturn {
  /** 認証チェック付きアクション実行。未認証ならモーダルを表示しfalseを返す */
  requireAuth: (action?: string) => boolean;
  /** モーダルの開閉状態 */
  isModalOpen: boolean;
  /** モーダルを閉じる */
  closeModal: () => void;
  /** ブロックされたアクション名 */
  blockedAction: string | null;
}
```

**ロジック**:
```
requireAuth(action) {
  if (isAuthenticated) return true;
  setBlockedAction(action);
  setIsModalOpen(true);
  return false;
}
```

#### 3.1.3 page.tsx（トップページ）変更

**変更対象**: `web/src/app/page.tsx`

```typescript
// Before（現状）
const handleStart = () => {
  startRecognition(sourceLanguage, targetLanguage);
  startAudioRecording();
};

// After（変更後）
const { requireAuth, isModalOpen, closeModal, blockedAction } = useAuthGate();

const handleStart = () => {
  if (!requireAuth("録音を開始")) return; // ← ここでゲート
  startRecognition(sourceLanguage, targetLanguage);
  startAudioRecording();
};

// JSXにモーダル追加
<AuthGateModal 
  isOpen={isModalOpen} 
  onClose={closeModal}
  action={blockedAction}
/>
```

### 3.2 状態遷移設計

```
[未ログイン・アイドル]
    │
    ├─ 録音ボタン押下
    │   └─ requireAuth() → false → モーダル表示
    │       ├─ ログインボタン → /.auth/login/github → [認証フロー]
    │       └─ 閉じる → [未ログイン・アイドル]
    │
    └─ ログインボタン（Header）→ /.auth/login/github → [認証フロー]

[ログイン済み・アイドル]
    │
    └─ 録音ボタン押下
        └─ requireAuth() → true → 録音開始 → [録音中]
```

### 3.3 既存認証レイヤーの検証・強化ポイント

#### API側（確認事項）

| チェック項目 | 現状 | 対応 |
|-------------|------|------|
| `requireAuth()` が全API（health除く）で呼ばれるか | ✅ 呼ばれている | 検証のみ |
| `getClientPrincipalWithDevFallback()` が本番で使われていないか | ✅ 使われていない（定義のみ） | 検証のみ |
| SWA ルーティングの `/api/*` → `authenticated` | ✅ 設定済み | 検証のみ |
| CORS設定に不要なオリジンがないか | ⚠️ ハードコード | 定数化・環境変数化を推奨 |

#### フロントエンド側（確認事項）

| チェック項目 | 現状 | 対応 |
|-------------|------|------|
| `recordingsApi` の 401 ハンドリング | ✅ ログインリダイレクト | 検証のみ |
| `blobApi` の 401 ハンドリング | ✅ ログインリダイレクト | 検証のみ |
| AuthContext のロード中表示 | ✅ Spinner表示 | 検証のみ |

---

## 4. 依存関係マップ

```
Issue #7 (認証ゲート)
  │
  ├── 依存先（これに依存している）
  │   ├── SWA組み込み認証 ← ✅ 実装済み
  │   ├── AuthContext ← ✅ 実装済み
  │   ├── staticwebapp.config.json ← ✅ 設定済み
  │   └── api/utils/auth.ts ← ✅ 実装済み
  │
  ├── 影響を受けるIssue（並行・後続に注意）
  │   ├── #2 録音制御の不具合 ← 状態遷移に影響（認証状態が加わる）
  │   │   └─ 注意: handleStart の呼び出し順変更が #2 の修正と競合する可能性
  │   ├── #4 自動スクロール ← 影響なし
  │   ├── #5 音声再生・DL ← 影響なし（API認証は実装済み）
  │   ├── #8 多言語対応 ← モーダルの翻訳テキストを追加する必要
  │   │   └─ 注意: i18n実装前なら日本語ハードコード→後でキー化
  │   └── #9 話者識別 ← 認証ゲート後に開始されるので影響なし
  │
  └── 将来の関連Issue（要別起票）
      ├── 🔴 Speech/Translator APIキーのProxy化（コスト攻撃対策）
      ├── 🟡 認証プロバイダー追加（Google, Microsoft等）
      └── 🟢 セッションタイムアウトのUI通知
```

---

## 5. 実装タスク分解

### Phase 0: ブランチ準備・現状検証（30分）

| # | タスク | 完了条件 |
|---|--------|----------|
| 0.1 | `feature/auth-gate` ブランチ作成（masterから） | ブランチ存在 |
| 0.2 | 本番環境で未ログイン状態での録音開始を再現確認 | 録音・文字起こしが動作することを確認 |
| 0.3 | 既存API認証（Layer 3-4）が正常動作することを確認 | 未認証で `/api/recordings/list` → 401 |
| 0.4 | `getClientPrincipalWithDevFallback()` が本番で呼ばれていないことを確認 | grepで使用箇所0件 |

### Phase 1: AuthGateModal コンポーネント作成（1.5時間）

| # | タスク | 完了条件 |
|---|--------|----------|
| 1.1 | `AuthGateModal.tsx` 作成 | コンポーネント実装完了 |
| 1.2 | アクセシビリティ実装（フォーカストラップ、ESC、aria属性） | キーボード操作で正常動作 |
| 1.3 | レスポンシブ対応（モバイル/デスクトップ） | 各画面サイズで正常表示 |
| 1.4 | アニメーション（フェードイン/アウト） | スムーズな表示切替 |
| 1.5 | ダークモード非対応確認（ライトモード固定のため） | 表示確認 |

### Phase 2: useAuthGate フック作成（30分）

| # | タスク | 完了条件 |
|---|--------|----------|
| 2.1 | `useAuthGate.ts` フック作成 | `requireAuth()` が正常動作 |
| 2.2 | AuthContext との統合 | `isAuthenticated` 参照が正常 |
| 2.3 | ログイン後のリダイレクト設定 | ログイン後に元ページに戻る |

### Phase 3: トップページ統合（1時間）

| # | タスク | 完了条件 |
|---|--------|----------|
| 3.1 | `page.tsx` に useAuthGate 統合 | `handleStart` で認証チェック |
| 3.2 | AuthGateModal の配置 | 未ログインで録音開始→モーダル表示 |
| 3.3 | 保存ボタンの認証チェック追加 | 未ログインで保存→モーダル表示 |
| 3.4 | 議事録生成ボタンの認証チェック追加 | 未ログインで生成→モーダル表示 |

### Phase 4: 録音詳細ページの確認（30分）

| # | タスク | 完了条件 |
|---|--------|----------|
| 4.1 | `/recording` ページのSWAルーティング確認 | 未認証→ログインリダイレクト |
| 4.2 | `/history` ページのSWAルーティング確認 | 未認証→ログインリダイレクト |
| 4.3 | API 401レスポンス時のフロントエンド挙動確認 | 適切なリダイレクト |

### Phase 5: E2Eテスト・統合テスト（2時間）

| # | テストケース | 期待結果 |
|---|-------------|----------|
| 5.1 | 未ログイン → トップページ表示 | ✅ 表示される（UI閲覧可能） |
| 5.2 | 未ログイン → 録音開始ボタン | ✅ モーダル表示、録音は開始されない |
| 5.3 | 未ログイン → モーダル → ログイン → 元ページに戻る | ✅ トップページに戻る |
| 5.4 | ログイン済み → 録音開始 | ✅ 正常に録音開始 |
| 5.5 | ログイン済み → 録音 → 停止 → 保存 | ✅ 正常に保存 |
| 5.6 | 未ログイン → `/history` 直アクセス | ✅ ログインページにリダイレクト |
| 5.7 | 未ログイン → `/api/recordings/list` 直アクセス | ✅ 401レスポンス |
| 5.8 | DevTools で `handleStart()` を直接呼び出し | ✅ 認証チェックでブロック |
| 5.9 | ログイン → 録音中にセッション期限切れ | ⚠️ 保存時に401→ログインリダイレクト（許容） |
| 5.10 | モーダル表示中にESCキー | ✅ モーダルが閉じる |
| 5.11 | モーダル表示中にTabキー | ✅ フォーカスがモーダル内に留まる |

### Phase 6: デプロイ・本番検証（1時間）

| # | タスク | 完了条件 |
|---|--------|----------|
| 6.1 | PRの作成・レビュー | レビュー承認 |
| 6.2 | masterマージ・GitHub Actions デプロイ | デプロイ成功 |
| 6.3 | 本番環境での動作検証（Phase 5の再実行） | 全テストパス |

---

## 6. 考慮事項・リスク分析

### 6.1 技術的リスク

| リスク | 影響度 | 発生確率 | 軽減策 |
|--------|--------|----------|--------|
| SWA組み込み認証の `/.auth/me` が遅延する | 中 | 低 | AuthContextのキャッシュ（5分TTL）で対応済み。ローディング中は録音ボタンを `disabled` にする |
| Speech SDK がグローバルに `MediaStream` を保持し、モーダル表示中もマイク権限を要求 | 中 | 低 | `handleStart` の先頭で認証チェックし、未認証なら SDK 初期化前にリターン |
| ログイン後のリダイレクトでページ状態（入力済みテキスト等）が失われる | 中 | 高 | `post_login_redirect_uri` でトップページに戻すが、入力途中のデータは消える。将来的には `sessionStorage` で復元を検討 |
| GitHub OAuth の Rate Limit | 低 | 低 | SWA側で管理されるため問題なし |

### 6.2 UX上の考慮事項

| 観点 | 設計判断 | 理由 |
|------|----------|------|
| モーダルの煩わしさ | 録音開始時の1回のみ表示（ページ遷移ごとではない） | UXとセキュリティのバランス |
| 未ログイン時のUI表示 | 録音ボタンは表示するがゲートする（非表示にはしない） | 機能の存在を認知させ、ログインへの動機付けにする |
| 録音ボタンの見た目 | ログイン済み/未ログインで外見を変えない | 機能差を見せるとUX複雑化。モーダルで十分 |
| ローディング中の録音ボタン | `disabled` にして「認証確認中...」ツールチップ | 認証チェック完了前にクリックされるのを防止 |

### 6.3 セキュリティ上の考慮事項

| 観点 | 対応方針 |
|------|----------|
| フロントエンドだけのブロックは回避可能 | API側の `requireAuth()` が最終防御（Defense-in-Depth） |
| `NEXT_PUBLIC_*` のAPIキー露出 | **本Issueのスコープ外**。別Issue「Speech/Translator API Proxy化」で対応推奨 |
| CSRF対策 | SWA組み込み認証のCookieは `SameSite=Strict` 設定。CSRF耐性あり |
| XSS経由のトークン窃取 | SWA認証Cookieは `HttpOnly` 設定。JS からアクセス不可 |

### 6.4 パフォーマンスへの影響

| 観点 | 影響 |
|------|------|
| モーダルのバンドルサイズ | 極小（数KB）。Dialog UI のみ |
| 認証チェックのレイテンシ | なし（`AuthContext` の `isAuthenticated` をメモリ上で参照するだけ） |
| `/.auth/me` の初回フェッチ | 既存実装（変更なし）。キャッシュ5分TTL |

---

## 7. ファイル変更一覧

| 操作 | ファイル | 変更内容 |
|------|----------|----------|
| **新規** | `web/src/components/ui/AuthGateModal.tsx` | 認証誘導モーダルコンポーネント |
| **新規** | `web/src/hooks/useAuthGate.ts` | 認証ゲートフック |
| **修正** | `web/src/app/page.tsx` | `handleStart` / `handleSave` / 議事録生成に認証チェック追加 |
| **修正** | `web/src/components/ui/index.tsx` | `AuthGateModal` のexport追加 |
| **修正** | `web/src/hooks/index.ts` | `useAuthGate` のexport追加 |
| **検証のみ** | `web/staticwebapp.config.json` | 既存設定の正常性確認 |
| **検証のみ** | `api/src/functions/recordings.ts` | `requireAuth()` 使用の確認 |
| **検証のみ** | `api/src/functions/blob.ts` | `requireAuth()` 使用の確認 |
| **検証のみ** | `api/src/functions/summary.ts` | `requireAuth()` 使用の確認 |

---

## 8. 将来対応（別Issue起票推奨）

| # | 項目 | 優先度 | 理由 |
|---|------|--------|------|
| 1 | **Speech/Translator APIキーのProxy化** | 🔴 高 | `NEXT_PUBLIC_*` でクライアントに露出中。認証ゲートでブロックしても、キー自体はソースコードから抽出可能 |
| 2 | **認証プロバイダー追加（Google, Microsoft）** | 🟡 中 | GitHub以外のユーザーへの対応。SWA設定の `routes` で追加可能 |
| 3 | **セッションタイムアウト通知** | 🟡 中 | SWA標準は8時間。録音中にセッション切れると保存失敗 |
| 4 | **ログイン後の状態復元** | 🟢 低 | ログイン前の入力内容を `sessionStorage` で保持→復元 |
| 5 | **認証ゲートの多言語対応** | 🟢 低 | Issue #8（i18n）完了後にモーダルテキストを翻訳キー化 |

---

## 9. Go / No-Go チェックリスト

実装開始前に以下を確認:

- [ ] SWA組み込み認証が本番で正常動作している
- [ ] `/.auth/me` が認証情報を正しく返す
- [ ] GitHub OAuth の Client ID/Secret が設定済み
- [ ] `feature/auth-gate` ブランチが `master` から作成可能
- [ ] 既存の `feature/user-auth` ブランチの変更がマージ済み or 競合しない

---

## 10. レビュー観点チェックリスト

PR レビュー時に確認すべき項目:

### セキュリティ
- [ ] フロントエンドの認証チェックがバイパス不可能であること（API側のバックアップあり）
- [ ] `requireAuth()` が保護対象の全APIで呼ばれていること
- [ ] `getClientPrincipalWithDevFallback()` が本番パスで呼ばれていないこと
- [ ] CORSの設定が適切であること

### UX
- [ ] モーダルのアクセシビリティ（キーボード操作、スクリーンリーダー）
- [ ] モーダルのレスポンシブ対応
- [ ] ログイン後に元ページに正常復帰すること
- [ ] 認証チェック中（ローディング）のUI状態

### コード品質
- [ ] TypeScript型安全性（`strictNullChecks`）
- [ ] 不要なre-renderが発生しないこと（`useMemo`/`useCallback` 適切使用）
- [ ] テスト網羅性（Phase 5の全テストケース）
