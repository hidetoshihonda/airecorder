# ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼å®Ÿè£…è¨ˆç”»æ›¸ v2

> **æœ€çµ‚æ›´æ–°**: 2026-02-06  
> **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ãƒ»å®Ÿè£…å¾…ã¡  
> **ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼**: PM/æŠ€è¡“è²¬ä»»è€…

---

## ğŸ“Œ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

### ç›®çš„
AI Voice Recorderã«ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚’å®Ÿè£…ã—ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é›¢**ã™ã‚‹ã€‚

### ç¾çŠ¶ã®å•é¡Œ
| å•é¡Œ | å½±éŸ¿ | ç·Šæ€¥åº¦ |
|------|------|--------|
| å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ `temp-user-001` ã‚’å…±æœ‰ | ä»–äººã®éŒ²éŸ³ãŒè¦‹ãˆã‚‹ | ğŸ”´ é«˜ |
| APIãŒèªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ | ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ãƒ»ã‚³ã‚¹ãƒˆæ”»æ’ƒ | ğŸ”´ é«˜ |
| Blob StorageãŒæœªä¿è­· | éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æ¼æ´© | ğŸ”´ é«˜ |

### æ¨å¥¨ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³
**Azure Static Web Apps çµ„ã¿è¾¼ã¿èªè¨¼** + **Linked Backend (BYOF)**

### å·¥æ•°
**ç´„7ã€œ8æ™‚é–“**ï¼ˆæ¤œè¨¼å«ã‚€ï¼‰

### å‰ææ¡ä»¶ï¼ˆGo/No-Goï¼‰
ä»¥ä¸‹ãŒæº€ãŸã•ã‚Œãªã„å ´åˆã€å®Ÿè£…ã‚’é–‹å§‹ã—ãªã„ï¼š
1. âœ… BYOFè¨­å®šã§ãƒ˜ãƒƒãƒ€ãƒ¼è»¢é€ãŒæ©Ÿèƒ½ã™ã‚‹ã“ã¨
2. âœ… POãŒæ—¢å­˜ãƒ‡ãƒ¼ã‚¿å¯¾å¿œæ–¹é‡ã‚’æ±ºå®šã™ã‚‹ã“ã¨
3. âœ… POãŒå„ãƒšãƒ¼ã‚¸ã®èªè¨¼è¦å¦ã‚’æ±ºå®šã™ã‚‹ã“ã¨

---

## 1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### 1.1 ç¾åœ¨ã®æ§‹æˆ

```
[ãƒ–ãƒ©ã‚¦ã‚¶] â”€â”€ç›´æ¥â”€â”€â†’ [Azure Functions: func-airecorder-dev]
    â”‚                        â†“
    â”‚                 [Cosmos DB] [Blob Storage]
    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [SWA: proud-rock-06bba6200]
                      (é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡ã®ã¿)
```

**å•é¡Œ**: ãƒ–ãƒ©ã‚¦ã‚¶ãŒFunctionsã‚’ç›´æ¥å‘¼ã¶ãŸã‚ã€SWAèªè¨¼ãŒåŠ¹ã‹ãªã„

### 1.2 å¤‰æ›´å¾Œã®æ§‹æˆ

```
[ãƒ–ãƒ©ã‚¦ã‚¶] â”€â”€â†’ [SWA: proud-rock-06bba6200]
                    â”‚
                    â”œâ”€ é™çš„ãƒ•ã‚¡ã‚¤ãƒ«: ç›´æ¥é…ä¿¡
                    â”‚
                    â””â”€ /api/*: Linked BackendçµŒç”±ã§è»¢é€
                              â†“
                        [Azure Functions: func-airecorder-dev]
                        (x-ms-client-principal ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ä¸)
                              â†“
                        [Cosmos DB] [Blob Storage]
```

**ãƒã‚¤ãƒ³ãƒˆ**: å…¨ã¦ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒSWAçµŒç”±ã«ãªã‚Šã€èªè¨¼æƒ…å ±ãŒè‡ªå‹•ä»˜ä¸ã•ã‚Œã‚‹

### 1.3 èªè¨¼ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ /history ã«ã‚¢ã‚¯ã‚»ã‚¹
2. SWA: æœªèªè¨¼ â†’ /.auth/login/github ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
3. GitHub OAuthç”»é¢ã§ãƒ­ã‚°ã‚¤ãƒ³
4. ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ â†’ SWAãŒèªè¨¼Cookieã‚’ç™ºè¡Œ
5. /history ã«æˆ»ã‚‹ï¼ˆèªè¨¼æ¸ˆã¿ï¼‰
6. APIå‘¼ã³å‡ºã—æ™‚ã€SWAãŒ x-ms-client-principal ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸
7. Azure Functions: ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰userIdã‚’å–å¾—ã€æ¤œè¨¼
8. Cosmos DB: userId ã§ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦ãƒ‡ãƒ¼ã‚¿è¿”å´
```

---

## 2. æŠ€è¡“çš„æ±ºå®šäº‹é …

### 2.1 èªè¨¼æ–¹å¼

| é …ç›® | æ±ºå®š | ç†ç”± |
|------|------|------|
| èªè¨¼åŸºç›¤ | SWAçµ„ã¿è¾¼ã¿èªè¨¼ | ç„¡æ–™ã€ã‚³ãƒ¼ãƒ‰å¤‰æ›´æœ€å° |
| ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ | GitHubï¼ˆä¸»ï¼‰| é–‹ç™ºè€…å‘ã‘ã€è¨­å®šä¸è¦ |
| APIé€£æº | Linked Backend (BYOF) | Node.js 20å¯¾å¿œå¯èƒ½ |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ | SWAæ¨™æº–ï¼ˆ8æ™‚é–“ï¼‰ | å¤‰æ›´ä¸è¦ |

### 2.2 ãƒ‡ãƒ¼ã‚¿åˆ†é›¢è¨­è¨ˆ

| ãƒªã‚½ãƒ¼ã‚¹ | ç¾åœ¨ã®ãƒ‘ã‚¹ | å¤‰æ›´å¾Œã®ãƒ‘ã‚¹ |
|----------|-----------|-------------|
| Cosmos DB | `/userId` ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ | å¤‰æ›´ãªã—ï¼ˆæ—¢ã«å¯¾å¿œï¼‰ |
| Blob Storage | `recordings/{fileName}` | `recordings/{userId}/{fileName}` |

### 2.3 APIèªè¨¼è¨­è¨ˆ

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | èªè¨¼è¦å¦ | æ‰€æœ‰æ¨©ç¢ºèª |
|---------------|---------|-----------|
| GET /api/recordings/list | å¿…é ˆ | userIdè‡ªå‹•ãƒ•ã‚£ãƒ«ã‚¿ |
| POST /api/recordings | å¿…é ˆ | userIdè‡ªå‹•ä»˜ä¸ |
| GET /api/recordings/{id} | å¿…é ˆ | âœ… å¿…è¦ |
| PUT /api/recordings/{id} | å¿…é ˆ | âœ… å¿…è¦ |
| DELETE /api/recordings/{id} | å¿…é ˆ | âœ… å¿…è¦ |
| POST /api/blob/upload-sas | å¿…é ˆ | ãƒ‘ã‚¹ã«userIdå«ã‚ã‚‹ |
| GET /api/blob/download-sas | å¿…é ˆ | âœ… å¿…è¦ |
| GET /api/blob/list | å¿…é ˆ | userIdè‡ªå‹•ãƒ•ã‚£ãƒ«ã‚¿ |
| POST /api/summary | å¿…é ˆ | - |
| GET /api/health | ä¸è¦ | - |

### 2.4 ãƒšãƒ¼ã‚¸èªè¨¼è¦ä»¶

| ãƒšãƒ¼ã‚¸ | èªè¨¼è¦å¦ | ç†ç”± |
|--------|---------|------|
| / (ãƒˆãƒƒãƒ—) | ä¸è¦ | ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ |
| /recording | **å¿…é ˆ** | ä¿å­˜ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³å¿…è¦ |
| /history | **å¿…é ˆ** | å€‹äººãƒ‡ãƒ¼ã‚¿è¡¨ç¤º |
| /settings | **å¿…é ˆ** | å€‹äººè¨­å®š |
| /privacy, /terms | ä¸è¦ | å…¬é–‹æƒ…å ± |

### 2.5 ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼

```typescript
// çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
  code?: ErrorCode;
}

type ErrorCode = 
  | "AUTH_REQUIRED"      // 401: æœªèªè¨¼
  | "ACCESS_DENIED"      // 403: æ¨©é™ãªã—
  | "NOT_FOUND"          // 404: ãƒªã‚½ãƒ¼ã‚¹ãªã—ï¼ˆã¾ãŸã¯ä»–äººã®ãƒªã‚½ãƒ¼ã‚¹ï¼‰
  | "VALIDATION_ERROR"   // 400: å…¥åŠ›ã‚¨ãƒ©ãƒ¼
  | "INTERNAL_ERROR";    // 500: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼
```

---

## 3. å®Ÿè£…è¨ˆç”»

### Phase 0: æ¤œè¨¼ï¼ˆå¿…é ˆãƒ»ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼‰

**å·¥æ•°**: 1æ™‚é–“  
**æ‹…å½“**: é–‹ç™º

#### 0.1 BYOFè¨­å®š

```powershell
# 1. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDå–å¾—
$subscriptionId = az account show --query id -o tsv

# 2. Linked Backendè¨­å®š
az staticwebapp backends link `
  --name swa-airecorder-dev `
  --resource-group rg-airecorder-dev `
  --backend-resource-id "/subscriptions/$subscriptionId/resourceGroups/rg-airecorder-dev/providers/Microsoft.Web/sites/func-airecorder-dev" `
  --backend-region japaneast

# 3. è¨­å®šç¢ºèª
az staticwebapp backends show --name swa-airecorder-dev --resource-group rg-airecorder-dev
```

#### 0.2 ãƒ˜ãƒƒãƒ€ãƒ¼è»¢é€æ¤œè¨¼

1. GitHubã§SWAã«ãƒ­ã‚°ã‚¤ãƒ³
2. DevToolsã§ `/api/health` ã‚’å‘¼ã³å‡ºã—
3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã« `x-ms-client-principal` ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
4. **ãªã‘ã‚Œã°**: æ–¹å¼å¤‰æ›´ãŒå¿…è¦ï¼ˆè¨ˆç”»ä¸­æ­¢ï¼‰

#### 0.3 ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ

```powershell
# SWA CLIã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆï¼‰
npm install -g @azure/static-web-apps-cli

# ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•
swa start http://localhost:3000 --api-location ./api
```

**å®Œäº†æ¡ä»¶**: 
- [ ] BYOFè¨­å®šå®Œäº†
- [ ] ãƒ˜ãƒƒãƒ€ãƒ¼è»¢é€ç¢ºèª
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒå‹•ä½œç¢ºèª

---

### Phase 1: SWAè¨­å®šï¼ˆ30åˆ†ï¼‰

#### 1.1 staticwebapp.config.json

```json
{
  "routes": [
    {
      "route": "/login",
      "redirect": "/.auth/login/github"
    },
    {
      "route": "/logout",
      "redirect": "/.auth/logout"
    },
    {
      "route": "/.auth/login/aad",
      "statusCode": 404
    },
    {
      "route": "/api/health",
      "allowedRoles": ["anonymous", "authenticated"]
    },
    {
      "route": "/api/*",
      "allowedRoles": ["authenticated"]
    },
    {
      "route": "/recording",
      "allowedRoles": ["authenticated"]
    },
    {
      "route": "/recording/*",
      "allowedRoles": ["authenticated"]
    },
    {
      "route": "/history",
      "allowedRoles": ["authenticated"]
    },
    {
      "route": "/history/*",
      "allowedRoles": ["authenticated"]
    },
    {
      "route": "/settings",
      "allowedRoles": ["authenticated"]
    }
  ],
  "responseOverrides": {
    "401": {
      "redirect": "/.auth/login/github?post_login_redirect_uri=.referrer",
      "statusCode": 302
    }
  },
  "navigationFallback": {
    "rewrite": "/index.html",
    "exclude": ["/images/*.{png,jpg,gif}", "/css/*", "/_next/*", "/.auth/*", "/api/*"]
  },
  "globalHeaders": {
    "X-Content-Type-Options": "nosniff",
    "X-Frame-Options": "DENY",
    "X-XSS-Protection": "1; mode=block",
    "Referrer-Policy": "strict-origin-when-cross-origin"
  }
}
```

**å¤‰æ›´ç‚¹**:
- `/recording` ã‚’èªè¨¼å¿…é ˆã«è¿½åŠ 
- `/settings` ã‚’èªè¨¼å¿…é ˆã«è¿½åŠ 
- `/api/health` ã¯èªè¨¼ä¸è¦ï¼ˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
- `/_next/*` ã‚’é™¤å¤–ã«è¿½åŠ ï¼ˆNext.jsé™çš„ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

---

### Phase 2: APIèªè¨¼å®Ÿè£…ï¼ˆ1.5æ™‚é–“ï¼‰ğŸ”´æœ€é‡è¦

#### 2.1 èªè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `api/src/utils/auth.ts`

```typescript
import { HttpRequest, HttpResponseInit } from "@azure/functions";

// ========== å‹å®šç¾© ==========

export interface ClientPrincipal {
  identityProvider: string;
  userId: string;
  userDetails: string;
  userRoles: string[];
}

export interface AuthResult {
  success: true;
  principal: ClientPrincipal;
} | {
  success: false;
  response: HttpResponseInit;
}

// ========== ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ ==========

export class AuthenticationError extends Error {
  constructor(message: string = "Authentication required") {
    super(message);
    this.name = "AuthenticationError";
  }
}

export class AuthorizationError extends Error {
  constructor(message: string = "Access denied") {
    super(message);
    this.name = "AuthorizationError";
  }
}

// ========== ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ==========

/**
 * x-ms-client-principal ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
 */
export function getClientPrincipal(request: HttpRequest): ClientPrincipal | null {
  const header = request.headers.get("x-ms-client-principal");
  
  if (!header) {
    return null;
  }

  try {
    const decoded = Buffer.from(header, "base64").toString("utf-8");
    const principal = JSON.parse(decoded) as ClientPrincipal;
    
    // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
    if (!principal.userId || !principal.userRoles) {
      return null;
    }
    
    return principal;
  } catch (error) {
    console.error("Failed to parse client principal:", error);
    return null;
  }
}

/**
 * èªè¨¼ã‚’è¦æ±‚ã—ã€å¤±æ•—æ™‚ã¯ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼
 */
export function requireAuth(request: HttpRequest): ClientPrincipal {
  const principal = getClientPrincipal(request);
  
  if (!principal) {
    throw new AuthenticationError();
  }
  
  if (!principal.userRoles.includes("authenticated")) {
    throw new AuthorizationError();
  }
  
  return principal;
}

/**
 * èªè¨¼ã‚¨ãƒ©ãƒ¼ã‚’HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å¤‰æ›
 */
export function handleAuthError(error: unknown, corsHeaders: Record<string, string>): HttpResponseInit {
  if (error instanceof AuthenticationError) {
    return {
      status: 401,
      headers: { "Content-Type": "application/json", ...corsHeaders },
      body: JSON.stringify({
        success: false,
        error: error.message,
        code: "AUTH_REQUIRED"
      })
    };
  }
  
  if (error instanceof AuthorizationError) {
    return {
      status: 403,
      headers: { "Content-Type": "application/json", ...corsHeaders },
      body: JSON.stringify({
        success: false,
        error: error.message,
        code: "ACCESS_DENIED"
      })
    };
  }
  
  // äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼
  console.error("Unexpected auth error:", error);
  return {
    status: 500,
    headers: { "Content-Type": "application/json", ...corsHeaders },
    body: JSON.stringify({
      success: false,
      error: "Internal server error",
      code: "INTERNAL_ERROR"
    })
  };
}

// ========== é–‹ç™ºç’°å¢ƒç”¨ ==========

const DEV_USER: ClientPrincipal = {
  identityProvider: "local",
  userId: "dev-user-001",
  userDetails: "Developer",
  userRoles: ["anonymous", "authenticated"]
};

/**
 * é–‹ç™ºç’°å¢ƒã§ã¯èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
 */
export function getClientPrincipalWithDevFallback(request: HttpRequest): ClientPrincipal | null {
  const principal = getClientPrincipal(request);
  
  if (principal) {
    return principal;
  }
  
  // é–‹ç™ºç’°å¢ƒã§ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (process.env.NODE_ENV === "development" || process.env.AZURE_FUNCTIONS_ENVIRONMENT === "Development") {
    console.warn("Using development user fallback");
    return DEV_USER;
  }
  
  return null;
}
```

#### 2.2 CORSè¨­å®šã®æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `api/src/functions/recordings.ts` ä»–

```typescript
// CORSè¨­å®šã‚’å³æ ¼åŒ–
const ALLOWED_ORIGINS = [
  "https://proud-rock-06bba6200.2.azurestaticapps.net",
  "http://localhost:3000",
  "http://localhost:4280"  // SWA CLI
];

function getCorsHeaders(request: HttpRequest): Record<string, string> {
  const origin = request.headers.get("origin") || "";
  const isAllowed = ALLOWED_ORIGINS.includes(origin);
  
  return {
    "Access-Control-Allow-Origin": isAllowed ? origin : ALLOWED_ORIGINS[0],
    "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type, Authorization, x-ms-client-principal",
    "Access-Control-Allow-Credentials": "true",
    "Access-Control-Max-Age": "86400"
  };
}
```

#### 2.3 recordings.ts ã®ä¿®æ­£

```typescript
import { requireAuth, handleAuthError, AuthenticationError, AuthorizationError } from "../utils/auth";

// listRecordings
app.http("listRecordings", {
  methods: ["GET", "OPTIONS"],
  authLevel: "anonymous",
  route: "recordings/list",
  handler: async (request, context) => {
    const corsHeaders = getCorsHeaders(request);
    
    if (request.method === "OPTIONS") {
      return { status: 204, headers: corsHeaders };
    }

    try {
      // èªè¨¼å¿…é ˆ
      const principal = requireAuth(request);
      const userId = principal.userId;
      
      // ãƒšãƒ¼ã‚¸ãƒ³ã‚°
      const page = parseInt(request.query.get("page") || "1");
      const limit = parseInt(request.query.get("limit") || "20");
      const search = request.query.get("search") || undefined;

      const result = await recordingService.listRecordings(userId, page, limit, search);
      
      return {
        status: 200,
        headers: { "Content-Type": "application/json", ...corsHeaders },
        body: JSON.stringify({ success: true, data: result })
      };
    } catch (error) {
      if (error instanceof AuthenticationError || error instanceof AuthorizationError) {
        return handleAuthError(error, corsHeaders);
      }
      
      context.error("listRecordings error:", error);
      return {
        status: 500,
        headers: { "Content-Type": "application/json", ...corsHeaders },
        body: JSON.stringify({ success: false, error: "Internal server error", code: "INTERNAL_ERROR" })
      };
    }
  }
});

// recordingById - æ‰€æœ‰æ¨©ç¢ºèªãŒå¿…è¦
app.http("recordingById", {
  methods: ["GET", "PUT", "DELETE", "OPTIONS"],
  authLevel: "anonymous",
  route: "recordings/{id}",
  handler: async (request, context) => {
    const corsHeaders = getCorsHeaders(request);
    
    if (request.method === "OPTIONS") {
      return { status: 204, headers: corsHeaders };
    }

    try {
      const principal = requireAuth(request);
      const userId = principal.userId;
      const id = request.params.id;

      // GET: æ‰€æœ‰æ¨©ç¢ºèª
      if (request.method === "GET") {
        const recording = await recordingService.getRecording(id, userId);
        
        // å­˜åœ¨ã—ãªã„ã‹ã€ä»–äººã®ãƒ¬ã‚³ãƒ¼ãƒ‰ â†’ 404ï¼ˆå­˜åœ¨ã‚’éš ã™ï¼‰
        if (!recording || recording.userId !== userId) {
          return {
            status: 404,
            headers: { "Content-Type": "application/json", ...corsHeaders },
            body: JSON.stringify({ success: false, error: "Recording not found", code: "NOT_FOUND" })
          };
        }
        
        return {
          status: 200,
          headers: { "Content-Type": "application/json", ...corsHeaders },
          body: JSON.stringify({ success: true, data: recording })
        };
      }

      // PUT: æ‰€æœ‰æ¨©ç¢ºèªå¾Œã«æ›´æ–°
      if (request.method === "PUT") {
        const existing = await recordingService.getRecording(id, userId);
        if (!existing || existing.userId !== userId) {
          return {
            status: 404,
            headers: { "Content-Type": "application/json", ...corsHeaders },
            body: JSON.stringify({ success: false, error: "Recording not found", code: "NOT_FOUND" })
          };
        }
        
        const body = await request.json() as Partial<Recording>;
        const updated = await recordingService.updateRecording(id, userId, body);
        
        return {
          status: 200,
          headers: { "Content-Type": "application/json", ...corsHeaders },
          body: JSON.stringify({ success: true, data: updated })
        };
      }

      // DELETE: æ‰€æœ‰æ¨©ç¢ºèªå¾Œã«å‰Šé™¤
      if (request.method === "DELETE") {
        const existing = await recordingService.getRecording(id, userId);
        if (!existing || existing.userId !== userId) {
          return {
            status: 404,
            headers: { "Content-Type": "application/json", ...corsHeaders },
            body: JSON.stringify({ success: false, error: "Recording not found", code: "NOT_FOUND" })
          };
        }
        
        await recordingService.deleteRecording(id, userId);
        
        return {
          status: 200,
          headers: { "Content-Type": "application/json", ...corsHeaders },
          body: JSON.stringify({ success: true })
        };
      }

    } catch (error) {
      if (error instanceof AuthenticationError || error instanceof AuthorizationError) {
        return handleAuthError(error, corsHeaders);
      }
      
      context.error("recordingById error:", error);
      return {
        status: 500,
        headers: { "Content-Type": "application/json", ...corsHeaders },
        body: JSON.stringify({ success: false, error: "Internal server error", code: "INTERNAL_ERROR" })
      };
    }
  }
});
```

#### 2.4 blob.ts ã®ä¿®æ­£

```typescript
import { requireAuth, handleAuthError } from "../utils/auth";

// generateUploadSas - userIdã‚’ãƒ‘ã‚¹ã«å«ã‚ã‚‹
app.http("generateUploadSas", {
  methods: ["GET", "OPTIONS"],
  authLevel: "anonymous",
  route: "blob/upload-sas",
  handler: async (request, context) => {
    const corsHeaders = getCorsHeaders(request);
    
    if (request.method === "OPTIONS") {
      return { status: 204, headers: corsHeaders };
    }

    try {
      const principal = requireAuth(request);
      const userId = principal.userId;
      const fileName = request.query.get("fileName");

      if (!fileName) {
        return {
          status: 400,
          headers: { "Content-Type": "application/json", ...corsHeaders },
          body: JSON.stringify({ success: false, error: "fileName is required", code: "VALIDATION_ERROR" })
        };
      }

      // ãƒ‘ã‚¹ã«userIdã‚’å«ã‚ã‚‹: recordings/{userId}/{fileName}
      const blobPath = `recordings/${userId}/${fileName}`;
      const sasUrl = await blobService.generateUploadSas(blobPath);
      
      return {
        status: 200,
        headers: { "Content-Type": "application/json", ...corsHeaders },
        body: JSON.stringify({ success: true, data: { sasUrl, blobPath } })
      };
    } catch (error) {
      return handleAuthError(error, corsHeaders);
    }
  }
});

// listBlobs - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®blobã®ã¿è¿”ã™
app.http("listBlobs", {
  methods: ["GET", "OPTIONS"],
  authLevel: "anonymous",
  route: "blob/list",
  handler: async (request, context) => {
    const corsHeaders = getCorsHeaders(request);
    
    if (request.method === "OPTIONS") {
      return { status: 204, headers: corsHeaders };
    }

    try {
      const principal = requireAuth(request);
      const userId = principal.userId;

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®prefixã§ãƒ•ã‚£ãƒ«ã‚¿: recordings/{userId}/
      const prefix = `recordings/${userId}/`;
      const blobs = await blobService.listBlobs(prefix);
      
      return {
        status: 200,
        headers: { "Content-Type": "application/json", ...corsHeaders },
        body: JSON.stringify({ success: true, data: blobs })
      };
    } catch (error) {
      return handleAuthError(error, corsHeaders);
    }
  }
});
```

#### 2.5 summary.ts ã®ä¿®æ­£

```typescript
import { requireAuth, handleAuthError } from "../utils/auth";

app.http("generateSummary", {
  methods: ["POST", "OPTIONS"],
  authLevel: "anonymous",
  route: "summary",
  handler: async (request, context) => {
    const corsHeaders = getCorsHeaders(request);
    
    if (request.method === "OPTIONS") {
      return { status: 204, headers: corsHeaders };
    }

    try {
      // èªè¨¼å¿…é ˆï¼ˆã‚³ã‚¹ãƒˆä¿è­·ï¼‰
      const principal = requireAuth(request);
      context.log(`Summary requested by user: ${principal.userId}`);

      const body = await request.json();
      // ... æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯
      
    } catch (error) {
      return handleAuthError(error, corsHeaders);
    }
  }
});
```

---

### Phase 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆ1æ™‚é–“ï¼‰

#### 3.1 èªè¨¼ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `web/src/lib/auth.ts`

```typescript
// ========== å‹å®šç¾© ==========

export interface ClientPrincipal {
  identityProvider: string;
  userId: string;
  userDetails: string;
  userRoles: string[];
}

export interface AuthInfo {
  clientPrincipal: ClientPrincipal | null;
}

// ========== ã‚­ãƒ£ãƒƒã‚·ãƒ¥ ==========

let cachedAuthInfo: AuthInfo | null = null;
let cacheTimestamp = 0;
const CACHE_TTL = 5 * 60 * 1000; // 5åˆ†

// ========== é–¢æ•° ==========

/**
 * SWAã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—
 */
export async function getAuthInfo(forceRefresh = false): Promise<AuthInfo> {
  const now = Date.now();
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ãªã‚‰ãã‚Œã‚’è¿”ã™
  if (!forceRefresh && cachedAuthInfo && (now - cacheTimestamp) < CACHE_TTL) {
    return cachedAuthInfo;
  }
  
  try {
    const response = await fetch('/.auth/me', {
      credentials: 'include'
    });
    
    if (!response.ok) {
      cachedAuthInfo = { clientPrincipal: null };
      cacheTimestamp = now;
      return cachedAuthInfo;
    }
    
    cachedAuthInfo = await response.json() as AuthInfo;
    cacheTimestamp = now;
    return cachedAuthInfo;
  } catch (error) {
    console.error('Failed to fetch auth info:', error);
    return { clientPrincipal: null };
  }
}

/**
 * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ãªã©ï¼‰
 */
export function clearAuthCache(): void {
  cachedAuthInfo = null;
  cacheTimestamp = 0;
}

/**
 * èªè¨¼æ¸ˆã¿ã‹ã©ã†ã‹
 */
export function isAuthenticated(authInfo: AuthInfo): boolean {
  return authInfo.clientPrincipal !== null &&
         authInfo.clientPrincipal.userRoles.includes('authenticated');
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—
 */
export function getUserId(authInfo: AuthInfo): string | null {
  return authInfo.clientPrincipal?.userId ?? null;
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—
 */
export function getUserName(authInfo: AuthInfo): string | null {
  return authInfo.clientPrincipal?.userDetails ?? null;
}

/**
 * IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å–å¾—
 */
export function getIdentityProvider(authInfo: AuthInfo): string | null {
  return authInfo.clientPrincipal?.identityProvider ?? null;
}

// ========== ãƒ­ã‚°ã‚¤ãƒ³URL ==========

export const LOGIN_URL = '/.auth/login/github';
export const LOGOUT_URL = '/.auth/logout';

export function getLoginUrl(redirectUri?: string): string {
  const redirect = redirectUri || window.location.pathname;
  return `${LOGIN_URL}?post_login_redirect_uri=${encodeURIComponent(redirect)}`;
}

export function getLogoutUrl(redirectUri = '/'): string {
  return `${LOGOUT_URL}?post_logout_redirect_uri=${encodeURIComponent(redirectUri)}`;
}
```

#### 3.2 AuthContext ã®æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `web/src/contexts/AuthContext.tsx`

```typescript
"use client";

import { createContext, useContext, useState, useCallback, useEffect, ReactNode } from "react";
import { User, UserSettings } from "@/types";
import { 
  getAuthInfo, 
  isAuthenticated as checkAuth, 
  getUserId, 
  getUserName,
  getLoginUrl,
  getLogoutUrl,
  clearAuthCache
} from "@/lib/auth";

interface AuthContextType {
  user: User | null;
  isLoading: boolean;
  isAuthenticated: boolean;
  settings: UserSettings;
  login: (redirectUri?: string) => void;
  logout: () => void;
  updateSettings: (settings: Partial<UserSettings>) => void;
  refreshAuth: () => Promise<void>;
}

const defaultSettings: UserSettings = {
  speechLanguage: "ja-JP",
  theme: "light",
  autoSave: true,
};

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [settings, setSettings] = useState<UserSettings>(defaultSettings);

  // èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
  const checkAuthStatus = useCallback(async (forceRefresh = false) => {
    try {
      const authInfo = await getAuthInfo(forceRefresh);
      
      if (checkAuth(authInfo)) {
        setUser({
          id: getUserId(authInfo)!,
          name: getUserName(authInfo) || 'User',
          email: getUserName(authInfo) || undefined,
        });
      } else {
        setUser(null);
      }
    } catch (error) {
      console.error('Auth check failed:', error);
      setUser(null);
    } finally {
      setIsLoading(false);
    }
  }, []);

  // åˆå›ãƒã‚¦ãƒ³ãƒˆæ™‚
  useEffect(() => {
    checkAuthStatus();
  }, [checkAuthStatus]);

  // ãƒ­ã‚°ã‚¤ãƒ³
  const login = useCallback((redirectUri?: string) => {
    window.location.href = getLoginUrl(redirectUri);
  }, []);

  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  const logout = useCallback(() => {
    clearAuthCache();
    window.location.href = getLogoutUrl();
  }, []);

  // èªè¨¼çŠ¶æ…‹ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
  const refreshAuth = useCallback(async () => {
    setIsLoading(true);
    await checkAuthStatus(true);
  }, [checkAuthStatus]);

  // è¨­å®šæ›´æ–°
  const updateSettings = useCallback((newSettings: Partial<UserSettings>) => {
    setSettings(prev => ({ ...prev, ...newSettings }));
  }, []);

  return (
    <AuthContext.Provider
      value={{
        user,
        isLoading,
        isAuthenticated: user !== null,
        settings,
        login,
        logout,
        updateSettings,
        refreshAuth,
      }}
    >
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error("useAuth must be used within an AuthProvider");
  }
  return context;
}
```

#### 3.3 recordingsApi.ts ã®æ›´æ–°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `web/src/services/recordingsApi.ts`

```typescript
// TEMP_USER_ID ã‚’å‰Šé™¤
// const TEMP_USER_ID = "temp-user-001"; // â† å‰Šé™¤

class RecordingsApiService {
  private baseUrl: string;

  constructor() {
    // BYOFçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã€ç›¸å¯¾ãƒ‘ã‚¹ã‚’ä½¿ç”¨
    this.baseUrl = '/api';
  }

  private async request<T>(
    endpoint: string,
    options: RequestInit = {}
  ): Promise<ApiResponse<T>> {
    const url = `${this.baseUrl}${endpoint}`;

    try {
      const response = await fetch(url, {
        ...options,
        headers: {
          "Content-Type": "application/json",
          ...options.headers,
        },
        credentials: 'include',  // é‡è¦: èªè¨¼Cookieé€ä¿¡
      });

      const data = await response.json();

      if (!response.ok) {
        // 401ã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
        if (response.status === 401) {
          window.location.href = '/.auth/login/github?post_login_redirect_uri=' + 
            encodeURIComponent(window.location.pathname);
          return { success: false, error: 'Authentication required' };
        }
        
        return {
          success: false,
          error: data.error || `HTTP ${response.status}`,
        };
      }

      return data;
    } catch (error) {
      console.error('API request failed:', error);
      return {
        success: false,
        error: error instanceof Error ? error.message : 'Network error',
      };
    }
  }

  // userId ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰å–å¾—ï¼‰
  async listRecordings(page = 1, limit = 20, search?: string) {
    const params = new URLSearchParams({
      page: page.toString(),
      limit: limit.toString(),
    });

    if (search) {
      params.append("search", search);
    }

    return this.request<PaginatedResponse<Recording>>(
      `/recordings/list?${params.toString()}`
    );
  }

  async createRecording(recording: Omit<Recording, 'id' | 'userId' | 'createdAt' | 'updatedAt'>) {
    return this.request<Recording>('/recordings', {
      method: 'POST',
      body: JSON.stringify(recording),
    });
  }

  async getRecording(id: string) {
    return this.request<Recording>(`/recordings/${id}`);
  }

  async updateRecording(id: string, data: Partial<Recording>) {
    return this.request<Recording>(`/recordings/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  }

  async deleteRecording(id: string) {
    return this.request<void>(`/recordings/${id}`, {
      method: 'DELETE',
    });
  }
}

export const recordingsApi = new RecordingsApiService();
```

**é‡è¦ãªå¤‰æ›´ç‚¹**:
- `baseUrl` ã‚’ `/api` ã«å¤‰æ›´ï¼ˆBYOFçµŒç”±ï¼‰
- `userId` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤
- `credentials: 'include'` ã‚’è¿½åŠ 
- 401ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚ã®è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

#### 3.4 blobApi.ts, summaryApi.ts

åŒæ§˜ã«:
- `baseUrl` ã‚’ `/api` ã«å¤‰æ›´
- `credentials: 'include'` ã‚’è¿½åŠ 
- userId é–¢é€£ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤

---

### Phase 4: UIæ›´æ–°ï¼ˆ30åˆ†ï¼‰

#### 4.1 Header.tsx

```tsx
"use client";

import { useAuth } from "@/contexts/AuthContext";
import { useLocale } from "@/contexts/LocaleContext";
import { Button } from "@/components/ui/button";
import { Spinner } from "@/components/ui/spinner";
import Link from "next/link";

export function Header() {
  const { user, isLoading, login, logout } = useAuth();
  const { t } = useLocale();

  return (
    <header className="...">
      {/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
      
      <div className="flex items-center gap-4">
        <LanguageSwitcher />
        
        {isLoading ? (
          <Spinner size="sm" />
        ) : user ? (
          <div className="flex items-center gap-3">
            <span className="text-sm text-gray-600">
              {user.name}
            </span>
            <Button 
              variant="ghost" 
              size="sm"
              onClick={logout}
            >
              {t('common.logout')}
            </Button>
          </div>
        ) : (
          <Button 
            variant="outline" 
            size="sm"
            onClick={() => login()}
          >
            {t('common.login')}
          </Button>
        )}
      </div>
    </header>
  );
}
```

#### 4.2 èªè¨¼ã‚¬ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `web/src/components/auth/AuthGuard.tsx`

```tsx
"use client";

import { useEffect } from "react";
import { useAuth } from "@/contexts/AuthContext";
import { Spinner } from "@/components/ui/spinner";

interface AuthGuardProps {
  children: React.ReactNode;
  fallback?: React.ReactNode;
}

export function AuthGuard({ children, fallback }: AuthGuardProps) {
  const { user, isLoading, login } = useAuth();

  useEffect(() => {
    if (!isLoading && !user) {
      login(window.location.pathname);
    }
  }, [user, isLoading, login]);

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-[50vh]">
        <Spinner size="lg" />
      </div>
    );
  }

  if (!user) {
    return fallback || null;
  }

  return <>{children}</>;
}
```

#### 4.3 ä¿è­·ãƒšãƒ¼ã‚¸ã§ã®ä½¿ç”¨ä¾‹

**ãƒ•ã‚¡ã‚¤ãƒ«**: `web/src/app/history/page.tsx`

```tsx
"use client";

import { AuthGuard } from "@/components/auth/AuthGuard";
// ... ä»–ã®import

export default function HistoryPage() {
  return (
    <AuthGuard>
      <HistoryContent />
    </AuthGuard>
  );
}

function HistoryContent() {
  // èªè¨¼æ¸ˆã¿ã®å ´åˆã®ã¿ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹
  // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
}
```

---

### Phase 4.5: ç¿»è¨³ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°ï¼ˆ15åˆ†ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `web/src/messages/ja.json`

```json
{
  "common": {
    "login": "ãƒ­ã‚°ã‚¤ãƒ³",
    "logout": "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ",
    "loading": "èª­ã¿è¾¼ã¿ä¸­..."
  },
  "auth": {
    "loginRequired": "ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™",
    "sessionExpired": "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸ",
    "loginWithGitHub": "GitHubã§ãƒ­ã‚°ã‚¤ãƒ³",
    "welcome": "ã‚ˆã†ã“ãã€{name}ã•ã‚“"
  }
}
```

**ãƒ•ã‚¡ã‚¤ãƒ«**: `web/src/messages/en.json`

```json
{
  "common": {
    "login": "Login",
    "logout": "Logout",
    "loading": "Loading..."
  },
  "auth": {
    "loginRequired": "Please login to use this feature",
    "sessionExpired": "Your session has expired",
    "loginWithGitHub": "Login with GitHub",
    "welcome": "Welcome, {name}"
  }
}
```

**ãƒ•ã‚¡ã‚¤ãƒ«**: `web/src/messages/es.json`

```json
{
  "common": {
    "login": "Iniciar sesiÃ³n",
    "logout": "Cerrar sesiÃ³n",
    "loading": "Cargando..."
  },
  "auth": {
    "loginRequired": "Inicie sesiÃ³n para usar esta funciÃ³n",
    "sessionExpired": "Su sesiÃ³n ha expirado",
    "loginWithGitHub": "Iniciar sesiÃ³n con GitHub",
    "welcome": "Bienvenido, {name}"
  }
}
```

---

### Phase 5: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»æ¤œè¨¼ï¼ˆ30åˆ†ï¼‰

#### 5.1 ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

```powershell
# 1. API ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
cd airecorder/api
npm run build
func azure functionapp publish func-airecorder-dev

# 2. Web ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
cd ../web
npm run build
swa deploy ./out --env production --app-name swa-airecorder-dev
```

#### 5.2 æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

| # | ãƒ†ã‚¹ãƒˆé …ç›® | æœŸå¾…çµæœ | âœ… |
|---|-----------|---------|---|
| 1 | æœªèªè¨¼ã§ / ã«ã‚¢ã‚¯ã‚»ã‚¹ | æ­£å¸¸è¡¨ç¤º | |
| 2 | æœªèªè¨¼ã§ /recording ã«ã‚¢ã‚¯ã‚»ã‚¹ | GitHub ãƒ­ã‚°ã‚¤ãƒ³ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ | |
| 3 | æœªèªè¨¼ã§ /history ã«ã‚¢ã‚¯ã‚»ã‚¹ | GitHub ãƒ­ã‚°ã‚¤ãƒ³ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ | |
| 4 | GitHub ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ | æˆåŠŸã€å…ƒã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹ | |
| 5 | ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€Header ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º | æ­£å¸¸è¡¨ç¤º | |
| 6 | éŒ²éŸ³ã‚’ä¿å­˜ | æ­£å¸¸ä¿å­˜ã€å±¥æ­´ã«è¡¨ç¤º | |
| 7 | å±¥æ­´ä¸€è¦§è¡¨ç¤º | è‡ªåˆ†ã®éŒ²éŸ³ã®ã¿è¡¨ç¤º | |
| 8 | éŒ²éŸ³ã‚’å‰Šé™¤ | æ­£å¸¸å‰Šé™¤ | |
| 9 | ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ | æˆåŠŸã€/ ã«æˆ»ã‚‹ | |
| 10 | ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã€/history ã«ã‚¢ã‚¯ã‚»ã‚¹ | ãƒ­ã‚°ã‚¤ãƒ³ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ | |

#### 5.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ

| # | ãƒ†ã‚¹ãƒˆé …ç›® | æœŸå¾…çµæœ | âœ… |
|---|-----------|---------|---|
| 1 | DevTools ã§ APIç›´æ¥å‘¼ã³å‡ºã—ï¼ˆæœªèªè¨¼ï¼‰ | 401ã‚¨ãƒ©ãƒ¼ | |
| 2 | ä»–äººã®recording IDã§GET | 404ã‚¨ãƒ©ãƒ¼ | |
| 3 | ä»–äººã®recording IDã§DELETE | 404ã‚¨ãƒ©ãƒ¼ | |
| 4 | Blob APIç›´æ¥å‘¼ã³å‡ºã—ï¼ˆæœªèªè¨¼ï¼‰ | 401ã‚¨ãƒ©ãƒ¼ | |
| 5 | Summary APIç›´æ¥å‘¼ã³å‡ºã—ï¼ˆæœªèªè¨¼ï¼‰ | 401ã‚¨ãƒ©ãƒ¼ | |

---

### Phase 6: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ï¼ˆ30åˆ†ï¼‰

#### 6.1 README.md æ›´æ–°

```markdown
## ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º

### å‰ææ¡ä»¶
- Node.js 20
- Azure Functions Core Tools
- SWA CLI

### èµ·å‹•æ–¹æ³•

# APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
cd api
npm install
npm run start

# Webã‚¢ãƒ—ãƒªèµ·å‹•ï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰
cd web
npm install
npm run dev

# SWA CLI ã§ãƒ—ãƒ­ã‚­ã‚·èµ·å‹•ï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰
swa start http://localhost:3000 --api-location http://localhost:7071
```

#### 6.2 ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼æ›´æ–°

èªè¨¼æƒ…å ±ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦è¿½è¨˜:
- å–å¾—ã™ã‚‹æƒ…å ±: GitHub/Microsoft ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å
- åˆ©ç”¨ç›®çš„: ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥ã€ãƒ‡ãƒ¼ã‚¿åˆ†é›¢
- ä¿å­˜æœŸé–“: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã¾ã§

---

## 4. ãƒªã‚¹ã‚¯ç®¡ç†

### 4.1 ãƒªã‚¹ã‚¯ãƒãƒˆãƒªã‚¯ã‚¹

| ãƒªã‚¹ã‚¯ | ç™ºç”Ÿç¢ºç‡ | å½±éŸ¿åº¦ | å¯¾ç­– | æ‹…å½“ |
|--------|---------|--------|------|------|
| BYOFè¨­å®šå¤±æ•— | ä½ | é«˜ | äº‹å‰æ¤œè¨¼å¿…é ˆ | é–‹ç™º |
| ãƒ˜ãƒƒãƒ€ãƒ¼è»¢é€å¤±æ•— | ä½ | é«˜ | ä»£æ›¿æ–¹å¼æ¤œè¨ | é–‹ç™º |
| æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ | ä¸­ | ä¸­ | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”» | PO |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | ä½ | ä½ | UXå¯¾å¿œ | é–‹ç™º |
| GitHubã‚µãƒ¼ãƒ“ã‚¹éšœå®³ | ä½ | ä¸­ | MSèªè¨¼ã‚’è¿½åŠ  | å°†æ¥ |

### 4.2 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

```powershell
# å•é¡Œç™ºç”Ÿæ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

# 1. Gitã§æˆ»ã™
git log --oneline -10  # ã‚³ãƒŸãƒƒãƒˆç¢ºèª
git checkout <commit-hash>

# 2. å†ãƒ‡ãƒ—ãƒ­ã‚¤
cd airecorder/api
npm run build
func azure functionapp publish func-airecorder-dev

cd ../web
npm run build
swa deploy ./out --env production --app-name swa-airecorder-dev

# 3. BYOFè¨­å®šè§£é™¤ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
az staticwebapp backends unlink --name swa-airecorder-dev --resource-group rg-airecorder-dev
```

---

## 5. å·¥æ•°ã‚µãƒãƒªãƒ¼

| ãƒ•ã‚§ãƒ¼ã‚º | ä½œæ¥­å†…å®¹ | å·¥æ•° | ç´¯è¨ˆ |
|---------|---------|------|------|
| Phase 0 | æ¤œè¨¼ï¼ˆBYOFã€ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ | 1h | 1h |
| Phase 1 | SWAè¨­å®š | 30m | 1.5h |
| Phase 2 | APIèªè¨¼å®Ÿè£… | 1.5h | 3h |
| Phase 3 | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | 1h | 4h |
| Phase 4 | UIæ›´æ–° | 30m | 4.5h |
| Phase 4.5 | ç¿»è¨³ãƒ•ã‚¡ã‚¤ãƒ« | 15m | 4.75h |
| Phase 5 | ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»æ¤œè¨¼ | 30m | 5.25h |
| Phase 6 | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | 30m | 5.75h |
| ãƒãƒƒãƒ•ã‚¡ | æƒ³å®šå¤–å¯¾å¿œ | 1h | 6.75h |
| **åˆè¨ˆ** | | **ç´„7æ™‚é–“** | |

---

## 6. æ‰¿èª

| é …ç›® | æ‰¿èªè€… | æ—¥ä»˜ | ç½²å |
|------|--------|------|------|
| æŠ€è¡“è¨­è¨ˆ | | | |
| å·¥æ•°è¦‹ç© | | | |
| ãƒªã‚¹ã‚¯å¯¾ç­– | | | |
| å®Ÿè£…é–‹å§‹ | | | |

---

## 7. å¤‰æ›´å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ | è‘—è€… |
|-----------|------|---------|------|
| v1.0 | 2026-02-06 | åˆç‰ˆä½œæˆ | - |
| v2.0 | 2026-02-06 | æ§‹é€ æ•´ç†ã€æ¼ã‚Œé …ç›®è¿½åŠ  | PM |
