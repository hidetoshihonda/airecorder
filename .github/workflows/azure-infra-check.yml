name: Azure Infrastructure Health Check

# å®šæœŸçš„ã«Azureã‚¤ãƒ³ãƒ•ãƒ©è¨­å®šã‚’æ¤œè¨¼ã—ã€CI/CDãŒå£Šã‚Œã‚‹å‰ã«ç•°å¸¸ã‚’æ¤œçŸ¥ã™ã‚‹
# èƒŒæ™¯: SCM Basic Authç„¡åŠ¹åŒ– / EasyAuthèª¤æœ‰åŠ¹åŒ– ã§ãƒ‡ãƒ—ãƒ­ã‚¤ãŒ401å¤±æ•—ã—ãŸéšœå®³ã®å†ç™ºé˜²æ­¢

on:
  schedule:
    # æ¯æ—¥ JST 9:00 (UTC 0:00) ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: 'func-airecorder-dev'
  RESOURCE_GROUP: 'rg-airecorder-dev'

jobs:
  check-azure-config:
    runs-on: ubuntu-latest
    name: Verify Azure Configuration

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true

      # ========================================
      # Check 1: Functions App Health Check
      # ========================================
      - name: Check Functions App health endpoint
        id: health
        run: |
          HEALTH_URL="https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health"
          HTTP_STATUS=$(curl -s -o /tmp/health.json -w "%{http_code}" "$HEALTH_URL")
          RESPONSE=$(cat /tmp/health.json)
          
          echo "health_status=$HTTP_STATUS" >> $GITHUB_OUTPUT
          echo "health_response=$RESPONSE" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Health endpoint: HTTP $HTTP_STATUS"
            echo "$RESPONSE" | jq . 2>/dev/null || echo "$RESPONSE"
          else
            echo "âŒ Health endpoint: HTTP $HTTP_STATUS"
            echo "Response: $RESPONSE"
          fi

      # ========================================
      # Check 2: SCM Basic Auth (Publish Profileèªè¨¼ã«å¿…é ˆ)
      # ========================================
      - name: Check SCM Basic Auth policy
        id: scm_auth
        if: steps.health.outcome == 'success' || steps.health.outcome == 'failure'
        run: |
          # Publish Profile ã‚’ä½¿ã£ã¦SCMã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ç¢ºèª
          PUBLISH_PROFILE='${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}'
          
          if [ -z "$PUBLISH_PROFILE" ]; then
            echo "âš ï¸ AZURE_FUNCTIONAPP_PUBLISH_PROFILE secret is not set"
            echo "scm_auth=missing" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Publish Profileã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
          SCM_USER=$(echo "$PUBLISH_PROFILE" | grep -o 'userName="[^"]*"' | head -1 | sed 's/userName="//;s/"//')
          SCM_PASS=$(echo "$PUBLISH_PROFILE" | grep -o 'userPWD="[^"]*"' | head -1 | sed 's/userPWD="//;s/"//')
          
          if [ -z "$SCM_USER" ] || [ -z "$SCM_PASS" ]; then
            echo "âš ï¸ Could not parse credentials from Publish Profile"
            echo "scm_auth=parse_error" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          SCM_URL="https://${{ env.AZURE_FUNCTIONAPP_NAME }}.scm.azurewebsites.net/api/settings"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -u "${SCM_USER}:${SCM_PASS}" "$SCM_URL")
          
          echo "scm_auth_status=$HTTP_STATUS" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… SCM Basic Auth: enabled (HTTP $HTTP_STATUS)"
            echo "scm_auth=ok" >> $GITHUB_OUTPUT
          elif [ "$HTTP_STATUS" = "401" ]; then
            echo "âŒ SCM Basic Auth: DISABLED (HTTP 401)"
            echo "   â†’ Publish Profileèªè¨¼ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã™"
            echo "   â†’ Azure Portal â†’ Functions App â†’ è¨­å®š â†’ æ§‹æˆ â†’ åŸºæœ¬èªè¨¼ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„"
            echo "   â†’ ã¾ãŸã¯: az rest --method PUT --url '.../basicPublishingCredentialsPolicies/scm' --body '{\"properties\":{\"allow\":true}}'"
            echo "scm_auth=disabled" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ SCM endpoint: unexpected HTTP $HTTP_STATUS"
            echo "scm_auth=unknown" >> $GITHUB_OUTPUT
          fi

      # ========================================
      # Check 3: EasyAuth (èª¤æœ‰åŠ¹åŒ–ã®æ¤œçŸ¥)
      # ========================================
      - name: Check EasyAuth is disabled
        id: easyauth
        run: |
          # Functions Appã®APIã«anonymousã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª
          # EasyAuthãŒæœ‰åŠ¹ã ã¨302ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã¾ãŸã¯401ãŒè¿”ã‚‹
          API_URL="https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -L "$API_URL")
          
          # curlã®-Lã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã¾ã§è¿½è·¡ã—ãŸçµæœã‚’ãƒã‚§ãƒƒã‚¯
          REDIRECT_CHECK=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL")
          
          if [ "$REDIRECT_CHECK" = "200" ]; then
            echo "âœ… EasyAuth: disabled (anonymous access works)"
            echo "easyauth=ok" >> $GITHUB_OUTPUT
          elif [ "$REDIRECT_CHECK" = "302" ] || [ "$REDIRECT_CHECK" = "401" ]; then
            echo "âŒ EasyAuth: ENABLED (HTTP $REDIRECT_CHECK)"
            echo "   â†’ å…¨APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒèªè¨¼ã‚’è¦æ±‚ã•ã‚Œã¦ã„ã¾ã™"
            echo "   â†’ Azure Portal â†’ Functions App â†’ èªè¨¼ â†’ èªè¨¼ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãã ã•ã„"
            echo "easyauth=enabled" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Unexpected HTTP status: $REDIRECT_CHECK"
            echo "easyauth=unknown" >> $GITHUB_OUTPUT
          fi

      # ========================================
      # Summary & Alert
      # ========================================
      - name: Generate summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo " Azure Infrastructure Health Check Summary"
          echo "=========================================="
          echo ""
          
          FAILED=0
          
          # Health check
          HEALTH="${{ steps.health.outputs.health_status }}"
          if [ "$HEALTH" = "200" ]; then
            echo "âœ… Functions App Health: OK"
          else
            echo "âŒ Functions App Health: FAILED (HTTP $HEALTH)"
            FAILED=$((FAILED + 1))
          fi
          
          # SCM Auth
          SCM="${{ steps.scm_auth.outputs.scm_auth }}"
          if [ "$SCM" = "ok" ]; then
            echo "âœ… SCM Basic Auth: Enabled"
          elif [ "$SCM" = "disabled" ]; then
            echo "âŒ SCM Basic Auth: DISABLED â€” CI/CDãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã™ï¼"
            FAILED=$((FAILED + 1))
          else
            echo "âš ï¸ SCM Basic Auth: $SCM"
          fi
          
          # EasyAuth
          EASYAUTH="${{ steps.easyauth.outputs.easyauth }}"
          if [ "$EASYAUTH" = "ok" ]; then
            echo "âœ… EasyAuth: Disabled (correct)"
          elif [ "$EASYAUTH" = "enabled" ]; then
            echo "âŒ EasyAuth: ENABLED â€” APIãŒå…¨ã¦401ã«ãªã‚Šã¾ã™ï¼"
            FAILED=$((FAILED + 1))
          else
            echo "âš ï¸ EasyAuth: $EASYAUTH"
          fi
          
          echo ""
          if [ $FAILED -gt 0 ]; then
            echo "ğŸš¨ $FAILED ä»¶ã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼"
            exit 1
          else
            echo "âœ… ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸ"
          fi
